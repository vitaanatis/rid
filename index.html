<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hubble | Alpha</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap');
        :root {
            --primary: #009CFC;
            --secondary: #A0AAFF;
            --accent: #C97FFD;
            --background-light: #f7f8fa;
            --star: #A0AAFF;
            --planet: #C97FFD;
            --text-light: #222;
            --auth-bg-light: #fff;
            --background-dark: #181e2a;
            --text-dark: #f7f8fa;
            --auth-bg-dark: #232a3a;
        }
        body {
            font-family: 'Poppins', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            overflow-x: hidden;
            position: relative;
            transition: background-color 0.6s cubic-bezier(0.4, 0, 0.2, 1), color 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body[data-theme="light"] {
            background: var(--background-light);
            color: var(--text-light);
        }
        body[data-theme="dark"] {
            background: var(--background-dark);
            color: var(--text-dark);
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 0;
            pointer-events: none;
            background: 
                radial-gradient(circle at 80% 20%, rgba(201,127,253,0.13) 0 8vw, transparent 12vw),
                radial-gradient(circle at 15% 80%, rgba(0,156,252,0.10) 0 5vw, transparent 8vw),
                repeating-radial-gradient(circle at 30% 30%, #a2dbff 0 1px, transparent 2px 100px),
                repeating-radial-gradient(circle at 50% 50%, #A0AAFF 0 1px, transparent 2px 100px),
                repeating-radial-gradient(circle at 30% 30%, #fff 0 1px, transparent 2px 100px),
                repeating-radial-gradient(circle at 50% 50%, rgba(160,170,255,0.08) 0 60px, transparent 62px 100vw);
            opacity: 0.22;
        }
        .topbar {
            width: 100vw;
            height: 56px;
            background: #fff;
            display: flex;
            align-items: center;
            z-index: 10;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            position: relative;
            transition: background-color 0.6s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body[data-theme="dark"] .topbar {
            background: #20263a;
            box-shadow: 0 2px 12px rgba(0,0,0,0.13);
        }
        .hubble-gradient {
            font-family: 'Poppins', 'Helvetica Neue', Arial, sans-serif;
            font-weight: 700;
            font-size: clamp(1.5rem, 5vw, 2.2rem);
            background: linear-gradient(90deg, #009CFC 0%, #A0AAFF 50%, #C97FFD 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            margin-left: 2.2rem;
            letter-spacing: 2px;
            -webkit-user-select: none;
            user-select: none;
        }
        .center-wrap {
            flex: 1 1 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }
        .auth-container {
            background: var(--auth-bg-light);
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 2.5rem 2rem;
            width: 100%;
            max-width: 370px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            color: var(--text-light);
        }
        body[data-theme="dark"] .auth-container {
            background: var(--auth-bg-dark);
            color: var(--text-dark);
        }
        h1 {
            display: none;
        }
        .input-group {
            margin-bottom: 1.2rem;
        }
        label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: 500;
            color: inherit;
        }
        input[type="text"], input[type="email"], input[type="password"], input[type="number"] {
            width: 100%;
            min-width: 0;
            max-width: 100%;
            box-sizing: border-box;
            padding: 0.7rem;
            border: 1px solid var(--secondary);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--auth-bg-light);
            color: var(--text-light);
        }
        body[data-theme="dark"] input[type="text"],
        body[data-theme="dark"] input[type="email"],
        body[data-theme="dark"] input[type="password"],
        body[data-theme="dark"] input[type="number"] {
            background: var(--auth-bg-dark);
            color: var(--text-dark);
        }
        .invalid {
            border: 2px solid #d32f2f !important;
            background: #fff0f0;
            color: #222;
        }
        body[data-theme="dark"] .invalid {
            border: 2px solid #f44336 !important;
            background: #2d1b1b;
            color: #f7f8fa;
        }
        .btn {
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: background 0.2s;
        }
        .btn:active {
            background: var(--primary);
        }
        .switch-link {
            display: block;
            text-align: center;
            margin-top: 1.2rem;
            color: var(--accent);
            cursor: pointer;
            text-decoration: underline;
        }
        .error {
            color: #d32f2f;
            font-size: 0.95rem;
            margin-bottom: 0.7rem;
            text-align: center;
        }
        .timer {
            color: var(--primary);
            font-weight: 600;
            margin-top: 0.5rem;
            text-align: center;
        }
        
        .link-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.9rem;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background 0.18s;
        }
        
        .link-btn:hover {
            background: rgba(0, 156, 252, 0.1);
        }
        
        /* Verification Screen Styles */
        .verification-container {
            text-align: center;
            padding: 1rem 0;
        }
        

        
        .verification-container h1 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }
        
        .verification-message {
            color: var(--text-light);
            font-size: 1.1rem;
            line-height: 1.5;
            margin-bottom: 2rem;
        }
        
        .email-highlight {
            color: var(--primary);
            font-weight: 600;
            background: rgba(0, 156, 252, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }
        
        .verification-status {
            margin-bottom: 2rem;
        }
        
        .verification-steps {
            background: rgba(0, 156, 252, 0.05);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--primary);
        }
        
        .step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            text-align: left;
        }
        
        .step:last-child {
            margin-bottom: 0;
        }
        
        .step-number {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .step-text {
            color: var(--text-light);
            font-size: 1rem;
        }
        
        .verification-btn {
            background: var(--primary) !important;
            margin-bottom: 2rem;
            font-size: 1.1rem;
            padding: 0.9rem 2rem;
        }
        
        .verification-actions {
            border-top: 1px solid rgba(0, 156, 252, 0.2);
            padding-top: 1.5rem;
        }
        
        

        
        /* Dark theme adjustments for verification */
        body[data-theme="dark"] .verification-message {
            color: var(--text-dark);
        }
        
        body[data-theme="dark"] .step-text {
            color: var(--text-dark);
        }
        
        
        body[data-theme="dark"] .verification-steps {
            background: rgba(0, 156, 252, 0.1);
        }
        
        /* Verification Timeout Styles */
        .verification-timeout-container {
            text-align: center;
            padding: 2rem 0;
        }
        
        .verification-timeout-container h1 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }
        
        .verification-timeout-message {
            color: var(--text-light);
            font-size: 1.1rem;
            line-height: 1.5;
            margin-bottom: 2rem;
        }
        
        body[data-theme="dark"] .verification-timeout-message {
            color: var(--text-dark);
        }
        
        .verification-timeout-info {
            background: rgba(255, 193, 7, 0.1);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid #ffc107;
        }
        
        .verification-timeout-btn {
            background: var(--primary) !important;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            padding: 0.9rem 2rem;
        }
        
        /* Custom Popup Styles */
        .custom-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(3px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .custom-popup {
            background: var(--auth-bg-light);
            color: var(--text-light);
            padding: 2rem;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 2px solid var(--secondary);
            animation: popupSlideIn 0.3s ease-out;
        }
        
        body[data-theme="dark"] .custom-popup {
            background: var(--auth-bg-dark);
            color: var(--text-dark);
            border-color: #2c3550;
        }
        
        @keyframes popupSlideIn {
            from {
                transform: scale(0.8) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        
        .popup-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .popup-message {
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 1.5rem;
            color: inherit;
        }
        
        .popup-input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--secondary);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--auth-bg-light);
            color: var(--text-light);
            margin-bottom: 1.5rem;
            box-sizing: border-box;
        }
        
        body[data-theme="dark"] .popup-input {
            background: var(--auth-bg-dark);
            color: var(--text-dark);
            border-color: #2c3550;
        }
        
        .popup-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        .popup-btn {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .popup-btn.primary {
            background: var(--primary);
            color: white;
        }
        
        .popup-btn.primary:hover {
            background: #0088e5;
            transform: translateY(-1px);
        }
        
        .popup-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .popup-btn.secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .popup-content .form-group {
            margin: 1rem 0;
        }
        
        .popup-content .form-group input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .popup-content .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 156, 252, 0.2);
        }
        
        .popup-content .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .popup-content .btn {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .popup-content .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .popup-content .btn-secondary:hover {
            background: #5a6268;
        }
        
        .popup-content .btn:not(.btn-secondary) {
            background: var(--primary);
            color: white;
        }
        
        .popup-content .btn:not(.btn-secondary):hover {
            background: #0088e5;
        }
        .info {
            color: #0077b6;
            font-size: 0.95rem;
            margin-bottom: 0.7rem;
            text-align: center;
        }
        /* Theme toggle button */
        .theme-toggle {
            position: fixed;
            right: 2.2rem;
            bottom: 2.2rem;
            z-index: 100;
            background: #fff;
            color: #222;
            border: 2px solid var(--secondary);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.10);
            cursor: pointer;
            transition: background 0.18s, color 0.18s;
        }
        .theme-toggle:hover {
            background: var(--accent);
            color: #fff;
        }
        body[data-theme="dark"] .theme-toggle {
            background: #232a3a;
            color: #f7f8fa;
            border: 2px solid #2c3550;
        }
        
        /* Help button */
        .help-button {
            position: fixed;
            left: 2.2rem;
            bottom: 2.2rem;
            z-index: 100;
            background: #fff;
            color: #222;
            border: 2px solid var(--secondary);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.10);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(1);
        }
        .help-button:hover {
            background: var(--primary);
            color: #fff;
            transform: scale(1.1) rotate(-15deg);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .help-button:active {
            transform: scale(0.9) rotate(0deg);
            transition: all 0.1s ease-out;
        }
        body[data-theme="dark"] .help-button {
            background: #232a3a;
            color: #f7f8fa;
            border: 2px solid #2c3550;
        }
        body[data-theme="dark"] .help-button:hover {
            background: var(--primary);
            color: #fff;
            transform: scale(1.1) rotate(-15deg);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }
        
        /* Help Popup Styles */
        .help-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .help-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        body[data-theme="dark"] .help-popup-overlay {
            backdrop-filter: blur(2px);
        }
        
        .help-popup {
            background: var(--auth-bg-light);
            color: var(--text-light);
            padding: 2.5rem;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            border: 2px solid var(--secondary);
            transition: all 0.3s ease;
            transform: scale(0.8) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .help-popup-overlay.show .help-popup {
            transform: scale(1) translateY(0);
        }
        
        body[data-theme="dark"] .help-popup {
            background: var(--auth-bg-dark);
            color: var(--text-dark);
            border-color: #2c3550;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        
        .help-popup-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(90deg, #009CFC 0%, #A0AAFF 50%, #C97FFD 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .help-popup-text {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            color: var(--text-light);
        }
        
        body[data-theme="dark"] .help-popup-text {
            color: var(--text-dark);
        }
        
        .help-popup-buttons {
            display: flex;
            gap: 1.2rem;
            justify-content: center;
            align-items: center;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }
        
        .help-popup-btn {
            padding: 0.9rem 1.8rem;
            border: none;
            border-radius: 25px;
            font-size: 1.05rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 140px;
        }
        
        .help-popup-btn.create {
            background: linear-gradient(135deg, #009CFC, #0088e5);
            box-shadow: 0 4px 15px rgba(0, 156, 252, 0.3);
        }
        
        .help-popup-btn.create:hover {
            background: linear-gradient(135deg, #0088e5, #0077d1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 156, 252, 0.4);
        }
        
        .help-popup-btn.faq {
            background: linear-gradient(135deg, #A0AAFF, #8b9cff);
            box-shadow: 0 4px 15px rgba(160, 170, 255, 0.3);
        }
        
        .help-popup-btn.faq:hover {
            background: linear-gradient(135deg, #8b9cff, #7a8eff);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(160, 170, 255, 0.4);
        }
        
        .help-popup-close {
            background: #1565C0;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 1.5rem;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(21, 101, 192, 0.3);
        }
        
        .help-popup-close:hover {
            background: #0D47A1;
            transform: scale(1.08);
            box-shadow: 0 6px 20px rgba(13, 71, 161, 0.4);
        }
        
        /* Ticket Creation Popup */
        .ticket-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10002;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .ticket-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        body[data-theme="dark"] .ticket-popup-overlay {
            backdrop-filter: blur(2px);
        }
        
        .ticket-popup {
            background: var(--auth-bg-light);
            color: var(--text-light);
            padding: 2.5rem;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: 2px solid var(--secondary);
            transition: all 0.3s ease;
            transform: scale(0.8) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .ticket-popup-overlay.show .ticket-popup {
            transform: scale(1) translateY(0);
        }
        
        body[data-theme="dark"] .ticket-popup {
            background: var(--auth-bg-dark);
            color: var(--text-dark);
            border-color: #2c3550;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        
        .ticket-popup-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
            background: linear-gradient(90deg, #009CFC 0%, #A0AAFF 50%, #C97FFD 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .ticket-form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        
        .ticket-form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-light);
        }
        
        body[data-theme="dark"] .ticket-form-label {
            color: var(--text-dark);
        }
        
        .ticket-form-input,
        .ticket-form-textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--secondary);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--auth-bg-light);
            color: var(--text-light);
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        
        .ticket-form-input:focus,
        .ticket-form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        body[data-theme="dark"] .ticket-form-input,
        body[data-theme="dark"] .ticket-form-textarea {
            background: var(--auth-bg-dark);
            color: var(--text-dark);
            border-color: #2c3550;
        }
        
        .ticket-form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .ticket-form-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }
        
        .ticket-form-btn {
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ticket-form-btn.send {
            background: linear-gradient(135deg, #009CFC, #0088e5);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 156, 252, 0.3);
        }
        
        .ticket-form-btn.send:hover {
            background: linear-gradient(135deg, #0088e5, #0077d1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 156, 252, 0.4);
        }
        
        .ticket-form-btn.cancel {
            background: #6c757d;
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }
        
        .ticket-form-btn.cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }
        
        /* Popup Error Text Styles */
        .popup-error-text {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        /* Error Notification Styles */
        .error-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
            z-index: 10003;
            max-width: 350px;
            font-size: 0.95rem;
            line-height: 1.4;
            border: 2px solid rgba(255, 255, 255, 0.2);
            animation: errorNotificationSlideIn 0.4s ease-out;
            backdrop-filter: blur(10px);
        }
        
        @keyframes errorNotificationSlideIn {
            from {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }
        
        .error-notification-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .error-notification-message {
            margin-bottom: 1rem;
        }
        
        .error-notification-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background 0.2s ease;
            float: right;
        }
        
        .error-notification-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* FAQ Popup */
        .faq-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .faq-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        body[data-theme="dark"] .faq-popup-overlay {
            backdrop-filter: blur(2px);
        }
        
        .faq-popup {
            background: var(--auth-bg-light);
            color: var(--text-light);
            padding: 2.5rem;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            border: 2px solid var(--secondary);
            transition: all 0.3s ease;
            transform: scale(0.8) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .faq-popup-overlay.show .faq-popup {
            transform: scale(1) translateY(0);
        }
        
        body[data-theme="dark"] .faq-popup {
            background: var(--auth-bg-dark);
            color: var(--text-dark);
            border-color: #2c3550;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        
        .faq-popup-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
            background: linear-gradient(90deg, #009CFC 0%, #A0AAFF 50%, #C97FFD 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .faq-item {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        
        .faq-question {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        
        .faq-answer {
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-light);
            padding-left: 1rem;
        }
        
        body[data-theme="dark"] .faq-answer {
            color: var(--text-dark);
        }
        @media (max-width: 600px) {
            .auth-container {
                margin-top: 1.5rem;
                border-radius: 0;
                box-shadow: none;
                padding: 1.2rem 0.5rem;
            }
            .topbar { height: 48px; }
            .hubble-gradient { font-size: 1.3rem; margin-left: 1rem; }
            .theme-toggle { right: 1rem; bottom: 1rem; }
            .help-button { left: 1rem; bottom: 1rem; }
        }
        
        /* Error Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(220, 38, 38, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }
        
        .popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .popup-content {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            padding: 35px;
            border-radius: 20px;
            box-shadow: 
                0 25px 50px rgba(220, 38, 38, 0.4),
                0 0 0 3px #ff6b6b,
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            text-align: center;
            max-width: 450px;
            width: 90%;
            position: relative;
            transform: scale(0.7) rotate(-2deg);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            animation: shake 0.5s ease-in-out infinite alternate;
        }
        
        @keyframes shake {
            0% { transform: translateX(-2px) rotate(-1deg); }
            100% { transform: translateX(2px) rotate(1deg); }
        }
        
        .popup-overlay.show .popup-content {
            transform: scale(1) rotate(0deg);
            animation: none;
        }
        
        .popup-overlay .popup-title {
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 20px;
            color: #ffffff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            animation: glow 1.5s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5), 0 0 10px #ff6b6b; }
            to { text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5), 0 0 20px #ff6b6b, 0 0 30px #ff6b6b; }
        }
        
        .popup-overlay .popup-message {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 30px;
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            font-weight: 600;
        }
        
        .popup-button {
            background: linear-gradient(45deg, #ffffff, #f0f0f0);
            color: #cc0000;
            border: 3px solid #ffffff;
            padding: 15px 35px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            animation: button-pulse 2s infinite;
        }
        
        @keyframes button-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .popup-button:hover {
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            transform: scale(1.1);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4);
        }
        
        .popup-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 20px;
            cursor: pointer;
            color: #ffffff;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .popup-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1) rotate(90deg);
        }
        
        /* Warning icon */
        .popup-content::before {
            content: "‚ö†Ô∏è";
            font-size: 40px;
            display: block;
            margin-bottom: 15px;
            animation: bounce 1s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* Important Notice Popup Styles */
        .important-notice-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .important-notice-popup {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 3rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 107, 107, 0.3), 0 0 50px rgba(255, 107, 107, 0.2);
            border: 3px solid #ff6b6b;
            animation: important-notice-appear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .important-notice-popup::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 107, 107, 0.1) 0%, rgba(255, 107, 107, 0.05) 100%);
            pointer-events: none;
        }

        body[data-theme="dark"] .important-notice-popup {
            background: linear-gradient(135deg, #232a3a 0%, #1a1f2e 100%);
            border-color: #ff8a8a;
        }

        body[data-theme="dark"] .important-notice-popup::before {
            background: linear-gradient(45deg, rgba(255, 138, 138, 0.1) 0%, rgba(255, 138, 138, 0.05) 100%);
        }

        .important-notice-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 3px solid #ff6b6b;
            position: relative;
            z-index: 1;
        }

        .important-notice-icon {
            font-size: 3rem;
            animation: important-notice-pulse 1.5s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(255, 107, 107, 0.5));
        }

        .important-notice-title {
            margin: 0;
            color: #ff6b6b;
            font-size: 2rem;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
            letter-spacing: 0.5px;
        }

        .important-notice-content {
            margin-bottom: 2.5rem;
            position: relative;
            z-index: 1;
        }

        .important-notice-text {
            margin: 0 0 1.5rem 0;
            line-height: 1.7;
            color: var(--text-light);
            font-size: 1.1rem;
        }

        body[data-theme="dark"] .important-notice-text {
            color: var(--text-dark);
        }

        .important-notice-apology {
            margin: 2rem 0 0 0;
            font-style: italic;
            color: #666;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 500;
        }

        body[data-theme="dark"] .important-notice-apology {
            color: #999;
        }

        .important-notice-actions {
            display: flex;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .important-notice-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff8a8a);
            color: white;
            border: none;
            padding: 1rem 3rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.2);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .important-notice-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .important-notice-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.3);
        }

        .important-notice-btn:hover::before {
            left: 100%;
        }

        .important-notice-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        .important-notice-popup.closing {
            animation: important-notice-close 0.5s cubic-bezier(0.55, 0.06, 0.68, 0.19) forwards;
        }

        @keyframes important-notice-appear {
            0% {
                opacity: 0;
                transform: scale(0.7) translateY(-30px) rotateX(15deg);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05) translateY(-5px) rotateX(5deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0) rotateX(0deg);
            }
        }

        @keyframes important-notice-close {
            0% {
                opacity: 1;
                transform: scale(1) translateY(0) rotateX(0deg);
            }
            50% {
                opacity: 0.5;
                transform: scale(0.9) translateY(10px) rotateX(-5deg);
            }
            100% {
                opacity: 0;
                transform: scale(0.7) translateY(30px) rotateX(-15deg);
            }
        }

        @keyframes important-notice-pulse {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 0 10px rgba(255, 107, 107, 0.5));
            }
            50% {
                transform: scale(1.15);
                filter: drop-shadow(0 0 20px rgba(255, 107, 107, 0.8));
            }
        }

        /* Alpha Badge Styles */
        .alpha-badge {
            display: inline-block;
            margin-left: 1rem;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4, #45B7D1, #96CEB4, #FFEAA7);
            background-size: 400% 400%;
            color: white !important;
            -webkit-text-fill-color: white !important;
            padding: 0.3rem 0.8rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            animation: alpha-gradient-flow 3s ease-in-out infinite;
            vertical-align: middle;
            -webkit-background-clip: initial !important;
            background-clip: initial !important;
        }

        @keyframes alpha-gradient-flow {
            0%, 100% {
                background-position: 0% 50%;
            }
            25% {
                background-position: 100% 50%;
            }
            50% {
                background-position: 100% 100%;
            }
            75% {
                background-position: 0% 100%;
            }
        }

        .alpha-badge.hidden {
            display: none;
        }
    </style>
</head>
<body data-theme="light">

    <!-- Important Account Deletion Notice Popup -->
    <div class="important-notice-overlay" id="important-notice-overlay">
        <div class="important-notice-popup">
            <div class="important-notice-header">
                <span class="important-notice-icon">‚ö†Ô∏è</span>
                <h2 class="important-notice-title">Important Notice</h2>
            </div>
            <div class="important-notice-content">
                <p class="important-notice-text">
                    Due to bugs in our system earlier this week, some user accounts may have been deleted due to incomplete profiles on our servers when users were creating accounts.
                </p>
                <p class="important-notice-text">
                    <strong>If sign up fails, your account may have been one of them.</strong> Please recreate your account.
                </p>
                <p class="important-notice-apology">
                    We sincerely apologize for the inconvenience.
                </p>
            </div>
            <div class="important-notice-actions">
                <button class="important-notice-btn" id="important-notice-understand">I Understand</button>
            </div>
        </div>
    </div>

    <div class="topbar">
        <span class="hubble-gradient">Hubble<span class="alpha-badge" id="alpha-badge">Alpha</span></span>
    </div>
    <div class="center-wrap">
      <div class="auth-container" id="auth-container">
      </div>
    </div>
    <button class="theme-toggle" id="theme-toggle" title="Toggle light/dark mode">üåô</button>
    <button class="help-button" id="help-button" title="Get Help">‚ùì</button>
    
    <!-- Error Notification -->
    <div class="error-notification" id="error-notification" style="display: none;">
        <div class="error-notification-title">
            ‚ö†Ô∏è Having Trouble?
        </div>
        <div class="error-notification-message">
            Go to the 'Help Desk' button on the bottom left of your screen for support.
        </div>
        <button class="error-notification-close" onclick="closeErrorNotification()">Got it</button>
    </div>
    
    <div class="custom-popup-overlay" id="custom-popup">
        <div class="custom-popup">
            <div class="popup-title" id="popup-title"></div>
            <div class="popup-message" id="popup-message"></div>
            <input type="text" class="popup-input" id="popup-input" style="display: none;">
            <div class="popup-buttons" id="popup-buttons"></div>
        </div>
    </div>
    
    <div class="help-popup-overlay" id="help-popup-overlay">
        <div class="help-popup">
            <h2 class="help-popup-title">Need Help?</h2>
            <p class="help-popup-text">Click Create below to create a ticket for an issue you may have. Make sure you check the FAQ to see if your question is answered or if your issue has a solution.</p>
            <div class="help-popup-buttons">
                <button class="help-popup-btn create" onclick="showTicketPopup()">Create</button>
                <button class="help-popup-btn faq" onclick="showFAQPopup()">FAQ</button>
            </div>
            <button class="help-popup-close" onclick="closeHelpPopup()">Close</button>
        </div>
    </div>
    
    <div class="ticket-popup-overlay" id="ticket-popup-overlay">
        <div class="ticket-popup">
            <h2 class="ticket-popup-title" id="ticket-popup-title">Create Support Ticket</h2>
            <div id="ticket-error-text" class="popup-error-text" style="display: none;"></div>
            <div id="ticket-form-content">
                <div class="ticket-form-group">
                    <label for="ticket-subject" class="ticket-form-label">Subject</label>
                    <input type="text" id="ticket-subject" class="ticket-form-input" placeholder="Brief description of your issue">
                </div>
                <div class="ticket-form-group">
                    <label for="ticket-description" class="ticket-form-label">Describe the Issue</label>
                    <textarea id="ticket-description" class="ticket-form-textarea" placeholder="Please provide detailed information about your issue..."></textarea>
                </div>
                <div class="ticket-form-group">
                    <label for="ticket-email" class="ticket-form-label">Account Email</label>
                    <input type="email" id="ticket-email" class="ticket-form-input" placeholder="your.school@email.com">
                </div>
                <div class="ticket-form-buttons">
                    <button class="ticket-form-btn cancel" onclick="closeTicketPopup()">Cancel</button>
                    <button class="ticket-form-btn send" onclick="sendTicket()">Send</button>
                </div>
            </div>
            <div id="ticket-sent-content" style="display: none; text-align: center;">
                <h3 style="color: var(--primary); margin-bottom: 1rem;">‚úÖ Ticket Sent!</h3>
                <p style="margin-bottom: 2rem;">Our support team will get to you shortly.</p>
                <button class="ticket-form-btn send" onclick="closeAllPopups()">Close</button>
            </div>
        </div>
    </div>
    
    <div class="faq-popup-overlay" id="faq-popup-overlay">
        <div class="faq-popup">
            <h2 class="faq-popup-title">Frequently Asked Questions</h2>
            <div class="faq-item">
                <div class="faq-question">How do I sign up for Hubble?</div>
                <div class="faq-answer">You can sign up using your school email address. Click "Sign Up" on the login page and follow the verification process.</div>
            </div>
            <div class="faq-item">
                <div class="faq-question">I forgot my password. What should I do?</div>
                <div class="faq-answer">Click "Forgot password?" on the login page and enter your school email address. You'll receive a password reset link in your email.</div>
            </div>
            <div class="faq-item">
                <div class="faq-question">Why can't I access certain games?</div>
                <div class="faq-answer">Some games may be temporarily unavailable due to maintenance or technical issues. Try refreshing the page or check back later.</div>
            </div>
            <div class="faq-item">
                <div class="faq-question">How do I change my theme (light/dark mode)?</div>
                <div class="faq-answer">Click the theme toggle button in the bottom right corner of the screen to switch between light and dark modes.</div>
            </div>
            <div class="faq-item">
                <div class="faq-question">Can I play games in fullscreen?</div>
                <div class="faq-answer">Yes! When you open a game, you'll see a "Fullscreen" button in the top bar. You can also press the Escape key to exit fullscreen mode.</div>
            </div>
            <div class="faq-item">
                <div class="faq-question">My email verification isn't working. What should I do?</div>
                <div class="faq-answer">Check your spam folder first. If the verification link has expired, try clicking "Resend Email" on the verification page. Make sure you're using your school email address.</div>
            </div>
            <div class="faq-item">
                <div class="faq-question">Why does it say my username is being used by a pending account?</div>
                <div class="faq-answer">
                    This happens when someone started creating an account with that username but didn't complete the verification process. 
                    The system automatically cleans up abandoned registrations after 2 hours.
                    <br><br>
                    <strong>Solutions:</strong>
                    <br>‚Ä¢ Wait a few minutes and try again (the system now cleans up expired sessions automatically)
                    <br>‚Ä¢ Try a different username
                    <br>‚Ä¢ Clear your browser's site data and refresh the page
                    <br>‚Ä¢ If you're the same person who started the registration, you can continue with the same username
                    <br><br>
                    The system has been improved to automatically handle abandoned registrations and provide better error messages.
                </div>
            </div>
            <div class="faq-item">
                <div class="faq-question">How do I search for games?</div>
                <div class="faq-answer">Use the search bar at the top of the games page. You can search by game name, and the results will be sorted by relevance.</div>
            </div>
            <div class="faq-item">
                <div class="faq-question">Is Hubble free to use?</div>
                <div class="faq-answer">Yes! Hubble is completely free for students. All games and features are available at no cost.</div>
            </div>
            <div style="text-align: center; margin-top: 2rem;">
                <button class="help-popup-close" onclick="closeFAQPopup()">Close</button>
            </div>
        </div>
    </div>
    
    <script>
        // Error tracking system
        const ERROR_COUNT_COOKIE = 'hubble_error_count';
        const ERROR_THRESHOLD = 5;
        
        // Cookie management functions
        function setCookie(name, value, days = 30) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        }
        
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }
        
        function deleteCookie(name) {
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
        }
        
        function getErrorCount() {
            return parseInt(getCookie(ERROR_COUNT_COOKIE) || '0');
        }
        
        // Error tracking function
        function trackError(errorMessage = '') {
            const currentCount = getErrorCount();
            const newCount = currentCount + 1;
            
            console.log(`Error count: ${newCount}/${ERROR_THRESHOLD}${errorMessage ? ' - ' + errorMessage : ''}`);
            
            if (newCount >= ERROR_THRESHOLD) {
                // Reset the error count
                deleteCookie(ERROR_COUNT_COOKIE);
                // Show support notification
                showErrorNotification();
            } else {
                // Increment error count
                setCookie(ERROR_COUNT_COOKIE, newCount.toString());
            }
        }
        
        // Show error notification
        function showErrorNotification() {
            const notification = document.getElementById('error-notification');
            if (notification) {
                notification.style.display = 'block';
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    closeErrorNotification();
                }, 10000);
            }
        }
        
        // Close error notification
        function closeErrorNotification() {
            const notification = document.getElementById('error-notification');
            if (notification) {
                notification.style.display = 'none';
                
                // Reset error count after user acknowledges the notification
                deleteCookie(ERROR_COUNT_COOKIE);
            }
        }
        function showHelpPopup() {
            const popup = document.getElementById('help-popup-overlay');
            if (popup) {
                popup.style.display = 'flex';
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
            }
        }
        
        function closeHelpPopup() {
            const popup = document.getElementById('help-popup-overlay');
            if (popup) {
                popup.classList.remove('show');
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 300);
            }
        }
        
        function showTicketPopup() {
            closeHelpPopup();
            const popup = document.getElementById('ticket-popup-overlay');
            const formContent = document.getElementById('ticket-form-content');
            const sentContent = document.getElementById('ticket-sent-content');
            const errorText = document.getElementById('ticket-error-text');
            
            if (popup) {
                // Reset form and hide error
                formContent.style.display = 'block';
                sentContent.style.display = 'none';
                if (errorText) {
                    errorText.style.display = 'none';
                }
                document.getElementById('ticket-subject').value = '';
                document.getElementById('ticket-description').value = '';
                document.getElementById('ticket-email').value = '';
                
                popup.style.display = 'flex';
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
            }
        }
        
        function closeTicketPopup() {
            const popup = document.getElementById('ticket-popup-overlay');
            if (popup) {
                popup.classList.remove('show');
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 300);
            }
        }
        
        async function sendTicket() {
            const subject = document.getElementById('ticket-subject').value.trim();
            const description = document.getElementById('ticket-description').value.trim();
            const email = document.getElementById('ticket-email').value.trim();
            const errorText = document.getElementById('ticket-error-text');
            
            // Hide any previous error
            if (errorText) {
                errorText.style.display = 'none';
            }
            
            // Basic validation
            if (!subject || !description || !email) {
                if (errorText) {
                    errorText.textContent = 'Please fill in all fields.';
                    errorText.style.display = 'block';
                } else {
                    alert('Please fill in all fields.');
                }
                return;
            }
            
            // Email validation
            if (!validateEmail(email)) {
                if (errorText) {
                    errorText.textContent = 'Please enter a valid school email address.';
                    errorText.style.display = 'block';
                } else {
                    alert('Please enter a valid school email address.');
                }
                return;
            }
            
            try {
                console.log('Starting ticket submission...');
                
                // Save ticket to Firebase
                const { getFirestore, collection, addDoc } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { app } = await import('./firebase.js');
                const db = getFirestore(app);
                
                console.log('Firebase modules loaded, creating ticket data...');
                
                const ticketData = {
                    subject: subject,
                    description: description,
                    email: email,
                    timestamp: new Date(),
                    status: 'open',
                    priority: 'normal'
                };
                
                console.log('Ticket data prepared:', ticketData);
                console.log('Attempting to save to Firebase...');
                
                const docRef = await addDoc(collection(db, 'tickets'), ticketData);
                console.log('Ticket saved with ID:', docRef.id);
                
                // Show sent confirmation
                const formContent = document.getElementById('ticket-form-content');
                const sentContent = document.getElementById('ticket-sent-content');
                
                formContent.style.display = 'none';
                sentContent.style.display = 'block';
                
                console.log('Ticket submitted successfully to Firebase');
            } catch (error) {
                // Track the error
                trackError();
                
                console.error('Error submitting ticket:', error);
                // Track the error
                trackError('Ticket submission error: ' + (error.message || error.code || 'Unknown error'));
                
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                // Handle specific error cases
                let errorMessage = 'Failed to submit ticket. Please try again.';
                if (error.code === 'permission-denied' || error.code === 'unavailable') {
                    errorMessage = 'Service temporarily unavailable. Please try again later.';
                } else if (error.message) {
                    errorMessage = `Failed to submit ticket: ${error.message}`;
                }
                
                if (errorText) {
                    errorText.textContent = errorMessage;
                    errorText.style.display = 'block';
                } else {
                    alert(errorMessage);
                }
            }
        }
        
        function showFAQPopup() {
            closeHelpPopup();
            const popup = document.getElementById('faq-popup-overlay');
            if (popup) {
                popup.style.display = 'flex';
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
            }
        }
        
        function closeFAQPopup() {
            const popup = document.getElementById('faq-popup-overlay');
            if (popup) {
                popup.classList.remove('show');
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 300);
            }
        }
        
        function closeAllPopups() {
            closeHelpPopup();
            closeTicketPopup();
            closeFAQPopup();
        }
        
        // Close popups when clicking outside
        document.addEventListener('click', function(e) {
            // Help popup
            const helpPopup = document.getElementById('help-popup-overlay');
            if (helpPopup && e.target === helpPopup) {
                closeHelpPopup();
            }
            
            // FAQ popup
            const faqPopup = document.getElementById('faq-popup-overlay');
            if (faqPopup && e.target === faqPopup) {
                closeFAQPopup();
            }
            
            // Ticket popup - only close if clicking outside, not if it's the sent confirmation
            const ticketPopup = document.getElementById('ticket-popup-overlay');
            const sentContent = document.getElementById('ticket-sent-content');
            if (ticketPopup && e.target === ticketPopup && sentContent.style.display === 'none') {
                closeTicketPopup();
            }
        });
        
        (async function() {
            try {
                const { auth } = await import('./firebase.js');
                const { onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
                const { getFirestore, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { app } = await import('./firebase.js');
                const db = getFirestore(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user && !isProcessingVerification) {
                        // Check if user exists in Firestore (completed registration)
                        try {
                            const userDoc = await getDocs(query(collection(db, "users"), where("email", "==", user.email)));
                            if (!userDoc.empty) {
                                // User exists in Firestore, which means they've completed registration
                                // Only redirect if we're not in the middle of email verification
                                const urlParams = new URLSearchParams(window.location.search);
                                const actionCode = urlParams.get('oobCode');
                                const mode = urlParams.get('mode');
                                
                                // Don't redirect if we're processing an email verification action code
                                if (!(actionCode && mode === 'verifyEmail')) {
                                    window.location.href = 'main.html';
                                }
                            }
                            // If user is authenticated but not in Firestore, stay on index.html for verification completion
                        } catch (error) {
                            console.error('Error checking user registration:', error);
                            // Stay on index.html if there's an error
                        }
                    }
                    // If user is not authenticated, stay on index.html
                });
            } catch (e) {
                console.error('Auth state check failed:', e);
            }
        })();
        const themeToggle = document.getElementById('theme-toggle');
        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('hubble-theme', theme);
            themeToggle.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        }
        themeToggle.onclick = () => {
            const current = document.body.getAttribute('data-theme');
            setTheme(current === 'light' ? 'dark' : 'light');
        };
        (function() {
            const saved = localStorage.getItem('hubble-theme');
            if (saved === 'dark' || saved === 'light') setTheme(saved);
            else setTheme('light');
        })();
        
        async function handleEmailVerification() {
            try {
                const { auth } = await import('./firebase.js');
                const { applyActionCode, checkActionCode } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
                
                // Check if there's an action code in the URL
                const urlParams = new URLSearchParams(window.location.search);
                const actionCode = urlParams.get('oobCode');
                const mode = urlParams.get('mode');
                
                console.log('Email verification check:', { actionCode: !!actionCode, mode });
                
                if (actionCode && mode === 'verifyEmail') {
                    try {
                        // Set flag to prevent auth state listener from interfering
                        isProcessingVerification = true;
                        
                        console.log('Processing email verification with action code...');
                        
                        async function handleEmailVerification() {
                          try {
                            const { auth } = await import('./firebase.js');
                            const { checkActionCode, applyActionCode } =
                              await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
                        
                            const urlParams = new URLSearchParams(window.location.search);
                            const actionCode = urlParams.get('oobCode');
                            const mode = urlParams.get('mode');
                        
                            console.log('Email verification check:', { actionCode: !!actionCode, mode });
                        
                            if (actionCode && mode === 'verifyEmail') {
                              try {
                                // Do not redeem yet ‚Äî scanners will only "load" the page
                                await checkActionCode(auth, actionCode);
                        
                                // Minimal inline UI so user can explicitly redeem
                                const host = document.getElementById('auth-container') || document.body;
                                const panel = document.createElement('div');
                                panel.style.marginTop = '1rem';
                                panel.innerHTML = `
                                  <div class="verification-container">
                                    <h1>Verify your email</h1>
                                    <div class="verification-message" id="verify-status">
                                      Code looks valid. Click <b>Verify</b> to finish.
                                    </div>
                                    <button class="btn verification-btn" id="verify-now" type="button">Verify</button>
                                  </div>
                                `;
                                host.prepend(panel);
                        
                                const status = panel.querySelector('#verify-status');
                                const btn = panel.querySelector('#verify-now');
                                btn.onclick = async () => {
                                  try {
                                    btn.disabled = true;
                                    status.textContent = 'Verifying‚Ä¶';
                                    await applyActionCode(auth, actionCode);
                        
                                    // Clean URL so refresh doesn't retry
                                    window.history.replaceState({}, document.title, window.location.pathname);
                        
                                    status.innerHTML = '‚úÖ Your email has been verified. Return to your other tab to continue.';
                                  } catch (e) {
                                    btn.disabled = false;
                                    status.textContent = `Failed to verify: ${e.code || e.message}`;
                                  }
                                };
                              } catch (error) {
                                // Invalid/expired/used link
                                window.history.replaceState({}, document.title, window.location.pathname);
                                const msg = (error.code === 'auth/expired-action-code' || error.code === 'auth/invalid-action-code')
                                  ? 'This link is invalid, expired, or already used. Please resend a new email.'
                                  : (error.code || error.message || 'Could not verify email.');
                                const host = document.getElementById('auth-container') || document.body;
                                host.insertAdjacentHTML('afterbegin', `<div class="error" style="margin:1rem 0">${msg}</div>`);
                              }
                            }
                          } catch (err) {
                            console.error('Error handling email verification:', err);
                          }
                        }

                        console.log('User reloaded, email verified:', auth.currentUser.emailVerified);
                        
                        // Complete registration in Firestore
                        const module = await import('./auth.js');
                        await module.completeRegistration();
                        console.log('Registration completed in Firestore');
                        
                        clearUsernameCleanup();
                        
                        // Clear URL parameters first to prevent auth state listener from interfering
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        // Show success message
                        await showCustomAlert('Email Verified!', 'Your email has been successfully verified. You can now sign in.');
                        
                        // Clear the flag and redirect to sign in
                        isProcessingVerification = false;
                        renderSignIn('Email verified successfully! You can now sign in.', {}, {});
                        
                    } catch (error) {
                        console.error('Email verification error:', error);
                        console.error('Error details:', {
                            code: error.code,
                            message: error.message,
                            stack: error.stack
                        });
                        
                        // Track the error
                        trackError('Email verification error: ' + (error.message || error.code || 'Unknown error'));
                        
                        // Clear the flag on error
                        isProcessingVerification = false;
                        let errorMessage = 'Email verification failed. ';
                        let showResendOption = false;
                        
                        if (error.code === 'auth/expired-action-code') {
                            errorMessage += 'The verification link has expired. Please request a new one.';
                            showResendOption = true;
                        } else if (error.code === 'auth/invalid-action-code') {
                            errorMessage += 'The verification link is invalid or has already been used. Please request a new one.';
                            showResendOption = true;
                        } else if (error.code === 'auth/user-disabled') {
                            errorMessage += 'This account has been disabled.';
                        } else if (error.code === 'auth/network-request-failed') {
                            errorMessage += 'Network error. Please check your internet connection and try again.';
                            showResendOption = true;
                        } else {
                            errorMessage += `Error: ${error.message || error.code || 'Unknown error'}. Please try requesting a new verification email.`;
                            showResendOption = true;
                        }
                        
                        // Clear URL parameters
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        if (showResendOption) {
                            // Show verification screen with resend option
                            renderVerification(errorMessage, 'Click "Resend Email" to get a new verification link.');
                        } else {
                            await showCustomAlert('Verification Failed', errorMessage);
                        }
                    }
                }
            } catch (error) {
                console.error('Error handling email verification:', error);
            }
        }

        function showCustomAlert(title, message) {
            return new Promise((resolve) => {
                const popup = document.getElementById('custom-popup');
                const titleEl = document.getElementById('popup-title');
                const messageEl = document.getElementById('popup-message');
                const inputEl = document.getElementById('popup-input');
                const buttonsEl = document.getElementById('popup-buttons');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                inputEl.style.display = 'none';
                buttonsEl.innerHTML = '<button class="popup-btn primary" onclick="closeCustomPopup()">OK</button>';
                
                popup.style.display = 'flex';
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
                
                window.closeCustomPopup = () => {
                    popup.classList.remove('show');
                    setTimeout(() => {
                        popup.style.display = 'none';
                        resolve();
                    }, 300);
                };
            });
        }
        
        function showCustomPrompt(title, message, placeholder = '') {
            return new Promise((resolve) => {
                const popup = document.getElementById('custom-popup');
                const titleEl = document.getElementById('popup-title');
                const messageEl = document.getElementById('popup-message');
                const inputEl = document.getElementById('popup-input');
                const buttonsEl = document.getElementById('popup-buttons');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                inputEl.style.display = 'block';
                inputEl.value = '';
                inputEl.placeholder = placeholder;
                buttonsEl.innerHTML = `
                    <button class="popup-btn secondary" onclick="cancelCustomPrompt()">Cancel</button>
                    <button class="popup-btn primary" onclick="confirmCustomPrompt()">OK</button>
                `;
                
                popup.style.display = 'flex';
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
                setTimeout(() => inputEl.focus(), 200);
                
                window.cancelCustomPrompt = () => {
                    popup.classList.remove('show');
                    setTimeout(() => {
                        popup.style.display = 'none';
                        resolve(null);
                    }, 300);
                };
                
                window.confirmCustomPrompt = () => {
                    const value = inputEl.value.trim();
                    popup.classList.remove('show');
                    setTimeout(() => {
                        popup.style.display = 'none';
                        resolve(value || null);
                    }, 300);
                };
                
                // Allow Enter key to confirm
                inputEl.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        window.confirmCustomPrompt();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        window.cancelCustomPrompt();
                    }
                };
            });
        }

        let currentScreen = 'signin';
        let isProcessingVerification = false;

        let lastSignupData = {};
        let pendingUsernameCleanupTimeout = null;

        // Handle incomplete verification (user verified email but no Firestore doc)
        async function handleIncompleteVerification(email, password) {
            // Check if username is stored in cookies
            const storedUsername = getCookie('pendingUsername');
            
            if (storedUsername) {
                // Username found, proceed to verification
                lastSignupData = { email, username: storedUsername, password };
                renderVerification('', 'Please complete your email verification to access your account.');
            } else {
                // No username found, show popup to get username
                showUsernamePopup(email, password);
            }
        }

        // Show popup to get username for incomplete verification
        function showUsernamePopup(email, password) {
            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.innerHTML = `
                <div class='popup-content'>
                    <h3>Complete Your Registration</h3>
                    <p>You need to enter a username to complete your email verification.</p>
                    <div class='form-group'>
                        <input type='text' id='popup-username' placeholder='Enter username' maxlength='75' required>
                        <div class='error-message' id='popup-username-error'></div>
                    </div>
                    <div class='popup-buttons'>
                        <button type='button' class='btn btn-secondary' id='popup-cancel'>Cancel</button>
                        <button type='button' class='btn' id='popup-continue'>Continue</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Handle popup events
            document.getElementById('popup-cancel').onclick = () => {
                document.body.removeChild(popup);
            };
            
            document.getElementById('popup-continue').onclick = async () => {
                const username = document.getElementById('popup-username').value.trim();
                const errorDiv = document.getElementById('popup-username-error');
                
                if (!validateUsername(username)) {
                    errorDiv.textContent = 'Username must be 3-75 characters.';
                    return;
                }
                
                // Check if username is already taken
                try {
                    const { db } = await import('./firebase.js');
                    const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                    
                    const q = query(collection(db, 'users'), where('username', '==', username));
                    const snap = await getDocs(q);
                    if (!snap.empty) {
                        errorDiv.textContent = 'That username is already taken.';
                        return;
                    }
                    
                    // Username is available, store it and proceed
                    setCookie('pendingUsername', username, 1); // Store for 1 day
                    lastSignupData = { email, username, password };
                    document.body.removeChild(popup);
                    renderVerification('', 'Please complete your email verification to access your account.');
                    
                } catch (error) {
                    console.error('Error checking username:', error);
                    errorDiv.textContent = 'Error checking username. Please try again.';
                }
            };
        }

        // Cookie helper functions
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const nameEQ = name + '=';
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        async function cleanupPendingUsername(showTimeoutUI = false) {
            try {
                const pendingData = localStorage.getItem('pendingUserData');
                if (pendingData) {
                    const data = JSON.parse(pendingData);
                    console.log('Cleaning up pending username and email:', data.username, data.email);
                    
                    // Delete the Firebase Auth account to free up the email
                    let authCleanupSuccess = false;
                    try {
                        const { auth } = await import('./firebase.js');
                        const { signInWithEmailAndPassword, deleteUser } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
                        
                        // We need to sign in to delete the account
                        if (data.password) {
                            const userCredential = await signInWithEmailAndPassword(auth, data.email, data.password);
                            await deleteUser(userCredential.user);
                            console.log('Successfully deleted abandoned Firebase Auth account for:', data.email);
                            authCleanupSuccess = true;
                        } else {
                            console.warn('No password stored for cleanup, cannot delete Firebase Auth account');
                        }
                    } catch (authError) {
                        console.warn('Could not delete Firebase Auth account during cleanup:', authError);
                        // Continue with localStorage cleanup even if auth deletion fails
                        // This is expected if the account was already deleted or doesn't exist
                    }
                    
                    // Always remove localStorage data to free up the username
                    localStorage.removeItem('pendingUserData');
                    console.log('Successfully cleaned up pending registration data');
                    
                    // Show timeout UI if requested and we're currently showing verification screen
                    if (showTimeoutUI) {
                        const authContainer = document.getElementById('auth-container');
                        if (authContainer && authContainer.innerHTML.includes('verification-container')) {
                            authContainer.innerHTML = `
                                <div class="verification-timeout-container">
                                    <h1>Account Creation Timed Out</h1>
                                    <div class="verification-timeout-message">
                                        Your account creation session has timed out after 5 minutes.
                                    </div>
                                    
                                    <div class="verification-timeout-info">
                                        <p><strong>What happened?</strong></p>
                                        <p>For security reasons, account creation sessions expire after 5 minutes of inactivity.</p>
                                        <p><strong>What to do next:</strong></p>
                                        <p>Click "Back to Login" below to start over with a new registration.</p>
                                    </div>
                                    
                                    <button class="btn verification-timeout-btn" id="back-to-login-btn" type="button">Back to Login</button>
                                </div>
                            `;
                            
                            // Add event listener for the back to login button
                            document.getElementById('back-to-login-btn').onclick = () => {
                                renderSignIn();
                            };
                        }
                    }
                    
                    // Return success status for better error handling
                    return { success: true, authCleanupSuccess };
                }
                return { success: true, authCleanupSuccess: true };
            } catch (error) {
                console.error('Error cleaning up pending username and email:', error);
                // Even if cleanup fails, try to remove localStorage to free up username
                try {
                    localStorage.removeItem('pendingUserData');
                    console.log('Removed pending data from localStorage despite error');
                } catch (localError) {
                    console.error('Failed to remove pending data from localStorage:', localError);
                }
                return { success: false, error: error.message };
            }
        }

        // Enhanced cleanup function that handles abandoned accounts more aggressively
        async function cleanupAbandonedAccount(email, password) {
            try {
                const { auth } = await import('./firebase.js');
                const { signInWithEmailAndPassword, deleteUser } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
                
                console.log('Attempting to clean up abandoned account for:', email);
                
                // Try to sign in to the existing account
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                // If the account exists but is not verified, delete it to allow re-registration
                if (!userCredential.user.emailVerified) {
                    console.log('Deleting abandoned unverified account for:', email);
                    await deleteUser(userCredential.user);
                    return { success: true, message: 'Successfully cleaned up abandoned account' };
                }
                
                return { success: false, message: 'Account is verified, cannot clean up' };
            } catch (error) {
                console.warn('Could not handle abandoned account:', error);
                
                // Provide more specific error messages based on the error type
                if (error.code === 'auth/wrong-password') {
                    return { success: false, message: 'Password is incorrect for existing account' };
                } else if (error.code === 'auth/user-not-found') {
                    return { success: false, message: 'No existing account found' };
                } else if (error.code === 'auth/too-many-requests') {
                    return { success: false, message: 'Too many attempts, please wait before trying again' };
                } else {
                    return { success: false, message: 'Could not clean up abandoned account: ' + (error.message || 'Unknown error') };
                }
            }
        }

        // Enhanced cleanup function that also handles expired sessions
        async function cleanupExpiredPendingSessions() {
            try {
                const pendingData = localStorage.getItem('pendingUserData');
                if (pendingData) {
                    const data = JSON.parse(pendingData);
                    const now = Date.now();
                    const sessionAge = now - (data.createdAt || 0);
                    const maxSessionAge = 30 * 60 * 1000; // 30 minutes (reduced from 2 hours)
                    
                    // If session is older than 30 minutes, clean it up
                    if (sessionAge > maxSessionAge) {
                        console.log('Cleaning up expired pending session for:', data.email);
                        const result = await cleanupPendingUsername();
                        if (result.success) {
                            console.log('Successfully cleaned up expired session');
                        } else {
                            console.warn('Failed to clean up expired session:', result.error);
                        }
                    }
                }
            } catch (error) {
                console.error('Error cleaning up expired pending sessions:', error);
            }
        }

        // Function to initialize cleanup on page load
        async function initializeCleanup() {
            try {
                await cleanupExpiredPendingSessions();
                
                // Also clean up any very old pending data (older than 1 hour)
                const pendingData = localStorage.getItem('pendingUserData');
                if (pendingData) {
                    const data = JSON.parse(pendingData);
                    const now = Date.now();
                    const sessionAge = now - (data.createdAt || 0);
                    const maxAge = 60 * 60 * 1000; // 1 hour
                    
                    if (sessionAge > maxAge) {
                        console.log('Cleaning up very old pending session on page load');
                        await cleanupPendingUsername();
                    }
                }
            } catch (error) {
                console.error('Error during initialization cleanup:', error);
            }
        }

        // Debug function to check pending data status (for testing)
        function debugPendingData() {
            const pendingData = localStorage.getItem('pendingUserData');
            if (pendingData) {
                const data = JSON.parse(pendingData);
                const now = Date.now();
                const sessionAge = now - (data.createdAt || 0);
                const maxSessionAge = 30 * 60 * 1000; // 30 minutes
                const isExpired = sessionAge > maxSessionAge;
                
                console.log('Pending Data Debug Info:');
                console.log('- Username:', data.username);
                console.log('- Email:', data.email);
                console.log('- Created:', new Date(data.createdAt).toLocaleString());
                console.log('- Age:', Math.round(sessionAge / 60000), 'minutes');
                console.log('- Is Expired:', isExpired);
                console.log('- Time until expiry:', Math.round((maxSessionAge - sessionAge) / 60000), 'minutes');
                
                return {
                    exists: true,
                    username: data.username,
                    email: data.email,
                    isExpired: isExpired,
                    ageMinutes: Math.round(sessionAge / 60000)
                };
            } else {
                console.log('No pending data found');
                return { exists: false };
            }
        }

        // Make debug function available globally for testing
        window.debugPendingData = debugPendingData;
        
        // Debug function to test email verification status
        async function debugEmailVerification() {
            try {
                const { auth } = await import('./firebase.js');
                const { getFirestore, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { app } = await import('./firebase.js');
                const db = getFirestore(app);
                
                console.log('=== Email Verification Debug Info ===');
                console.log('Current user:', auth.currentUser ? {
                    uid: auth.currentUser.uid,
                    email: auth.currentUser.email,
                    emailVerified: auth.currentUser.emailVerified
                } : 'No current user');
                
                const pendingData = localStorage.getItem('pendingUserData');
                if (pendingData) {
                    const data = JSON.parse(pendingData);
                    console.log('Pending data:', {
                        email: data.email,
                        username: data.username,
                        createdAt: new Date(data.createdAt).toLocaleString()
                    });
                    
                    // Check if user exists in Firestore
                    const userDoc = await getDocs(query(collection(db, "users"), where("email", "==", data.email)));
                    console.log('User in Firestore:', !userDoc.empty ? 'EXISTS' : 'NOT FOUND');
                } else {
                    console.log('No pending data found');
                }
                
                // Check URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const actionCode = urlParams.get('oobCode');
                const mode = urlParams.get('mode');
                console.log('URL parameters:', { actionCode: !!actionCode, mode });
                
                console.log('=== End Debug Info ===');
                
                return {
                    currentUser: auth.currentUser,
                    pendingData: pendingData ? JSON.parse(pendingData) : null,
                    urlParams: { actionCode: !!actionCode, mode }
                };
            } catch (error) {
                console.error('Debug error:', error);
                return { error: error.message };
            }
        }
        
        // Make debug function available globally
        window.debugEmailVerification = debugEmailVerification;

        
        function setupUsernameCleanup() {
            // Clear any existing timeout
            if (pendingUsernameCleanupTimeout) {
                clearTimeout(pendingUsernameCleanupTimeout);
            }
            
            // Set up cleanup on page unload (tab close, navigation, etc.)
            const handleUnload = () => {
                cleanupPendingUsername().catch(error => {
                    console.error('Cleanup failed on page unload:', error);
                    // Try to at least remove localStorage data
                    try {
                        localStorage.removeItem('pendingUserData');
                    } catch (localError) {
                        console.error('Failed to remove pending data on unload:', localError);
                    }
                });
            };
            
            // Multiple event listeners to catch different ways users can leave
            window.addEventListener('beforeunload', handleUnload);
            window.addEventListener('unload', handleUnload);
            window.addEventListener('pagehide', handleUnload);
            
            // Also set a timeout to clean up after 5 minutes of inactivity (reduced from 15)
            pendingUsernameCleanupTimeout = setTimeout(() => {
                console.log('Cleaning up pending username due to timeout');
                cleanupPendingUsername(true).catch(error => {
                    console.error('Cleanup failed on timeout:', error);
                    // Try to at least remove localStorage data
                    try {
                        localStorage.removeItem('pendingUserData');
                    } catch (localError) {
                        console.error('Failed to remove pending data on timeout:', localError);
                    }
                });
            }, 5 * 60 * 1000); // 5 minutes
            
            // Set up periodic cleanup check for expired sessions
            const cleanupInterval = setInterval(() => {
                cleanupExpiredPendingSessions().catch(console.error);
            }, 5 * 60 * 1000); // Check every 5 minutes
            
            // Store interval ID for cleanup
            window.pendingSessionCleanupInterval = cleanupInterval;
            
            // Also set up cleanup when page becomes hidden (user switches tabs, minimizes browser, etc.)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // Page is hidden, check if we should clean up
                    const pendingData = localStorage.getItem('pendingUserData');
                    if (pendingData) {
                        const data = JSON.parse(pendingData);
                        const now = Date.now();
                        const sessionAge = now - (data.createdAt || 0);
                        const maxSessionAge = 30 * 60 * 1000; // 30 minutes
                        
                        // If session is older than 30 minutes and page is hidden, clean it up
                        if (sessionAge > maxSessionAge) {
                            console.log('Cleaning up expired session due to page visibility change');
                            cleanupPendingUsername().catch(error => {
                                console.error('Cleanup failed on visibility change:', error);
                                // Try to at least remove localStorage data
                                try {
                                    localStorage.removeItem('pendingUserData');
                                } catch (localError) {
                                    console.error('Failed to remove pending data on visibility change:', localError);
                                }
                            });
                        }
                    }
                }
            });
        }
        
        function clearUsernameCleanup() {
            // Clear timeout when user completes registration
            if (pendingUsernameCleanupTimeout) {
                clearTimeout(pendingUsernameCleanupTimeout);
                pendingUsernameCleanupTimeout = null;
            }
            
            // Clear the periodic cleanup interval
            if (window.pendingSessionCleanupInterval) {
                clearInterval(window.pendingSessionCleanupInterval);
                window.pendingSessionCleanupInterval = null;
            }
            
            // Clear pending data from localStorage for security
            try {
                const pendingData = localStorage.getItem('pendingUserData');
                if (pendingData) {
                    const data = JSON.parse(pendingData);
                    // Remove password from stored data for security
                    delete data.password;
                    localStorage.setItem('pendingUserData', JSON.stringify(data));
                }
            } catch (error) {
                console.error('Error clearing password from pending data:', error);
            }
        }

        function validateEmail(email) {
            // Support both LWSD format (1XXXXXX@lwsd.org) and Salem format (XXXXXX@salem.k12.va.us)
            return /^1\d{6}@lwsd\.org$/.test(email) || /^\d{5}@salem\.k12\.va\.us$/.test(email);
        }
        function validateUsername(username) {
            return username.length >= 3 && username.length <= 75;
        }
        function validatePassword(password) {
            return password.length >= 8 && password.length <= 75;
        }
        function showError(msg) {
            return `<div class="error">${msg}</div>`;
        }

        function renderSignIn(errorMsg = '', values = {}, invalidFields = {}) {
            currentScreen = 'signin';
            clearAllValidationErrors(); // Clear any existing validation errors
            document.getElementById('auth-container').innerHTML = `
                <h1>Hubble</h1>
                ${errorMsg ? showError(errorMsg) : ''}
                <form id="signin-form">
                    <div class="input-group">
                        <label for="signin-email">Email Address</label>
                        <input type="email" id="signin-email" required autocomplete="username" value="${values.email || ''}" class="${invalidFields.email ? 'invalid' : ''}">
                    </div>
                    <div class="input-group">
                        <label for="signin-password">Password</label>
                        <input type="password" id="signin-password" required autocomplete="current-password" value="${values.password || ''}" class="${invalidFields.password ? 'invalid' : ''}">
                    </div>
                    <button class="btn" type="submit">Sign In</button>
                </form>
                <span class="switch-link" id="forgot-password">Forgot password?</span>
                <span class="switch-link" id="to-signup">Don't have an account? Sign up</span>
            `;
            document.getElementById('to-signup').onclick = () => {
                // Clear any existing cleanup when switching to signup
                clearUsernameCleanup();
                // Also clean up any pending data since user is switching away from verification
                cleanupPendingUsername().catch(error => {
                    console.error('Cleanup failed when switching to signup:', error);
                    // Try to at least remove localStorage data
                    try {
                        localStorage.removeItem('pendingUserData');
                    } catch (localError) {
                        console.error('Failed to remove pending data when switching to signup:', localError);
                    }
                });
                renderSignUp();
            };
            document.getElementById('forgot-password').onclick = async () => {
                const email = await showCustomPrompt('Reset Password', 'Enter your email address to reset your password:');
                if (!email || !validateEmail(email)) {
                    if (email !== null) { // Only show error if user didn't cancel
                        await showCustomAlert('Invalid Email', 'Please enter a valid school email address.');
                    }
                    return;
                }
                try {
                    const { auth } = await import('./firebase.js');
                    const { sendPasswordResetEmail } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
                    const { getFirestore, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                    
                    // First, check if the email exists in Firestore and is verified
                    const db = getFirestore();
                    const usersRef = collection(db, "users");
                    const userQuery = query(usersRef, where("email", "==", email));
                    const userDocs = await getDocs(userQuery);
                    
                    if (userDocs.empty) {
                        // Email not found in Firestore - show generic message for security
                        await showCustomAlert('Email Sent', 'If your email is linked to a verified account, you will receive a password reset email.');
                        return;
                    }
                    
                    // Email exists in Firestore, now check if it's verified in Firebase Auth
                    // We'll try to send the reset email - Firebase will only send if the account exists and is verified
                    const actionCodeSettings = {
                        url: window.location.origin + '/verification/',
                        handleCodeInApp: true
                    };
                    
                    await sendPasswordResetEmail(auth, email, actionCodeSettings);
                    await showCustomAlert('Email Sent', 'If your email is linked to an account, you will receive a password reset email.');
                } catch (err) {
                    // Track the error
                    trackError('Password reset error: ' + (err.message || err.code || 'Unknown error'));
                    
                    // Always show the same generic message for security, regardless of the actual error
                    await showCustomAlert('Email Sent', 'If your email is linked to an account, you will receive a password reset email.');
                }
            };
            
            // Add event listeners to clear validation errors when user starts typing
            document.getElementById('signin-email').addEventListener('input', function() {
                this.classList.remove('invalid');
            });
            document.getElementById('signin-password').addEventListener('input', function() {
                this.classList.remove('invalid');
            });
            
            document.getElementById('signin-form').onsubmit = async (e) => {
                e.preventDefault();
                const email = document.getElementById('signin-email').value.trim();
                const password = document.getElementById('signin-password').value;
                let invalid = {};
                if (!validateEmail(email)) invalid.email = true;
                if (!validatePassword(password)) invalid.password = true;
                if (Object.keys(invalid).length > 0) {
                    // Track validation errors
                    trackError('Sign in validation error: Invalid email or password format');
                    
                    renderSignIn(
                        !validateEmail(email) ? 'Invalid email format.' : 'Password must be 8-75 characters.',
                        { email, password },
                        invalid
                    );
                    return;
                }
                try {
                    const module = await import('./auth.js');
                    const user = await module.login(email, password);
                    // Don't redirect here - let onAuthStateChanged handle it
                    // This prevents double redirection that causes tab reload
                } catch (err) {
                    // Track the error
                    trackError('Sign in error: ' + (err.message || err.code || 'Unknown error'));
                    
                    let errorMessage = 'Sign in failed. Please check your email and password.';
                    
                    // Check for custom error messages first
                    if (err.message === 'EMAIL_NOT_VERIFIED') {
                        // Check if there's pending registration data to continue verification
                        const pendingData = localStorage.getItem('pendingUserData');
                        if (pendingData) {
                            const data = JSON.parse(pendingData);
                            if (data.email === email) {
                                lastSignupData = { email, username: data.username, password };
                                renderVerification('', 'Please complete your email verification to access your account.');
                                return;
                            }
                        }
                        errorMessage = 'Please verify your email before signing in. Check your inbox (and junk/spam folder) for a verification link.';
                    } else if (err.message === 'INCOMPLETE_VERIFICATION') {
                        // User has verified email but hasn't completed registration
                        await handleIncompleteVerification(email, password);
                        return;
                    } else if (err.message === 'ACCOUNT_NOT_COMPLETED') {
                        errorMessage = 'Account setup incomplete. Please complete the registration process.';
                    } else if (err.code) {
                        // Provide specific error messages based on Firebase error codes
                        switch (err.code) {
                            case 'auth/user-not-found':
                                errorMessage = 'No account found with this email address.';
                                break;
                            case 'auth/wrong-password':
                                errorMessage = 'Incorrect password. Please try again.';
                                break;
                            case 'auth/invalid-email':
                                errorMessage = 'Invalid email format. Please use your school email address.';
                                break;
                            case 'auth/too-many-requests':
                                errorMessage = 'Too many failed attempts. Please try again later.';
                                break;
                            case 'auth/user-disabled':
                                errorMessage = 'This account has been disabled. Please contact support.';
                                break;
                            case 'auth/network-request-failed':
                                errorMessage = 'Network error. Please check your internet connection.';
                                break;
                            default:
                                errorMessage = 'Sign in failed. Please check your email and password. Make sure you have an account. (You can create an account by click "Sign Up" below)';
                        }
                    }
                    
                    renderSignIn(errorMessage, { email, password }, { email: true, password: true });
                }
            };
        }

        function clearAllValidationErrors() {
            // Clear any existing validation errors from all form fields
            const allInputs = document.querySelectorAll('input');
            allInputs.forEach(input => {
                input.classList.remove('invalid');
            });
        }

        function renderSignUp(errorMsg = '', values = {}, invalidFields = {}) {
            currentScreen = 'signup';
            clearAllValidationErrors(); // Clear any existing validation errors
            document.getElementById('auth-container').innerHTML = `
                <h1>Sign Up</h1>
                ${errorMsg ? showError(errorMsg) : ''}
                <form id="signup-form">
                    <div class="input-group">
                        <label for="signup-username">Username</label>
                        <input type="text" id="signup-username" required minlength="3" maxlength="75" autocomplete="username" value="${values.username || ''}" class="${invalidFields.username ? 'invalid' : ''}">
                    </div>
                    <div class="input-group">
                        <label for="signup-email">Email Address</label>
                        <input type="email" id="signup-email" required autocomplete="email" value="${values.email || ''}" class="${invalidFields.email ? 'invalid' : ''}">
                    </div>
                    <div class="input-group">
                        <label for="signup-password">Password</label>
                        <input type="password" id="signup-password" required minlength="8" maxlength="75" autocomplete="new-password" value="${values.password || ''}" class="${invalidFields.password ? 'invalid' : ''}">
                    </div>
                    <div class="input-group">
                        <label for="signup-password2">Confirm Password</label>
                        <input type="password" id="signup-password2" required minlength="8" maxlength="75" autocomplete="new-password" value="${values.password2 || ''}" class="${invalidFields.password2 ? 'invalid' : ''}">
                    </div>
                    <button class="btn" type="submit">Create Account</button>
                </form>
                <span class="switch-link" id="to-signin">Already have an account? Sign in</span>
            `;
            document.getElementById('to-signin').onclick = () => {
                // Clear username cleanup when user abandons verification
                clearUsernameCleanup();
                // Also clean up the pending data since user is abandoning
                cleanupPendingUsername().catch(error => {
                    console.error('Cleanup failed when abandoning signup:', error);
                    // Try to at least remove localStorage data
                    try {
                        localStorage.removeItem('pendingUserData');
                    } catch (localError) {
                        console.error('Failed to remove pending data when abandoning signup:', localError);
                    }
                });
                renderSignIn();
            };
            // Add event listeners to clear validation errors when user starts typing
            document.getElementById('signup-username').addEventListener('input', function() {
                this.classList.remove('invalid');
            });
            document.getElementById('signup-email').addEventListener('input', function() {
                this.classList.remove('invalid');
            });
            document.getElementById('signup-password').addEventListener('input', function() {
                this.classList.remove('invalid');
            });
            document.getElementById('signup-password2').addEventListener('input', function() {
                this.classList.remove('invalid');
            });
            
            document.getElementById('signup-form').onsubmit = async (e) => {
                e.preventDefault();
                const username = document.getElementById('signup-username').value.trim();
                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value;
                const password2 = document.getElementById('signup-password2').value;
                let invalid = {};
                if (!validateUsername(username)) invalid.username = true;
                if (!validateEmail(email)) invalid.email = true;
                if (!validatePassword(password)) invalid.password = true;
                if (password !== password2) invalid.password2 = true;
                if (Object.keys(invalid).length > 0) {
                    // Track validation errors
                    trackError('Sign up validation error: Invalid form data');
                    
                    let msg = '';
                    if (invalid.username) msg = 'Username must be 3-75 characters.';
                    else if (invalid.email) msg = 'Email must be your school email address.';
                    else if (invalid.password) msg = 'Password must be 8-75 characters.';
                    else if (invalid.password2) msg = 'Passwords do not match.';
                    renderSignUp(msg, { username, email, password, password2 }, invalid);
                    return;
                }
                // Check for duplicate username in pending data and existing users
                try {
                    const { db } = await import('./firebase.js');
                    const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                    
                    // Check existing verified users
                    const q = query(collection(db, 'users'), where('username', '==', username));
                    const snap = await getDocs(q);
                    if (!snap.empty) {
                        // Track username duplication error
                        trackError('Sign up error: Username already taken');
                        
                        renderSignUp('That username is already taken.', { username, email, password, password2 }, { username: true });
                        return;
                    }
                    
                    // Check pending registration data in localStorage
                    const pendingData = localStorage.getItem('pendingUserData');
                    if (pendingData) {
                        const data = JSON.parse(pendingData);
                        const now = Date.now();
                        const sessionAge = now - (data.createdAt || 0);
                        const maxSessionAge = 30 * 60 * 1000; // 30 minutes
                        
                        // If this is the same username, handle it appropriately
                        if (data.username === username) {
                            if (sessionAge < maxSessionAge) {
                                // Session is still valid, check if it's the same email
                                if (data.email === email) {
                                    // Same user continuing registration, allow it
                                    console.log('Same user continuing registration, allowing username reuse');
                                } else {
                                    // Different email, username is reserved
                                    trackError('Sign up error: Username reserved for pending account');
                                    
                                    renderSignUp('That username is already reserved for a pending account. Please wait a few minutes or try a different username.', { username, email, password, password2 }, { username: true });
                                    return;
                                }
                            } else {
                                // Session is expired, clean it up and allow the username
                                console.log('Cleaning up expired pending session for username:', username);
                                const cleanupResult = await cleanupPendingUsername();
                                if (!cleanupResult.success) {
                                    console.warn('Cleanup failed, but continuing with registration attempt');
                                    // Continue with registration - if it fails due to duplicate, user will get appropriate error
                                }
                            }
                        }
                    }
                } catch (err) {
                    console.warn('Could not check username uniqueness:', err);
                    // Track the error but continue with registration
                    trackError('Username uniqueness check error: ' + (err.message || 'Unknown error'));
                    // Continue with registration - will be caught if duplicate exists
                }
                try {
                    // Clear any existing pending data before starting new registration
                    const existingPendingData = localStorage.getItem('pendingUserData');
                    if (existingPendingData) {
                        const existingData = JSON.parse(existingPendingData);
                        // Only clear if it's a different user (different email or username)
                        if (existingData.email !== email || existingData.username !== username) {
                            console.log('Clearing existing pending data for different user');
                            localStorage.removeItem('pendingUserData');
                        }
                    }
                    
                    const module = await import('./auth.js');
                    const { auth } = await import('./firebase.js');
                    const { sendEmailVerification } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
                    
                    console.log('Starting registration for:', email, username);
                    const user = await module.register(email, password, username);
                    console.log('Registration successful, user created:', user.uid);
                    
                    // Ensure user object is fully loaded before sending verification
                    await auth.currentUser.reload();
                    
                    // Send verification email with action code settings
                    if (auth.currentUser && !auth.currentUser.emailVerified) {
                        console.log('Sending email verification...');
                        try {
                            await sendEmailVerification(auth.currentUser, {
                              url: window.location.origin + '/verification/',
                              handleCodeInApp: true
                            });

                            console.log('Email verification sent successfully');
                            lastSignupData = { email, username, password };
                            
                            // Set up username cleanup in case user abandons registration
                            setupUsernameCleanup();
                            
                            renderVerification('', 'Verification email sent! Please check your inbox (and junk/spam folder) and click the link within 5 minutes.');
                        } catch (emailError) {
                            console.error('Email verification failed:', emailError);
                            // Track the email error
                            trackError('Email verification error: ' + (emailError.message || emailError.code || 'Unknown error'));
                            
                            // Show specific error message based on the error type
                            let errorMessage = 'Email verification failed to send. ';
                            if (emailError.code === 'auth/operation-not-allowed') {
                                errorMessage += 'Email verification is not enabled in Firebase Auth settings. The administrator needs to enable email verification in the Firebase Console.';
                            } else if (emailError.code === 'auth/invalid-action-code') {
                                errorMessage += 'Invalid verification configuration. Please contact support.';
                            } else if (emailError.code === 'auth/too-many-requests') {
                                errorMessage += 'Too many requests. Please wait a few minutes before trying again.';
                            } else if (emailError.code === 'auth/network-request-failed') {
                                errorMessage += 'Network error. Please check your internet connection and try again.';
                            } else {
                                errorMessage += `Error: ${emailError.message || emailError.code || 'Unknown error'}. Please try the resend button or contact support.`;
                            }
                            
                            renderVerification(errorMessage, '');
                        }
                    } else {
                        console.log('User already verified or no current user');
                        renderSignIn('Account created! Please verify your email before signing in.', { email }, {});
                    }
                } catch (err) {
                    // Track the error
                    trackError('Sign up error: ' + (err.message || err.code || 'Unknown error'));
                    
                    let errorMessage = 'Sign up failed. Please try again.';
                    let invalidFields = {};
                    
                    // Provide specific error messages based on Firebase error codes
                    if (err.code) {
                        switch (err.code) {
                            case 'auth/email-already-in-use':
                                // Check if this is an existing verified account
                                try {
                                    const { auth } = await import('./firebase.js');
                                    const { signInWithEmailAndPassword, signOut } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
                                    
                                    // Try to sign in to check if account is verified
                                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                                    await signOut(auth);
                                    
                                    if (userCredential.user.emailVerified) {
                                        // Account exists and is verified - tell user to sign in
                                        errorMessage = 'An account with this email already exists. Please sign in to access your account.';
                                        break;
                                    } else {
                                        // Account exists but not verified - try cleanup
                                        const cleanupResult = await cleanupAbandonedAccount(email, password);
                                        if (cleanupResult.success) {
                                            // Successfully cleaned up, try registration again
                                            try {
                                                const module = await import('./auth.js');
                                                const { auth } = await import('./firebase.js');
                                                const { sendEmailVerification } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
                                                const user = await module.register(email, password, username);
                                                
                                                // Ensure user object is fully loaded before sending verification
                                                await auth.currentUser.reload();
                                                
                                                // Send verification email with action code settings
                                                if (auth.currentUser && !auth.currentUser.emailVerified) {
                                                    await sendEmailVerification(auth.currentUser, {
                                                      url: window.location.origin + '/verification/',
                                                      handleCodeInApp: true
                                                    });

                                                    lastSignupData = { email, username, password };
                                                    
                                                    // Set up username cleanup in case user abandons registration
                                                    setupUsernameCleanup();
                                                    
                                                    renderVerification('', 'Verification email sent! Please check your inbox (and junk/spam folder) and click the link within 5 minutes.');
                                                    return; // Exit early since we successfully registered
                                                }
                                            } catch (retryError) {
                                                console.error('Retry registration failed:', retryError);
                                                // Track the retry error
                                                trackError('Retry registration error: ' + (retryError.message || retryError.code || 'Unknown error'));
                                                
                                                // Provide more specific error message based on retry failure
                                                if (retryError.code === 'auth/email-already-in-use') {
                                                    errorMessage = 'Account cleanup was attempted but the email is still in use. Please try signing in instead.';
                                                    invalidFields = { email: true };
                                                } else {
                                                    errorMessage = 'Registration failed. Please try again with a different email or contact support if the issue persists.';
                                                    invalidFields = { email: true, password: true };
                                                }
                                            }
                                        } else {
                                            // Cleanup failed, provide helpful message
                                            if (cleanupResult.message.includes('verified')) {
                                                errorMessage = 'An account with this email already exists and is verified. Please sign in instead.';
                                                invalidFields = { email: true };
                                            } else if (cleanupResult.message.includes('Password is incorrect')) {
                                                errorMessage = 'An account with this email already exists but the password is different. Please sign in instead or use a different email.';
                                                invalidFields = { email: true };
                                            } else if (cleanupResult.message.includes('Too many attempts')) {
                                                errorMessage = 'Too many registration attempts. Please wait a few minutes before trying again.';
                                                invalidFields = { email: true };
                                            } else {
                                                errorMessage = 'An account with this email already exists. Please sign in instead, or try again in a few minutes if you recently started registration.';
                                                invalidFields = { email: true };
                                            }
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error during account cleanup check:', error);
                                    errorMessage = 'An account with this email already exists. Please sign in instead.';
                                    invalidFields = { email: true };
                                }
                                break;
                            case 'auth/invalid-email':
                                errorMessage = 'Invalid email format. Please use your school email address.';
                                invalidFields = { email: true };
                                break;
                            case 'auth/weak-password':
                                errorMessage = 'Password is too weak. Please choose a stronger password.';
                                invalidFields = { password: true, password2: true };
                                break;
                            case 'auth/network-request-failed':
                                errorMessage = 'Network error. Please check your internet connection and try again.';
                                break;
                            case 'auth/too-many-requests':
                                errorMessage = 'Too many attempts. Please wait a few minutes before trying again.';
                                break;
                            case 'auth/operation-not-allowed':
                                errorMessage = 'Account creation is temporarily disabled. Please try again later.';
                                break;
                            case 'auth/invalid-credential':
                                errorMessage = 'Invalid credentials provided. Please check your information and try again.';
                                break;
                            default:
                                // For unknown errors, provide more helpful message
                                if (err.message) {
                                    errorMessage = `Registration failed: ${err.message}. Please try again.`;
                                } else {
                                    errorMessage = 'Registration failed due to an unexpected error. Please try again or contact support if the issue persists.';
                                }
                        }
                    } else if (err.message) {
                        // Handle non-Firebase errors
                        errorMessage = `Registration failed: ${err.message}. Please try again.`;
                    }
                    
                    renderSignUp(errorMessage, { username, email, password, password2 }, invalidFields);
                }
            };
        }

        function renderVerification(errorMsg = '', infoMsg = '') {
            currentScreen = 'verify';
            
            // Set up verification timeout (30 minutes)
            const verificationTimeout = setTimeout(() => {
                console.log('Verification session timed out, showing timeout screen');
                renderVerificationTimeout();
            }, 30 * 60 * 1000); // 30 minutes
            
            // Store timeout ID for cleanup
            window.verificationTimeoutId = verificationTimeout;
            
            document.getElementById('auth-container').innerHTML = `
                <div class="verification-container">
                    <h1>Check Your Email</h1>
                    <div class="verification-message">
                        We've sent a verification link to<br>
                        <span class="email-highlight">${lastSignupData.email}</span>
                    </div>
                    
                    <div id="verify-messages" class="verification-status">
                        ${infoMsg ? `<div class="info">${infoMsg}</div>` : ''}
                        ${errorMsg ? showError(errorMsg) : ''}
                    </div>
                    
                    <div class="verification-steps">
                        <div class="step">
                            <span class="step-number">1</span>
                            <span class="step-text">Check your email inbox</span>
                        </div>
                        <div class="step">
                            <span class="step-number">2</span>
                            <span class="step-text">Click the verification link in the email</span>
                        </div>
                        <div class="step">
                            <span class="step-number">3</span>
                            <span class="step-text">If you see "Try verifying your email again" - that's normal! Complete the next step</span>
                        </div>
                        <div class="step">
                            <span class="step-number">4</span>
                            <span class="step-text">Come back to this page and click "I've Verified My Email" (only works after clicking the email link)</span>
                        </div>
                        <div class="step">
                            <span class="step-number">5</span>
                            <span class="step-text">If verification fails, you may need to try resending the email link</span>
                        </div>
                    </div>
                    
                    <button class="btn verification-btn" id="verify-btn" type="button">I've Verified My Email</button>
                    
                    <div class="verification-actions">
                        <span class="switch-link" id="resend-btn">Didn't receive the email or link expired? Resend Email</span>
                    </div>
                </div>
            `;
            document.getElementById('verify-btn').onclick = async () => {
                try {
                    // Clear the verification timeout since user is actively trying to verify
                    if (window.verificationTimeoutId) {
                        clearTimeout(window.verificationTimeoutId);
                        window.verificationTimeoutId = null;
                    }
                    
                    const { auth } = await import('./firebase.js');
                    const { signInWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
                    
                    if (!auth.currentUser) {
                        await signInWithEmailAndPassword(auth, lastSignupData.email, lastSignupData.password);
                    }
                    
                    // Reload user to check verification status
                    await auth.currentUser.reload();
                    
                    // Check if user exists in Firestore (completed registration)
                    const { getFirestore, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                    const { app } = await import('./firebase.js');
                    const db = getFirestore(app);
                    const userDoc = await getDocs(query(collection(db, "users"), where("email", "==", auth.currentUser.email)));
                    
                    if (!userDoc.empty) {
                        // User exists in Firestore - check if we need to add username
                        const userData = userDoc.docs[0].data();
                        
                        if (!userData.username && lastSignupData.username) {
                            // User document exists but missing username - update it
                            console.log('Updating existing user document with username...');
                            
                            const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                            const userDocRef = doc(db, "users", userDoc.docs[0].id);
                            
                            await updateDoc(userDocRef, {
                                username: lastSignupData.username,
                                uid: auth.currentUser.uid,
                                registrationCompleted: true
                            });
                            
                            console.log('User document updated with username successfully');
                        }
                        
                        clearUsernameCleanup();
                        window.location.href = './main.html';
                    } else {
                        // No user document found
                        const msgDiv = document.getElementById('verify-messages');
                        msgDiv.innerHTML = `${showError('Please check your email and click the verification link to complete your registration.')}`;
                    }
                } catch (err) {
                    // Track the error
                    trackError();
                    
                    console.error('Verification error:', err);
                    // Track the error
                    trackError('Verification button error: ' + (err.message || err.code || 'Unknown error'));
                    
                    const msgDiv = document.getElementById('verify-messages');
                    msgDiv.innerHTML = `${showError('Verification failed. Please try again or resend the code.')}`;
                }
            };
            document.getElementById('resend-btn').onclick = async () => {
                try {
                    // Reset the verification timeout when user clicks resend
                    if (window.verificationTimeoutId) {
                        clearTimeout(window.verificationTimeoutId);
                    }
                    
                    // Set up a new 30-minute timeout
                    const verificationTimeout = setTimeout(() => {
                        console.log('Verification session timed out after resend, showing timeout screen');
                        renderVerificationTimeout();
                    }, 30 * 60 * 1000); // 30 minutes
                    
                    window.verificationTimeoutId = verificationTimeout;
                    
                    const { auth } = await import('./firebase.js');
                    const { sendEmailVerification, signInWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
                    
                    // Check if we have pending data
                    if (!lastSignupData.email || !lastSignupData.password) {
                        const msgDiv = document.getElementById('verify-messages');
                        msgDiv.innerHTML = `${showError('No pending registration found. Please start the registration process again.')}`;
                        return;
                    }
                    
                    if (!auth.currentUser) {
                        try {
                            await signInWithEmailAndPassword(auth, lastSignupData.email, lastSignupData.password);
                        } catch (signInError) {
                            console.error('Sign in error during resend:', signInError);
                            const msgDiv = document.getElementById('verify-messages');
                            msgDiv.innerHTML = `${showError('Unable to resend email. Please start the registration process again.')}`;
                            return;
                        }
                    }
                    
                    // Resend verification email with action code settings
                    console.log('Resending email verification for:', auth.currentUser.email);
                    await sendEmailVerification(auth.currentUser, {
                      url: window.location.origin + '/verification/',
                      handleCodeInApp: true
                    });

                    console.log('Email verification resent successfully');
                    
                    // Show success message
                    const msgDiv = document.getElementById('verify-messages');
                    msgDiv.innerHTML = `<div class="info">New verification email sent! Please check your inbox (and junk/spam folder) and click the link within 5 minutes.</div>`;
                    
                } catch (err) {
                    // Track the error
                    trackError();
                    
                    console.error('Resend error:', err);
                    // Track the error
                    trackError('Resend email error: ' + (err.message || err.code || 'Unknown error'));
                    
                    const msgDiv = document.getElementById('verify-messages');
                    let errorMessage = 'Failed to resend verification email. ';
                    
                    if (err.code === 'auth/too-many-requests') {
                        errorMessage += 'Too many requests. Please wait a few minutes before trying again.';
                    } else if (err.code === 'auth/user-not-found') {
                        errorMessage += 'Account not found. Please start the registration process again.';
                    } else if (err.code === 'auth/operation-not-allowed') {
                        errorMessage += 'Email verification is not enabled in Firebase Auth settings. Please contact support to enable email verification.';
                    } else if (err.code === 'auth/invalid-action-code') {
                        errorMessage += 'Invalid verification configuration. Please contact support.';
                    } else if (err.code === 'auth/network-request-failed') {
                        errorMessage += 'Network error. Please check your internet connection and try again.';
                    } else {
                        errorMessage += 'Please try again or start the registration process over.';
                    }
                    
                    msgDiv.innerHTML = `${showError(errorMessage)}`;
                }
            };
        }

        function renderVerificationTimeout() {
            currentScreen = 'verify-timeout';
            
            // Clear any existing timeout
            if (window.verificationTimeoutId) {
                clearTimeout(window.verificationTimeoutId);
                window.verificationTimeoutId = null;
            }
            
            // Clean up pending data since session timed out
            cleanupPendingUsername().catch(error => {
                console.error('Cleanup failed on verification timeout:', error);
                // Try to at least remove localStorage data
                try {
                    localStorage.removeItem('pendingUserData');
                } catch (localError) {
                    console.error('Failed to remove pending data on timeout:', localError);
                }
            });
            
            document.getElementById('auth-container').innerHTML = `
                <div class="verification-timeout-container">
                    <h1>Session Expired</h1>
                    <div class="verification-timeout-message">
                        Your verification session has timed out after 30 minutes.
                    </div>
                    
                    <div class="verification-timeout-info">
                        <p><strong>What happened?</strong></p>
                        <p>For security reasons, email verification sessions expire after 30 minutes of inactivity.</p>
                        <p><strong>What to do next:</strong></p>
                        <p>Click "Back to Login" below to start over with a new registration.</p>
                    </div>
                    
                    <button class="btn verification-timeout-btn" id="back-to-login-btn" type="button">Back to Login</button>
                </div>
            `;
            
            document.getElementById('back-to-login-btn').onclick = () => {
                // Clear any remaining cleanup timeouts
                clearUsernameCleanup();
                
                // Clear pending data
                try {
                    localStorage.removeItem('pendingUserData');
                } catch (error) {
                    console.error('Failed to clear pending data:', error);
                }
                
                // Reset to sign in screen
                renderSignIn('Your verification session has expired. Please sign up again if needed.');
            };
        }



        (function() {
            const saved = localStorage.getItem('hubble-theme');
            if (saved === 'dark' || saved === 'light') setTheme(saved);
            else setTheme('light');
        })();

        // Check for expired pending sessions on page load
        cleanupExpiredPendingSessions().catch(console.error);
        
        // Also check for expired sessions when the page becomes visible again
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Page is visible again, check for expired sessions
                cleanupExpiredPendingSessions().catch(console.error);
            }
        });
        
        handleEmailVerification();
        
        renderSignIn();
        
        document.addEventListener('DOMContentLoaded', function() {
            const helpButton = document.getElementById('help-button');
            if (helpButton) {
                helpButton.addEventListener('click', showHelpPopup);
            }
            
            // Initialize cleanup of expired pending sessions
            initializeCleanup();
        });
        
        // Inspection Protection Code
        (function() {
            'use strict';
            
            // Disable right-click context menu (silent - no alerts)
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopImmediatePropagation();
                return false;
            }, true);
            
            // Disable inspection keyboard shortcuts (triggers alert/redirect)
            document.addEventListener('keydown', function(e) {
                // F12
                if (e.keyCode === 123 || e.key === 'F12') {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    document.documentElement.innerHTML = '<body style="background:#000;color:#ff0000;text-align:center;padding-top:40vh;font-size:24px;">ACCESS DENIED</body>';
                    setTimeout(() => window.location.href = 'about:blank', 500);
                    return false;
                }
                // Ctrl+Shift+I (Inspector)
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.keyCode === 73 || e.key === 'I')) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    document.documentElement.innerHTML = '<body style="background:#000;color:#ff0000;text-align:center;padding-top:40vh;font-size:24px;">ACCESS DENIED</body>';
                    setTimeout(() => window.location.href = 'about:blank', 500);
                    return false;
                }
                // Ctrl+Shift+J (Console)
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.keyCode === 74 || e.key === 'J')) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    document.documentElement.innerHTML = '<body style="background:#000;color:#ff0000;text-align:center;padding-top:40vh;font-size:24px;">ACCESS DENIED</body>';
                    setTimeout(() => window.location.href = 'about:blank', 500);
                    return false;
                }
                // Ctrl+Shift+C (Element Selector)
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.keyCode === 67 || e.key === 'C')) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    document.documentElement.innerHTML = '<body style="background:#000;color:#ff0000;text-align:center;padding-top:40vh;font-size:24px;">ACCESS DENIED</body>';
                    setTimeout(() => window.location.href = 'about:blank', 500);
                    return false;
                }
                // Ctrl+U (View Source)
                if ((e.ctrlKey || e.metaKey) && (e.keyCode === 85 || e.key === 'u')) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    document.documentElement.innerHTML = '<body style="background:#000;color:#ff0000;text-align:center;padding-top:40vh;font-size:24px;">ACCESS DENIED</body>';
                    setTimeout(() => window.location.href = 'about:blank', 500);
                    return false;
                }
                // Ctrl+Shift+K (Console Firefox)
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.keyCode === 75 || e.key === 'K')) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    document.documentElement.innerHTML = '<body style="background:#000;color:#ff0000;text-align:center;padding-top:40vh;font-size:24px;">ACCESS DENIED</body>';
                    setTimeout(() => window.location.href = 'about:blank', 500);
                    return false;
                }
            }, true);
            
            
            // Console detection (less aggressive)
            let consoleDetectionCount = 0;
            let element = new Image();
            Object.defineProperty(element, 'id', {
                get: function() {
                    consoleDetectionCount++;
                    // Only trigger after multiple detections to avoid false positives
                    if (consoleDetectionCount > 3) {
                        document.documentElement.innerHTML = '<body style="background:#000;color:#ff0000;text-align:center;padding-top:40vh;font-size:24px;">ACCESS DENIED</body>';
                        setTimeout(() => window.location.href = 'about:blank', 500);
                    }
                }
            });
            
            // Less frequent console checks
            setInterval(function() {
                console.log(element);
                console.clear();
            }, 5000);
            
            // Disable text selection and copying (but allow input interaction)
            document.onselectstart = function(e) { 
                // Allow selection in input fields
                if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) {
                    return true;
                }
                return false; 
            };
            document.onmousedown = function(e) { 
                // Allow mouse down in input fields and buttons
                if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'BUTTON')) {
                    return true;
                }
                return false; 
            };
            document.ondragstart = function(e) { 
                // Allow dragging in input fields
                if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) {
                    return true;
                }
                return false; 
            };
            
        })();

        // Important Notice Popup Functionality
        function showImportantNotice() {
            const overlay = document.getElementById('important-notice-overlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }

        function hideImportantNotice() {
            const overlay = document.getElementById('important-notice-overlay');
            const popup = overlay?.querySelector('.important-notice-popup');
            
            if (overlay && popup) {
                // Add closing animation class
                popup.classList.add('closing');
                
                // Hide overlay after animation completes
                setTimeout(() => {
                    overlay.style.display = 'none';
                    popup.classList.remove('closing');
                    // Store that user has seen the notice
                    localStorage.setItem('importantNoticeSeen', 'true');
                }, 500); // Match animation duration
            }
        }

        // Show popup on page load (unless already seen)
        document.addEventListener('DOMContentLoaded', function() {
            const hasSeenNotice = localStorage.getItem('importantNoticeSeen');
            if (!hasSeenNotice) {
                // Small delay to ensure page is fully loaded
                setTimeout(showImportantNotice, 500);
            }
        });

        // Handle "I Understand" button click
        document.addEventListener('DOMContentLoaded', function() {
            const understandBtn = document.getElementById('important-notice-understand');
            if (understandBtn) {
                understandBtn.addEventListener('click', hideImportantNotice);
            }
        });

        
    </script>
    <script type="module" src="./firebase.js"></script>
    
    <!-- Version Checker -->
    <script type="module" src="./version-check.js"></script>
    
    <!-- Watermark Component -->
    <script type="module" src="./watermark.js"></script>
</body>
</html>