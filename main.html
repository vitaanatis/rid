<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hubble | Alpha</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap');
        :root {
            --primary: #009CFC;
            --secondary: #A0AAFF;
            --accent: #C97FFD;
            --background-light: #f7f8fa;
            --star: #A0AAFF;
            --planet: #C97FFD;
            --text-light: #222;
            --sidebar-bg-light: #f4f7ff;
            --sidebar-border-light: #e0e6f7;
            --sidebar-active-light: #e6f2ff;
            --main-content-light: transparent;
            --background-dark: #181e2a;
            --sidebar-bg-dark: #232a3a;
            --sidebar-border-dark: #2c3550;
            --sidebar-active-dark: #232a3a;
            --text-dark: #f7f8fa;
            --main-content-dark: transparent;
            --unavailable-light: #FFC107;
            --unavailable-dark: #FF8F00;
        }
        body {
            font-family: 'Poppins', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            transition: background-color 0.6s cubic-bezier(0.4, 0, 0.2, 1), color 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body[data-theme="light"] {
            background: var(--background-light);
            color: var(--text-light);
        }
        body[data-theme="dark"] {
            background: var(--background-dark);
            color: var(--text-dark);
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 0;
            pointer-events: none;
            background: 
                radial-gradient(circle at 80% 20%, rgba(201,127,253,0.13) 0 8vw, transparent 12vw),
                radial-gradient(circle at 15% 80%, rgba(0,156,252,0.10) 0 5vw, transparent 8vw),
                repeating-radial-gradient(circle at 30% 30%, #a2dbff 0 1px, transparent 2px 100px),
                repeating-radial-gradient(circle at 50% 50%, #A0AAFF 0 1px, transparent 2px 100px),
                repeating-radial-gradient(circle at 30% 30%, #fff 0 1px, transparent 2px 100px),
                repeating-radial-gradient(circle at 50% 50%, rgba(160,170,255,0.08) 0 60px, transparent 62px 100vw);
            opacity: 0.22;
        }
        .topbar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 56px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10000;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            transition: background-color 0.6s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body[data-theme="dark"] .topbar {
            background: #20263a;
            box-shadow: 0 2px 12px rgba(0,0,0,0.13);
        }
        .hubble-gradient {
            font-family: 'Poppins', 'Helvetica Neue', Arial, sans-serif;
            font-weight: 700;
            font-size: clamp(1.5rem, 5vw, 2.2rem);
            background: linear-gradient(90deg, #009CFC 0%, #A0AAFF 50%, #C97FFD 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            margin-left: 2.2rem;
            letter-spacing: 2px;
            -webkit-user-select: none;
            user-select: none;
            cursor: default;
        }
        .search-bar-custom {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            max-width: 40vw;
            min-width: 200px;
            height: 38px;
            border-radius: 8px;
            border: 1.5px solid var(--secondary);
            font-size: 1.08rem;
            padding: 0 1.1rem;
            background: var(--background-light);
            color: var(--text-light);
            outline: none;
            transition: border 0.18s, background 0.18s;
            z-index: 10;
            pointer-events: none;
            cursor: not-allowed;
            text-align: center;
        }
        .search-bar-custom:focus {
            border: 1.5px solid var(--primary);
            background: #eaf6ff;
        }
        body[data-theme="dark"] .search-bar-custom {
            background: #232a3a;
            color: #f7f8fa;
            border: 1.5px solid var(--sidebar-border-dark);
        }
        body[data-theme="dark"] .search-bar-custom:focus {
            background: #232a3a;
        }
        
        /* Progress Bar Styles */
        .registration-progress-bar {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            max-width: 40vw;
            min-width: 200px;
            height: 38px;
            border-radius: 8px;
            border: 1.5px solid var(--secondary);
            background: #ffffff;
            z-index: 10;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        body[data-theme="dark"] .registration-progress-bar {
            background: #232a3a;
            border: 1.5px solid var(--sidebar-border-dark);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .progress-bar-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .progress-bar-track {
            width: 85%;
            height: 8px;
            background: rgba(160, 170, 255, 0.3);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(160, 170, 255, 0.4);
        }
        
        body[data-theme="dark"] .progress-bar-track {
            background: rgba(160, 170, 255, 0.1);
            border: 1px solid rgba(160, 170, 255, 0.2);
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #009CFC 0%, #A0AAFF 25%, #C97FFD 50%, #009CFC 75%, #A0AAFF 100%);
            background-size: 400% 100%;
            border-radius: 4px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            animation: hubble-gradient-flow 12s linear infinite;
            position: relative;
        }
        
        .progress-bar-fill.golden {
            background: linear-gradient(90deg, #ffd700 0%, #ffed4e 25%, #ffd700 50%, #ffed4e 75%, #ffd700 100%);
            background-size: 400% 100%;
            animation: golden-shine 2s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), inset 0 0 20px rgba(255, 255, 255, 0.3);
        }
        
        @keyframes golden-shine {
            0%, 100% {
                background: linear-gradient(90deg, #ffd700 0%, #ffed4e 25%, #ffd700 50%, #ffed4e 75%, #ffd700 100%);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), inset 0 0 20px rgba(255, 255, 255, 0.3);
            }
            50% {
                background: linear-gradient(90deg, #ffed4e 0%, #ffd700 25%, #ffed4e 50%, #ffd700 75%, #ffed4e 100%);
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), inset 0 0 30px rgba(255, 255, 255, 0.5);
            }
        }

        /* Alpha Badge Styles */
        .alpha-badge {
            display: inline-block;
            margin-left: 1rem;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4, #45B7D1, #96CEB4, #FFEAA7);
            background-size: 400% 400%;
            color: white !important;
            -webkit-text-fill-color: white !important;
            padding: 0.3rem 0.8rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            animation: alpha-gradient-flow 3s ease-in-out infinite;
            vertical-align: middle;
            -webkit-background-clip: initial !important;
            background-clip: initial !important;
        }

        @keyframes alpha-gradient-flow {
            0%, 100% {
                background-position: 0% 50%;
            }
            25% {
                background-position: 100% 50%;
            }
            50% {
                background-position: 100% 100%;
            }
            75% {
                background-position: 0% 100%;
            }
        }

        .alpha-badge.hidden {
            display: none;
        }
        
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light);
            text-align: center;
            z-index: 2;
            background: rgba(255, 255, 255, 0.95);
            padding: 4px 10px;
            border-radius: 6px;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(0, 0, 0, 0.2);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        body[data-theme="dark"] .progress-text {
            color: var(--text-dark);
            background: rgba(35, 42, 58, 0.95);
            border: 1px solid rgba(160, 170, 255, 0.3);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .gift-emoji {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            animation: gift-bounce 2s ease-in-out infinite;
            transition: opacity 0.5s ease;
        }
        
        .progress-bar-fill.golden ~ .gift-emoji {
            opacity: 0;
            pointer-events: none;
        }
        
        @keyframes gift-bounce {
            0%, 100% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-60%) scale(1.1); }
        }
        
        /* Onboarding Animation Styles */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .onboarding-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .onboarding-gift {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8rem;
            z-index: 10001;
            transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            animation: gift-bounce-onboarding 2s ease-in-out infinite;
        }
        
        @keyframes gift-bounce-onboarding {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -60%) scale(1.1); }
        }
        
        .onboarding-gift.shrinking {
            font-size: 1.2rem;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: none;
            transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
        }
        
        .onboarding-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: transparent;
            z-index: 10002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 600px;
            width: 90%;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            align-items: center;
        }
        
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10001;
            overflow: hidden;
        }
        
        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff6b6b;
            animation: confetti-fall linear forwards;
            opacity: 0.9;
        }
        
        .confetti-piece:nth-child(2n) { background: #4ecdc4; }
        .confetti-piece:nth-child(3n) { background: #45b7d1; }
        .confetti-piece:nth-child(4n) { background: #96ceb4; }
        .confetti-piece:nth-child(5n) { background: #feca57; }
        .confetti-piece:nth-child(6n) { background: #ff9ff3; }
        .confetti-piece:nth-child(7n) { background: #54a0ff; }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        
        .onboarding-container.show {
            opacity: 1;
            visibility: visible;
        }
        
        
        
        .onboarding-text {
            text-align: center;
            color: var(--text-light);
            line-height: 1.6;
            background: var(--background-light);
            border: 2px solid var(--secondary);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            max-width: 500px;
            width: 100%;
        }
        
        body[data-theme="dark"] .onboarding-text {
            background: var(--sidebar-bg-dark);
            border-color: var(--sidebar-border-dark);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            color: var(--text-dark);
        }
        
        .onboarding-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(90deg, #009CFC 0%, #A0AAFF 50%, #C97FFD 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .onboarding-description {
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }
        
        .onboarding-text .hubble-gradient {
            font-size: inherit;
            font-weight: inherit;
            margin: 0;
            letter-spacing: normal;
            background: linear-gradient(90deg, #009CFC 0%, #A0AAFF 50%, #C97FFD 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            display: inline;
        }
        
        .onboarding-proceed-btn {
            background: linear-gradient(135deg, #009CFC, #0088e5);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 156, 252, 0.3);
        }
        
        .onboarding-proceed-btn:hover {
            background: linear-gradient(135deg, #0088e5, #0077d1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 156, 252, 0.4);
        }
        
        .onboarding-progress-bar {
            position: relative;
            width: 400px;
            max-width: 40vw;
            min-width: 200px;
            height: 38px;
            border-radius: 8px;
            border: 1.5px solid var(--secondary);
            background: #ffffff;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            opacity: 1;
            visibility: visible;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body[data-theme="dark"] .onboarding-progress-bar {
            background: #232a3a;
            border: 1.5px solid var(--sidebar-border-dark);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .onboarding-progress-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .onboarding-progress-track {
            width: 85%;
            height: 8px;
            background: rgba(160, 170, 255, 0.3);
            border-radius: 4px;
            position: relative;
        }
        
        .onboarding-progress-fill {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #009CFC 0%, #A0AAFF 25%, #C97FFD 50%, #009CFC 75%, #A0AAFF 100%);
            background-size: 400% 100%;
            border-radius: 4px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            animation: hubble-gradient-flow 12s linear infinite;
            position: relative;
        }
        
        .onboarding-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light);
            text-align: center;
            z-index: 2;
            background: rgba(255, 255, 255, 0.95);
            padding: 4px 10px;
            border-radius: 6px;
            border: 1px solid rgba(160, 170, 255, 0.2);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        body[data-theme="dark"] .onboarding-progress-text {
            color: var(--text-dark);
            background: rgba(35, 42, 58, 0.95);
            border: 1px solid rgba(160, 170, 255, 0.3);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .onboarding-gift-small {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            z-index: 3;
        }
        
        
        .onboarding-progress-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .onboarding-progress-track {
            width: 85%;
            height: 8px;
            background: rgba(160, 170, 255, 0.3);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(160, 170, 255, 0.4);
        }
        
        body[data-theme="dark"] .onboarding-progress-track {
            background: rgba(160, 170, 255, 0.1);
            border: 1px solid rgba(160, 170, 255, 0.2);
        }
        
        .onboarding-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #009CFC 0%, #A0AAFF 25%, #C97FFD 50%, #009CFC 75%, #A0AAFF 100%);
            background-size: 400% 100%;
            border-radius: 4px;
            animation: hubble-gradient-flow 12s linear infinite;
            position: relative;
        }
        
        .onboarding-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light);
            text-align: center;
            z-index: 2;
            background: rgba(255, 255, 255, 0.95);
            padding: 4px 10px;
            border-radius: 6px;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(0, 0, 0, 0.2);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        body[data-theme="dark"] .onboarding-progress-text {
            color: var(--text-dark);
            background: rgba(35, 42, 58, 0.95);
            border: 1px solid rgba(160, 170, 255, 0.3);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .onboarding-gift-small {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            animation: gift-bounce 2s ease-in-out infinite;
        }
        .profile-area {
            display: flex;
            align-items: center;
            margin-right: 2.2rem;
            gap: 0.7rem;
            position: relative;
            z-index: 10002;
        }
        .profile-label {
            color: inherit;
            font-size: 1.08rem;
            font-weight: 500;
            letter-spacing: 0.5px;
            -webkit-user-select: none;
            user-select: none;
        }
        .profile-icon {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            transition: transform 0.18s, box-shadow 0.18s;
            position: relative;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
        }
        .profile-icon::before {
            content: attr(data-initial);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            font-weight: 600;
            font-size: 1rem;
        }
        .profile-icon:hover {
            transform: scale(1.08) rotate(-8deg);
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
        }
        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: #ffffff;
            border: 1px solid var(--secondary);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 150px;
            z-index: 10003;
            display: none;
            overflow: hidden;
        }
        body[data-theme="dark"] .profile-dropdown {
            background: #232a3a;
            border-color: #2c3550;
        }
        .dropdown-item {
            padding: 0.8rem 1rem;
            color: #222222;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.95rem;
        }
        body[data-theme="dark"] .dropdown-item {
            color: #f7f8fa;
        }
        .dropdown-item:hover {
            background: rgba(0, 156, 252, 0.1);
        }
        .dropdown-item.logout {
            color: #d32f2f;
        }
        .dropdown-item.logout:hover {
            background: rgba(211, 47, 47, 0.1);
        }
        body[data-theme="dark"] .dropdown-item.logout {
            color: #ff5252;
        }
        body[data-theme="dark"] .dropdown-item.logout:hover {
            background: rgba(255, 82, 82, 0.1);
        }
        .layout {
            display: flex;
            margin-top: 56px;
            height: calc(100vh - 56px);
        }
        .main-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: var(--main-content-light);
            transition: background-color 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }
        body[data-theme="dark"] .main-content {
            background: var(--main-content-dark);
        }
        
        /* Theme toggle button */
        .theme-toggle {
            position: fixed;
            right: 2.2rem;
            bottom: 2.2rem;
            z-index: 100;
            background: #fff;
            color: #222;
            border: 2px solid var(--secondary);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.10);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(1);
        }
        .theme-toggle:hover {
            background: var(--accent);
            color: #fff;
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .theme-toggle:active {
            transform: scale(0.9) rotate(0deg);
            transition: all 0.1s ease-out;
        }
        body[data-theme="dark"] .theme-toggle {
            background: #232a3a;
            color: #f7f8fa;
            border: 2px solid var(--sidebar-border-dark);
        }
        body[data-theme="dark"] .theme-toggle:hover {
            background: var(--accent);
            color: #fff;
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }
        
        /* Bug button */
        .bug-button {
            position: fixed;
            left: 2.2rem;
            bottom: 2.2rem;
            z-index: 100;
            background: #fff;
            color: #222;
            border: 2px solid var(--secondary);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.10);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(1);
        }
        .bug-button:hover {
            background: var(--primary);
            color: #fff;
            transform: scale(1.1) rotate(-15deg);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .bug-button:active {
            transform: scale(0.9) rotate(0deg);
            transition: all 0.1s ease-out;
        }
        body[data-theme="dark"] .bug-button {
            background: #232a3a;
            color: #f7f8fa;
            border: 2px solid var(--sidebar-border-dark);
        }
        body[data-theme="dark"] .bug-button:hover {
            background: var(--primary);
            color: #fff;
            transform: scale(1.1) rotate(-15deg);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }
        
        /* Hide buttons when game is open */
        .game-fullscreen .theme-toggle,
        .game-fullscreen .bug-button {
            display: none;
        }
        
        /* Help Popup Styles */
        .help-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10005;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .help-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        body[data-theme="dark"] .help-popup-overlay {
            backdrop-filter: blur(2px);
        }
        
        .help-popup {
            background: var(--background-light);
            color: var(--text-light);
            padding: 2.5rem;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            border: 2px solid var(--secondary);
            transition: all 0.3s ease;
            transform: scale(0.8) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .help-popup-overlay.show .help-popup {
            transform: scale(1) translateY(0);
        }
        
        body[data-theme="dark"] .help-popup {
            background: var(--sidebar-bg-dark);
            color: var(--text-dark);
            border-color: var(--sidebar-border-dark);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        
        .help-popup-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(90deg, #009CFC 0%, #A0AAFF 50%, #C97FFD 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .help-popup-text {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            color: var(--text-light);
        }
        
        body[data-theme="dark"] .help-popup-text {
            color: var(--text-dark);
        }
        
        .help-popup-buttons {
            display: flex;
            gap: 1.2rem;
            justify-content: center;
            align-items: center;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }
        
        /* Bug popup styles */
        .bug-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 107, 107, 0.1);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .bug-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        body[data-theme="dark"] .bug-popup-overlay {
            background: rgba(255, 107, 107, 0.15);
            backdrop-filter: blur(2px);
        }
        
        .bug-popup {
            background: var(--background-light);
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(255, 107, 107, 0.3);
            border: 2px solid #ff6b6b;
            transition: all 0.3s ease;
            transform: scale(0.8) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .bug-popup-overlay.show .bug-popup {
            transform: scale(1) translateY(0);
        }
        
        body[data-theme="dark"] .bug-popup {
            background: var(--sidebar-bg-dark);
            border-color: #ff5252;
        }
        
        .bug-popup-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #ff6b6b;
            text-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
        }
        
        body[data-theme="dark"] .bug-popup-title {
            color: #ff5252;
        }
        
        .bug-popup-text {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-light);
            margin-bottom: 2rem;
        }
        
        body[data-theme="dark"] .bug-popup-text {
            color: var(--text-dark);
        }
        
        .bug-popup-buttons {
            display: flex;
            gap: 1.2rem;
            justify-content: center;
            align-items: center;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }
        
        .bug-popup-btn {
            padding: 0.9rem 1.8rem;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .bug-popup-btn.create {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        .bug-popup-btn.create:hover {
            background: linear-gradient(135deg, #ee5a24, #d63031);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }
        
        .bug-popup-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.3s ease;
        }
        
        .bug-popup-close:hover {
            color: var(--primary);
        }
        
        body[data-theme="dark"] .bug-popup-close {
            color: var(--text-dark);
        }
        
        /* Bug Ticket Popup Styles */
        .bug-ticket-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 107, 107, 0.1);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .bug-ticket-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        body[data-theme="dark"] .bug-ticket-popup-overlay {
            background: rgba(255, 107, 107, 0.15);
            backdrop-filter: blur(2px);
        }
        
        .bug-ticket-popup {
            background: var(--background-light);
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(255, 107, 107, 0.3);
            border: 2px solid #ff6b6b;
            transition: all 0.3s ease;
            transform: scale(0.8) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .bug-ticket-popup-overlay.show .bug-ticket-popup {
            transform: scale(1) translateY(0);
        }
        
        body[data-theme="dark"] .bug-ticket-popup {
            background: var(--sidebar-bg-dark);
            border-color: #ff5252;
        }
        
        .bug-ticket-popup-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #ff6b6b;
            text-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
        }
        
        body[data-theme="dark"] .bug-ticket-popup-title {
            color: #ff5252;
        }
        
        /* Game Suggestion Popup Styles */
        .game-suggestion-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 215, 0, 0.1);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .game-suggestion-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        body[data-theme="dark"] .game-suggestion-popup-overlay {
            background: rgba(255, 215, 0, 0.15);
            backdrop-filter: blur(2px);
        }
        
        .game-suggestion-popup {
            background: var(--background-light);
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(255, 215, 0, 0.3);
            border: 2px solid #ffd700;
            transition: all 0.3s ease;
            transform: scale(0.8) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .game-suggestion-popup-overlay.show .game-suggestion-popup {
            transform: scale(1) translateY(0);
        }
        
        body[data-theme="dark"] .game-suggestion-popup {
            background: var(--sidebar-bg-dark);
            border-color: #ffed4e;
        }
        
        .game-suggestion-popup-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #ffd700;
            text-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
        }
        
        body[data-theme="dark"] .game-suggestion-popup-title {
            color: #ffed4e;
        }
        
        /* Error text styling for all popups */
        .popup-error-text {
            color: #ff4444;
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            padding: 0.5rem;
            background: rgba(255, 68, 68, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 68, 68, 0.2);
        }
        
        body[data-theme="dark"] .popup-error-text {
            color: #ff6666;
            background: rgba(255, 68, 68, 0.15);
            border-color: rgba(255, 68, 68, 0.3);
        }
        
        .help-popup-btn {
            padding: 0.9rem 1.8rem;
            border: none;
            border-radius: 25px;
            font-size: 1.05rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 140px;
        }
        
        .help-popup-btn.create {
            background: linear-gradient(135deg, #009CFC, #0088e5);
            box-shadow: 0 4px 15px rgba(0, 156, 252, 0.3);
        }
        
        .help-popup-btn.create:hover {
            background: linear-gradient(135deg, #0088e5, #0077d1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 156, 252, 0.4);
        }
        
        .help-popup-btn.faq {
            background: linear-gradient(135deg, #A0AAFF, #8b9cff);
            box-shadow: 0 4px 15px rgba(160, 170, 255, 0.3);
        }
        
        .help-popup-btn.faq:hover {
            background: linear-gradient(135deg, #8b9cff, #7a8eff);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(160, 170, 255, 0.4);
        }
        
        .help-popup-close {
            background: #1565C0;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 1.5rem;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(21, 101, 192, 0.3);
        }
        
        .help-popup-close:hover {
            background: #0D47A1;
            transform: scale(1.08);
            box-shadow: 0 6px 20px rgba(13, 71, 161, 0.4);
        }
        
        /* Ticket Creation Popup */
        .ticket-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10006;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .ticket-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        body[data-theme="dark"] .ticket-popup-overlay {
            backdrop-filter: blur(2px);
        }
        
        .ticket-popup {
            background: var(--background-light);
            color: var(--text-light);
            padding: 2.5rem;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: 2px solid var(--secondary);
            transition: all 0.3s ease;
            transform: scale(0.8) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .ticket-popup-overlay.show .ticket-popup {
            transform: scale(1) translateY(0);
        }
        
        body[data-theme="dark"] .ticket-popup {
            background: var(--sidebar-bg-dark);
            color: var(--text-dark);
            border-color: var(--sidebar-border-dark);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        
        .ticket-popup-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
            background: linear-gradient(90deg, #009CFC 0%, #A0AAFF 50%, #C97FFD 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .ticket-form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        
        .ticket-form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-light);
        }
        
        body[data-theme="dark"] .ticket-form-label {
            color: var(--text-dark);
        }
        
        .ticket-form-input,
        .ticket-form-textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--secondary);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--background-light);
            color: var(--text-light);
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        
        .ticket-form-input:focus,
        .ticket-form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        body[data-theme="dark"] .ticket-form-input,
        body[data-theme="dark"] .ticket-form-textarea {
            background: var(--sidebar-bg-dark);
            color: var(--text-dark);
            border-color: var(--sidebar-border-dark);
        }
        
        .ticket-form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .ticket-form-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }
        
        .ticket-form-btn {
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ticket-form-btn.send {
            background: linear-gradient(135deg, #009CFC, #0088e5);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 156, 252, 0.3);
        }
        
        .ticket-form-btn.send:hover {
            background: linear-gradient(135deg, #0088e5, #0077d1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 156, 252, 0.4);
        }
        
        .ticket-form-btn.cancel {
            background: #6c757d;
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }
        
        .ticket-form-btn.cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }
        
        /* FAQ Popup */
        .faq-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10007;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .faq-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        body[data-theme="dark"] .faq-popup-overlay {
            backdrop-filter: blur(2px);
        }
        
        .faq-popup {
            background: var(--background-light);
            color: var(--text-light);
            padding: 2.5rem;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            border: 2px solid var(--secondary);
            transition: all 0.3s ease;
            transform: scale(0.8) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .faq-popup-overlay.show .faq-popup {
            transform: scale(1) translateY(0);
        }
        
        body[data-theme="dark"] .faq-popup {
            background: var(--sidebar-bg-dark);
            color: var(--text-dark);
            border-color: var(--sidebar-border-dark);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        
        .faq-popup-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
            background: linear-gradient(90deg, #009CFC 0%, #A0AAFF 50%, #C97FFD 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .faq-item {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        
        .faq-question {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        
        .faq-answer {
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-light);
            padding-left: 1rem;
        }
        
        body[data-theme="dark"] .faq-answer {
            color: var(--text-dark);
        }
        
        /* Games Section */
        .games-container {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
            min-height: 400px;
            background: transparent;
        }
        
        body[data-theme="dark"] .games-container {
            background: transparent;
        }
        
        .games-search-section {
            margin-bottom: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            position: relative;
            gap: 1rem;
        }
        
        
        .games-search-bar {
            width: 100%;
            max-width: 500px;
            padding: 1rem 1.5rem;
            border: 3px solid transparent;
            border-radius: 30px;
            font-size: 1.1rem;
            background: 
                linear-gradient(var(--background-light), var(--background-light)) padding-box,
                linear-gradient(90deg, #009CFC 0%, #A0AAFF 25%, #C97FFD 50%, #009CFC 75%, #A0AAFF 100%) border-box;
            background-size: 100% 100%, 400% 100%;
            color: var(--text-light);
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            box-shadow: 0 4px 15px rgba(201, 127, 253, 0.1);
            animation: hubble-gradient-flow 12s linear infinite;
            position: relative;
        }
        
        @keyframes hubble-gradient-flow {
            0% { background-position: 0% 0%, 0% 0%; }
            100% { background-position: 0% 0%, 400% 0%; }
        }
        
        .games-search-bar.paused {
            animation-play-state: paused;
        }
        
        .games-search-bar:focus {
            box-shadow: 0 0 0 4px rgba(0, 156, 252, 0.15), 0 8px 25px rgba(201, 127, 253, 0.2);
            transform: translateY(-2px);
            background: 
                linear-gradient(#ffffff, #f8fbff) padding-box,
                linear-gradient(90deg, #009CFC 0%, #A0AAFF 25%, #C97FFD 50%, #009CFC 75%, #A0AAFF 100%) border-box;
        }
        
        .games-search-bar::placeholder {
            color: var(--primary);
            opacity: 0.7;
            font-weight: 500;
        }
        
        body[data-theme="dark"] .games-search-bar {
            background: 
                linear-gradient(#232a3a, #1a1f2e) padding-box,
                linear-gradient(90deg, #009CFC 0%, #A0AAFF 25%, #C97FFD 50%, #009CFC 75%, #A0AAFF 100%) border-box;
            background-size: 100% 100%, 400% 100%;
            color: #f7f8fa;
            box-shadow: 0 4px 15px rgba(201, 127, 253, 0.15);
            animation: hubble-gradient-flow 12s linear infinite;
        }
        
        body[data-theme="dark"] .games-search-bar:focus {
            background: 
                linear-gradient(#2a3142, #1e2332) padding-box,
                linear-gradient(90deg, #009CFC 0%, #A0AAFF 25%, #C97FFD 50%, #009CFC 75%, #A0AAFF 100%) border-box;
            box-shadow: 0 0 0 4px rgba(0, 156, 252, 0.2), 0 8px 25px rgba(201, 127, 253, 0.25);
        }
        
        body[data-theme="dark"] .games-search-bar::placeholder {
            color: var(--accent);
            opacity: 0.8;
        }
        
        /* Game Suggestion Button */
        .game-suggestion-btn {
            width: 50px;
            height: 50px;
            border: 3px solid #ff8c00;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .game-suggestion-btn:hover {
            background: linear-gradient(135deg, #ffed4e, #ffd700);
            border-color: #ff6b35;
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }
        
        .game-suggestion-btn:active {
            transform: scale(0.95) rotate(0deg);
            transition: all 0.1s ease-out;
        }
        
        body[data-theme="dark"] .game-suggestion-btn {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            border-color: #ff8c00;
        }
        
        body[data-theme="dark"] .game-suggestion-btn:hover {
            background: linear-gradient(135deg, #ffed4e, #ffd700);
            border-color: #ff6b35;
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
        }
        
        .games-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-top: 1rem;
            min-height: 200px;
        }
        
        .games-loading {
            grid-column: 1 / -1;
            text-align: center;
            color: var(--secondary);
            font-size: 1.1rem;
            padding: 2rem;
            font-style: italic;
        }
        
        .game-card {
            background: transparent;
            border-radius: 16px;
            padding: 0;
            box-shadow: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
        }
        
        .game-card:hover {
            transform: translateY(-2px);
            box-shadow: none;
        }
        
        body[data-theme="dark"] .game-card {
            background: transparent;
            border: none;
            box-shadow: none;
        }
        
        body[data-theme="dark"] .game-card:hover {
            box-shadow: none;
        }
        
        .game-image {
            width: 100%;
            height: 180px;
            border-radius: 12px;
            object-fit: cover;
            margin-bottom: 0.1rem;
            background: var(--background-light);
            border: 2px solid var(--secondary);
            transition: border-color 0.3s ease;
            flex-shrink: 0;
            display: block;
        }
        
        .game-image-placeholder {
            width: 100%;
            height: 180px;
            border-radius: 12px;
            margin-bottom: 0.1rem;
            border: 2px solid var(--secondary);
            transition: border-color 0.3s ease;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        
        .game-image-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--placeholder-bg, #FF6384), var(--placeholder-bg-secondary, #FF8FA3));
            z-index: -1;
        }
        
        .game-image-placeholder::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: placeholder-shine 3s ease-in-out infinite;
            z-index: 0;
        }
        
        @keyframes placeholder-shine {
            0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .game-image-placeholder .placeholder-text {
            position: relative;
            z-index: 1;
            text-align: center;
            line-height: 1;
        }
        
        body[data-theme="dark"] .game-image {
            background: #232a3a;
            border-color: #2c3550;
        }
        
        body[data-theme="dark"] .game-image-placeholder {
            border-color: #2c3550;
        }
        
        body[data-theme="dark"] .game-image-placeholder::before {
            background: linear-gradient(135deg, var(--placeholder-bg, #4A5568), var(--placeholder-bg-secondary, #2D3748));
        }
        
        .game-card:hover .game-image {
            border-color: var(--primary);
        }
        
        .game-card:hover .game-image-placeholder {
            border-color: var(--primary);
        }
        
        .game-name {
            color: var(--text-light);
            font-size: 1.4rem;
            font-weight: 600;
            text-align: center;
            margin: 0;
            line-height: 1.2;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
        }
        
        body[data-theme="dark"] .game-name {
            color: var(--text-dark);
        }
        /* Coming Soon Game Card */
.game-card.coming-soon {
    position: relative;
    background: transparent;
    border-radius: 16px;
    padding: 0;
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    cursor: default;
}

.game-card.coming-soon .game-image-placeholder {
    width: 100%;
    height: 180px;
    border-radius: 12px;
    border: 2px dashed var(--secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    font-weight: bold;
    color: var(--secondary);
    background: rgba(0,0,0,0.3);
    text-transform: uppercase;
    letter-spacing: 2px;
}

/* Optional hover effect for "Coming Soon" */
.game-card.coming-soon:hover .game-image-placeholder {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,0,0,0.4);
}

/* Coming Soon Overlay for games with images */
.game-card.coming-soon .game-image {
    width: 100%;
    height: 180px;
    border-radius: 12px;
    object-fit: cover;
    margin-bottom: 0.1rem;
    border: 2px solid var(--secondary);
    background: rgba(0,0,0,0.3);
    transition: border-color 0.3s ease;
    flex-shrink: 0;
    display: block;
    position: relative;
    overflow: hidden;
}

.game-card.coming-soon .game-image::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: placeholder-shine 3s ease-in-out infinite;
    z-index: 0;
    pointer-events: none;
}

.game-card.coming-soon::after {
    content: 'Coming Soon';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 1rem;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    z-index: 10;
    pointer-events: none;
    border: 2px solid var(--accent);
}


        
        /* Game Fullscreen */
        .game-fullscreen {
            position: fixed;
            top: 56px;
            left: 0;
            width: 100%;
            height: calc(100vh - 56px);
            background: var(--background-light);
            z-index: 9999;
            display: none;
            flex-direction: column;
        }
        
        .game-fullscreen.tab-fullscreen {
            top: 0;
            height: 100vh;
        }
        
        body[data-theme="dark"] .game-fullscreen {
            background: #0a0e1a;
        }
        
        .game-content {
            flex: 1;
            width: 100%;
            height: 100%;
            border: none;
            background: var(--background-light);
        }
        
        body[data-theme="dark"] .game-content {
            background: #1a1f2e;
        }
        
        .topbar.game-mode .hubble-gradient {
            background: linear-gradient(90deg, #009CFC 0%, #A0AAFF 50%, #C97FFD 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
        
        /* Game mode forces dark theme for header */
        .topbar.game-mode {
            background: #20263a;
            box-shadow: 0 2px 12px rgba(0,0,0,0.13);
        }
        
        .topbar.game-mode .profile-label,
        .topbar.game-mode .profile-icon {
            color: #f7f8fa;
        }
        
        .game-controls {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 1rem;
            z-index: 1000;
        }
        
        .game-fullscreen-btn {
            width: 200px;
            max-width: 20vw;
            min-width: 120px;
            border: 1.5px solid #1565C0;
            border-radius: 25px;
            font-size: 1.08rem;
            padding: 0.5rem 1.1rem;
            background: #1565C0;
            color: white;
            outline: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .game-fullscreen-btn:hover {
            background: #0D47A1;
            border-color: #0D47A1;
            transform: scale(1.05);
        }
        
        .game-fullscreen-btn.minimized {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 100px;
            min-width: 100px;
            max-width: 100px;
            font-size: 0.9rem;
            padding: 0.4rem 0.8rem;
            transform: none;
            z-index: 10000;
        }
        
        .game-fullscreen-btn.minimized.true-fullscreen {
            left: 140px; /* Position next to the back button (100px width + 20px margin) */
        }
        
        .game-exit-btn {
            width: 200px;
            max-width: 20vw;
            min-width: 120px;
            border: 1.5px solid #f44336;
            border-radius: 25px;
            font-size: 1.08rem;
            padding: 0.5rem 1.1rem;
            background: #f44336;
            color: white;
            outline: none;
            cursor: pointer;
            transition: all 0.18s ease;
        }
        
        .game-exit-btn:hover {
            background: #d32f2f;
            border-color: #d32f2f;
            transform: scale(1.05);
        }
        
        @media (max-width: 1200px) {
            .games-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 900px) {
            .main-content { 
                padding: 1.2rem 0.7rem; 
            }
            .hubble-gradient { 
                margin-left: 1rem; 
                font-size: 1.3rem; 
            }
            .profile-area { 
                margin-right: 1rem; 
            }
            .games-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .search-bar-custom {
                width: 200px;
                max-width: 35vw;
                min-width: 100px;
            }
            .registration-progress-bar {
                width: 200px;
                max-width: 35vw;
                min-width: 100px;
            }
        }
        
        @media (max-width: 600px) {
            .main-content { 
                padding: 1rem 0.2rem; 
            }
            .games-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .search-bar-custom {
                width: 150px;
                max-width: 30vw;
                min-width: 80px;
            }
            .registration-progress-bar {
                width: 150px;
                max-width: 30vw;
                min-width: 80px;
            }
            .theme-toggle { right: 1rem; bottom: 1rem; }
            .bug-button { left: 1rem; bottom: 1rem; }
        }
        
        /* Username Change Popup Styles */
        .customization-popup {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 10004;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .customization-popup.show {
            opacity: 1;
            visibility: visible;
        }
        .customization-popup-bg {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .customization-popup.show .customization-popup-bg {
            opacity: 1;
        }
        .customization-popup-content {
            position: relative;
            background: #fff;
            color: #222;
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            z-index: 2;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            transform: scale(0.8) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .customization-popup.show .customization-popup-content {
            transform: scale(1) translateY(0);
        }
        body[data-theme="dark"] .customization-popup-content {
            background: #232a3a;
            color: #f7f8fa;
        }
        .customization-popup-content h3 {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .popup-input-group {
            margin-bottom: 1.2rem;
        }
        .popup-input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: inherit;
        }
        .popup-input-group input {
            width: 100%;
            padding: 0.8rem;
            border: 1.5px solid var(--secondary);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--background-light);
            color: var(--text-light);
            box-sizing: border-box;
        }
        .popup-input-group input:focus {
            border-color: var(--primary);
            outline: none;
        }
        body[data-theme="dark"] .popup-input-group input {
            background: #232a3a;
            color: #f7f8fa;
            border-color: #2c3550;
        }
        .popup-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .popup-btn {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.18s;
        }
        .popup-btn.secondary {
            background: #e0e6f7;
            color: var(--primary);
        }
        .popup-btn.primary {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            color: #fff;
        }
        .popup-btn:hover {
            transform: scale(1.02);
        }
        .popup-btn.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .confirmation-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        body[data-theme="dark"] .confirmation-message {
            background: #2d2a1a;
            border-color: #4a3f1a;
            color: #f7f8fa;
        }
        .confirmation-message p {
            margin: 0.5rem 0;
        }
        .confirmation-message p:first-child {
            margin-top: 0;
        }
        .confirmation-message p:last-child {
            margin-bottom: 0;
        }
        .timer-circle {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            margin-right: 0.5rem;
        }
        .timer-svg {
            position: absolute;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        .timer-bg {
            fill: none;
            stroke: rgba(255,255,255,0.3);
            stroke-width: 2;
            stroke-dasharray: 100 100;
        }
        .timer-progress {
            fill: none;
            stroke: #fff;
            stroke-width: 2;
            stroke-dasharray: 0 100;
            transition: stroke-dasharray 0.1s linear;
        }
        .timer-text {
            font-size: 0.8rem;
            font-weight: 700;
            color: #fff;
        }
        
        /* Customization Notifications */
        .customization-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10001;
            font-weight: 600;
            animation: slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes slideInRight {
            from {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="topbar">
        <span class="hubble-gradient">Hubble<span class="alpha-badge" id="alpha-badge">Alpha</span></span>
        <div id="registration-progress-bar" class="registration-progress-bar">
            <div class="progress-bar-container">
                <div class="progress-bar-track">
                    <div class="progress-bar-fill" id="progress-bar-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Loading...</div>
                <div class="gift-emoji">🎁</div>
            </div>
        </div>
        <span class="profile-area">
            <span class="profile-label" id="profile-label">User</span>
            <span class="profile-icon" id="profile-icon" data-initial="U"></span>
            <div class="profile-dropdown" id="profile-dropdown">
                <button class="dropdown-item" id="change-username-btn">Change Username</button>
                <button class="dropdown-item logout" id="logout-btn">Logout</button>
            </div>
        </span>
    </div>
    <div class="layout">
        <main class="main-content" id="main-content">
            <div class="games-container">
                <div class="games-search-section">
                    <input type="text" id="games-search" class="games-search-bar" placeholder="Search through our games..." autocomplete="off">
                    <button class="game-suggestion-btn" id="game-suggestion-btn" title="Suggest a Game">💡</button>
                </div>
                <div class="games-grid" id="games-grid">
                    <div class="games-loading">Loading games...</div>
                </div>
            </div>
        </main>
    </div>
    <button class="theme-toggle" id="theme-toggle" title="Toggle light/dark mode">🌙</button>
    <button class="bug-button" id="bug-button" title="Report Bug">🐛</button>
    
    <!-- Bug Report Popup -->
    <div class="bug-popup-overlay" id="bug-popup-overlay">
        <div class="bug-popup">
            <h2 class="bug-popup-title">🐛 Report a Bug</h2>
            <p class="bug-popup-text">Click Create below to create a bug ticket. This will help us identify and fix issues in the system. Please provide as much detail as possible about the bug you encountered.</p>
            <div class="bug-popup-buttons">
                <button class="bug-popup-btn create" onclick="showBugTicketPopup()">Create Bug Ticket</button>
            </div>
            <button class="bug-popup-close" onclick="closeBugPopup()">×</button>
        </div>
    </div>
    
    <!-- Ticket Creation Popup -->
    <div class="ticket-popup-overlay" id="ticket-popup-overlay">
        <div class="ticket-popup">
            <h2 class="ticket-popup-title" id="ticket-popup-title">Create Support Ticket</h2>
            <div id="ticket-error-text" class="popup-error-text" style="display: none;"></div>
            <div id="ticket-form-content">
                <div class="ticket-form-group">
                    <label for="ticket-subject" class="ticket-form-label">Subject</label>
                    <input type="text" id="ticket-subject" class="ticket-form-input" placeholder="Brief description of your issue">
                </div>
                <div class="ticket-form-group">
                    <label for="ticket-description" class="ticket-form-label">Describe the Issue</label>
                    <textarea id="ticket-description" class="ticket-form-textarea" placeholder="Please provide detailed information about your issue..."></textarea>
                </div>
                <div class="ticket-form-group">
                    <label for="ticket-email" class="ticket-form-label">Account Email</label>
                    <input type="email" id="ticket-email" class="ticket-form-input" placeholder="1XXXXXX@lwsd.org">
                </div>
                <div class="ticket-form-buttons">
                    <button class="ticket-form-btn cancel" onclick="closeTicketPopup()">Cancel</button>
                    <button class="ticket-form-btn send" onclick="sendTicket()">Send</button>
                </div>
            </div>
            <div id="ticket-sent-content" style="display: none; text-align: center;">
                <h3 style="color: var(--primary); margin-bottom: 1rem;">Ticket Sent!</h3>
                <p style="margin-bottom: 2rem;">Our support team will get to you shortly.</p>
                <button class="ticket-form-btn send" onclick="closeAllPopups()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Bug Ticket Creation Popup -->
    <div class="bug-ticket-popup-overlay" id="bug-ticket-popup-overlay">
        <div class="bug-ticket-popup">
            <h2 class="bug-ticket-popup-title" id="bug-ticket-popup-title">🐛 Report a Bug</h2>
            <div id="bug-ticket-error-text" class="popup-error-text" style="display: none;"></div>
            <div id="bug-ticket-form-content">
                <div class="ticket-form-group">
                    <label for="bug-ticket-subject" class="ticket-form-label">Bug Title</label>
                    <input type="text" id="bug-ticket-subject" class="ticket-form-input" placeholder="Brief description of the bug">
                </div>
                <div class="ticket-form-group">
                    <label for="bug-ticket-description" class="ticket-form-label">Bug Description</label>
                    <textarea id="bug-ticket-description" class="ticket-form-textarea" placeholder="Please provide detailed information about the bug, including steps to reproduce it..."></textarea>
                </div>
                <div class="ticket-form-buttons">
                    <button class="ticket-form-btn cancel" onclick="closeBugTicketPopup()">Cancel</button>
                    <button class="ticket-form-btn send" onclick="sendBugTicket()">Send Bug Report</button>
                </div>
            </div>
            <div id="bug-ticket-sent-content" style="display: none; text-align: center;">
                <h3 style="color: #ff6b6b; margin-bottom: 1rem;">Bug Report Sent!</h3>
                <p style="margin-bottom: 2rem;">Thank you for reporting this bug. Our development team will investigate and fix it.</p>
                <button class="ticket-form-btn send" onclick="closeAllPopups()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- FAQ Popup -->
    <div class="faq-popup-overlay" id="faq-popup-overlay">
        <div class="faq-popup">
            <h2 class="faq-popup-title">Frequently Asked Questions</h2>
            
            <!-- Not Getting Verification Email -->
            <div class="faq-item">
                <div class="faq-question">I'm not receiving my verification email. What should I do?</div>
                <div class="faq-answer">
                    Please wait a few minutes, as the email may take some time to arrive. 
                    If you still haven't received it, click the "Resend Email" button on the verification page.
                </div>
            </div>

            <!-- Username Being Used by Pending Account -->
            <div class="faq-item">
                <div class="faq-question">Why does it say my username is being used by a pending account?</div>
                <div class="faq-answer">
                    This happens when someone started creating an account with that username but didn't complete the verification process. 
                    The system automatically cleans up abandoned registrations after 2 hours.
                    <br><br>
                    <strong>Solutions:</strong>
                    <br>• Wait 2 hours and try again
                    <br>• Try a different username
                    <br>• Clear your browser's site data and refresh the page
                    <br>• If you see "failed registration during cleanup" - this is normal and the system will still work
                    <br><br>
                    If the issue persists after 2 hours, please report it through our <strong>Create Ticket</strong> section.
                </div>
            </div>

            <!-- Email Already Used -->
            <div class="faq-item">
                <div class="faq-question">Why does it say my email is already associated with another account?</div>
                <div class="faq-answer">
                    This can happen if you previously started creating an account but didn't complete email verification. 
                    The system now automatically handles abandoned unverified accounts.
                    <br><br>
                    <strong>Solutions:</strong>
                    <br>• Try creating your account again - the system will automatically clean up any abandoned accounts
                    <br>• If you remember creating an account before, try signing in instead
                    <br>• If the issue persists, create a support ticket with your email address
                    <br><br>
                    The system automatically removes abandoned unverified accounts to prevent this issue.
                </div>
            </div>

            <!-- Forgot Password -->
            <div class="faq-item">
                <div class="faq-question">I forgot my password. What should I do?</div>
                <div class="faq-answer">
                    Click "Forgot password?" on the login page and enter your LWSD email address. 
                    You'll receive a password reset link in your email.
                </div>
            </div>

            <!-- Change Theme -->
            <div class="faq-item">
                <div class="faq-question">How do I change my theme (light/dark mode)?</div>
                <div class="faq-answer">
                    Click the theme toggle button in the bottom right corner of the screen to switch between light and dark modes.
                </div>
            </div>

            <!-- Fullscreen Games -->
            <div class="faq-item">
                <div class="faq-question">Can I play games in fullscreen?</div>
                <div class="faq-answer">
                    Yes, but only the webpage itself will go fullscreen.  
                    When you open a game, you'll see a "Fullscreen" button in the top bar.  
                    You can press the <strong>Escape</strong> key to exit fullscreen mode.
                </div>
            </div>

            <!-- Final Note -->
            <div class="faq-final-note" style="margin-top: 2rem; text-align: center;">
                <h3>If you have any other questions, please feel free to create a support ticket!</h3>
            </div>

            <!-- Close Button -->
            <div style="text-align: center; margin-top: 2rem;">
                <button class="help-popup-close" onclick="closeFAQPopupAndReturnToHelp()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Game Suggestion Popup -->
    <div class="game-suggestion-popup-overlay" id="game-suggestion-popup-overlay">
        <div class="game-suggestion-popup">
            <h2 class="game-suggestion-popup-title" id="game-suggestion-popup-title">💡 Suggest a Game</h2>
            <div id="game-suggestion-error-text" class="popup-error-text" style="display: none;"></div>
            <div id="game-suggestion-form-content">
                <div class="ticket-form-group">
                    <label for="game-suggestion-title" class="ticket-form-label">Game Title</label>
                    <input type="text" id="game-suggestion-title" class="ticket-form-input" placeholder="Enter the name of the game you'd like to suggest">
                </div>
                <div class="ticket-form-group">
                    <label for="game-suggestion-description" class="ticket-form-label">Tell us a bit about the game <span style="color: #888; font-weight: normal;">(Optional)</span></label>
                    <textarea id="game-suggestion-description" class="ticket-form-textarea" placeholder="Tell us about the game so we can know more about what we're adding to Hubble... (Optional)"></textarea>
                </div>
                <div class="ticket-form-group">
                    <label for="game-suggestion-link" class="ticket-form-label">Game Link <span style="color: #888; font-weight: normal;">(If Applicable)</span></label>
                    <input type="url" id="game-suggestion-link" class="ticket-form-input" placeholder="https://example.com/game (Optional)">
                </div>
                <div class="ticket-form-buttons">
                    <button class="ticket-form-btn cancel" onclick="closeGameSuggestionPopup()">Cancel</button>
                    <button class="ticket-form-btn send" onclick="sendGameSuggestion()">Submit Suggestion</button>
                </div>
            </div>
            <div id="game-suggestion-sent-content" style="display: none; text-align: center;">
                <h3 style="color: #ffd700; margin-bottom: 1rem;">Suggestion Submitted!</h3>
                <p style="margin-bottom: 2rem;">Thank you for your game suggestion! We'll review it and consider adding it to Hubble.</p>
                <button class="ticket-form-btn send" onclick="closeAllPopups()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Game Fullscreen Container -->
    <div class="game-fullscreen" id="game-fullscreen">
        <iframe class="game-content" id="game-content" src=""></iframe>
    </div>
    
    <!-- Onboarding Animation -->
    <div class="onboarding-overlay" id="onboarding-overlay">
        <div class="onboarding-gift" id="onboarding-gift">🎁</div>
        <div class="onboarding-container" id="onboarding-container">
            <div class="onboarding-text">
                <h2 class="onboarding-title">Welcome to Hubble's Launch Event!</h2>
                <p class="onboarding-description">
                    This is the first event of <strong><span class="hubble-gradient">Hubble</span></strong>. Help us reach our goal of 100 registered users for the alpha! When we reach this milestone, every registered user will receive an exclusive prize when <strong><span class="hubble-gradient">Hubble</span></strong> officially launches!
                </p>
                <button class="onboarding-proceed-btn" id="onboarding-proceed-btn">Proceed</button>
            </div>
        </div>
    </div>
    
    <!-- Confetti Container -->
    <div class="confetti-container" id="confetti-container"></div>
    
    <script>
        // Bug Report System Functions
        function showBugPopup() {
            const popup = document.getElementById('bug-popup-overlay');
            if (popup) {
                popup.style.display = 'flex';
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
            }
        }
        
        function closeBugPopup() {
            const popup = document.getElementById('bug-popup-overlay');
            if (popup) {
                popup.classList.remove('show');
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 300);
            }
        }
        
        function showBugTicketPopup() {
            closeBugPopup();
            const popup = document.getElementById('bug-ticket-popup-overlay');
            const formContent = document.getElementById('bug-ticket-form-content');
            const sentContent = document.getElementById('bug-ticket-sent-content');
            const errorText = document.getElementById('bug-ticket-error-text');
            
            if (popup) {
                // Reset form and hide error
                document.getElementById('bug-ticket-subject').value = '';
                document.getElementById('bug-ticket-description').value = '';
                errorText.style.display = 'none';
                
                // Show form, hide sent message
                formContent.style.display = 'block';
                sentContent.style.display = 'none';
                
                popup.style.display = 'flex';
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
            }
        }
        
        function showBugTicketPopup() {
            closeBugPopup();
            const popup = document.getElementById('bug-ticket-popup-overlay');
            const formContent = document.getElementById('bug-ticket-form-content');
            const sentContent = document.getElementById('bug-ticket-sent-content');
            const errorText = document.getElementById('bug-ticket-error-text');
            
            if (popup) {
                // Reset form and hide error
                document.getElementById('bug-ticket-subject').value = '';
                document.getElementById('bug-ticket-description').value = '';
                errorText.style.display = 'none';
                
                // Show form, hide sent message
                formContent.style.display = 'block';
                sentContent.style.display = 'none';
                
                popup.style.display = 'flex';
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
            }
        }
        
        function closeBugTicketPopup() {
            const popup = document.getElementById('bug-ticket-popup-overlay');
            if (popup) {
                popup.classList.remove('show');
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 300);
            }
        }
        
        function showTicketPopup() {
            closeBugPopup();
            const popup = document.getElementById('ticket-popup-overlay');
            const formContent = document.getElementById('ticket-form-content');
            const sentContent = document.getElementById('ticket-sent-content');
            const errorText = document.getElementById('ticket-error-text');
            
            if (popup) {
                // Reset form and hide error
                formContent.style.display = 'block';
                sentContent.style.display = 'none';
                document.getElementById('ticket-subject').value = '';
                document.getElementById('ticket-description').value = '';
                document.getElementById('ticket-email').value = '';
                errorText.style.display = 'none';
                
                popup.style.display = 'flex';
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
            }
        }
        
        function closeTicketPopup() {
            const popup = document.getElementById('ticket-popup-overlay');
            if (popup) {
                popup.classList.remove('show');
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 300);
            }
        }
        
        async function sendTicket() {
            const subject = document.getElementById('ticket-subject').value.trim();
            const description = document.getElementById('ticket-description').value.trim();
            const email = document.getElementById('ticket-email').value.trim();
            const errorText = document.getElementById('ticket-error-text');
            
            // Hide any previous error
            errorText.style.display = 'none';
            
            // Basic validation
            if (!subject || !description || !email) {
                errorText.textContent = 'Please fill in all fields.';
                errorText.style.display = 'block';
                return;
            }
            
            // Email validation
            if (!email.includes('@lwsd.org')) {
                errorText.textContent = 'Please enter a valid LWSD email address.';
                errorText.style.display = 'block';
                return;
            }
            
            try {
                console.log('Starting ticket submission...');
                
                // Save ticket to Firebase
                const { getFirestore, collection, addDoc } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { app } = await import('./firebase.js');
                const db = getFirestore(app);
                
                console.log('Firebase modules loaded, creating ticket data...');
                
                const ticketData = {
                    subject: subject,
                    description: description,
                    email: email,
                    timestamp: new Date(),
                    status: 'open',
                    priority: 'normal'
                };
                
                console.log('Ticket data prepared:', ticketData);
                console.log('Attempting to save to Firebase...');
                
                const docRef = await addDoc(collection(db, 'tickets'), ticketData);
                console.log('Ticket saved with ID:', docRef.id);
                
                // Show sent confirmation
                const formContent = document.getElementById('ticket-form-content');
                const sentContent = document.getElementById('ticket-sent-content');
                
                formContent.style.display = 'none';
                sentContent.style.display = 'block';
                
                console.log('Ticket submitted successfully to Firebase');
            } catch (error) {
                console.error('Error submitting ticket:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                // Handle specific error cases
                let errorMessage = 'Failed to submit ticket. Please try again.';
                if (error.code === 'permission-denied' || error.code === 'unavailable') {
                    errorMessage = 'Service temporarily unavailable. Please try again later.';
                } else if (error.message) {
                    errorMessage = `Failed to submit ticket: ${error.message}`;
                }
                
                errorText.textContent = errorMessage;
                errorText.style.display = 'block';
            }
        }
        
        async function sendBugTicket() {
            const subject = document.getElementById('bug-ticket-subject').value.trim();
            const description = document.getElementById('bug-ticket-description').value.trim();
            const errorText = document.getElementById('bug-ticket-error-text');
            
            // Hide any previous error
            errorText.style.display = 'none';
            
            // Basic validation
            if (!subject || !description) {
                errorText.textContent = 'Please fill in all fields.';
                errorText.style.display = 'block';
                return;
            }
            
            if (!currentUser) {
                errorText.textContent = 'You must be logged in to submit a bug report.';
                errorText.style.display = 'block';
                return;
            }
            
            try {
                console.log('Starting bug ticket submission...');
                
                // Save bug ticket to Firebase
                const { getFirestore, collection, addDoc, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { app } = await import('./firebase.js');
                const db = getFirestore(app);
                
                console.log('Firebase modules loaded, getting user data...');
                
                // Get user data from Firestore
                const userQuery = query(collection(db, "users"), where("email", "==", currentUser.email));
                const userDocs = await getDocs(userQuery);
                let username = 'User';
                
                if (!userDocs.empty) {
                    const userData = userDocs.docs[0].data();
                    username = userData.username || 'User';
                }
                
                const bugTicketData = {
                    subject: subject,
                    description: description,
                    email: currentUser.email,
                    username: username,
                    uid: currentUser.uid,
                    timestamp: new Date(),
                    status: 'open',
                    priority: 'normal',
                    type: 'bug'
                };
                
                console.log('Bug ticket data prepared:', bugTicketData);
                console.log('Attempting to save to Firebase...');
                
                const docRef = await addDoc(collection(db, 'bugs'), bugTicketData);
                console.log('Bug ticket saved with ID:', docRef.id);
                
                // Show sent confirmation
                const formContent = document.getElementById('bug-ticket-form-content');
                const sentContent = document.getElementById('bug-ticket-sent-content');
                
                formContent.style.display = 'none';
                sentContent.style.display = 'block';
                
                console.log('Bug ticket submitted successfully to Firebase');
            } catch (error) {
                console.error('Error submitting bug ticket:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                // Handle specific error cases
                let errorMessage = 'Failed to submit bug ticket. Please try again.';
                if (error.code === 'permission-denied' || error.code === 'unavailable') {
                    errorMessage = 'Service temporarily unavailable. Please try again later.';
                } else if (error.message) {
                    errorMessage = `Failed to submit bug ticket: ${error.message}`;
                }
                
                errorText.textContent = errorMessage;
                errorText.style.display = 'block';
            }
        }

        function showFAQPopup() {
            closeBugPopup();
            const popup = document.getElementById('faq-popup-overlay');
            if (popup) {
                popup.style.display = 'flex';
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
            }
        }
        
        function closeFAQPopup() {
            const popup = document.getElementById('faq-popup-overlay');
            if (popup) {
                popup.classList.remove('show');
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 300);
            }
        }
        
        function closeFAQPopupAndReturnToHelp() {
            const popup = document.getElementById('faq-popup-overlay');
            if (popup) {
                popup.classList.remove('show');
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 300);
            }
        }
        
        function closeAllPopups() {
            closeBugPopup();
            closeBugTicketPopup();
            closeTicketPopup();
            closeGameSuggestionPopup();
            closeFAQPopup();
        }
        
        // Game Suggestion Functions
        function showGameSuggestionPopup() {
            const popup = document.getElementById('game-suggestion-popup-overlay');
            const formContent = document.getElementById('game-suggestion-form-content');
            const sentContent = document.getElementById('game-suggestion-sent-content');
            const errorText = document.getElementById('game-suggestion-error-text');
            
            if (popup) {
                // Reset form and hide error
                document.getElementById('game-suggestion-title').value = '';
                document.getElementById('game-suggestion-description').value = '';
                document.getElementById('game-suggestion-link').value = '';
                errorText.style.display = 'none';
                
                // Show form, hide sent message
                formContent.style.display = 'block';
                sentContent.style.display = 'none';
                
                popup.style.display = 'flex';
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
            }
        }
        
        function closeGameSuggestionPopup() {
            const popup = document.getElementById('game-suggestion-popup-overlay');
            if (popup) {
                popup.classList.remove('show');
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 300);
            }
        }
        
        async function sendGameSuggestion() {
            const title = document.getElementById('game-suggestion-title').value.trim();
            const description = document.getElementById('game-suggestion-description').value.trim();
            const link = document.getElementById('game-suggestion-link').value.trim();
            const errorText = document.getElementById('game-suggestion-error-text');
            
            // Hide any previous error
            errorText.style.display = 'none';
            
            // Basic validation - only title is required
            if (!title) {
                errorText.textContent = 'Please enter a game title.';
                errorText.style.display = 'block';
                return;
            }
            
            if (!currentUser) {
                errorText.textContent = 'You must be logged in to submit a game suggestion.';
                errorText.style.display = 'block';
                return;
            }
            
            try {
                console.log('Starting game suggestion submission...');
                
                // Save game suggestion to Firebase
                const { getFirestore, collection, addDoc, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { app } = await import('./firebase.js');
                const db = getFirestore(app);
                
                console.log('Firebase modules loaded, getting user data...');
                
                // Get user data from Firestore
                const userQuery = query(collection(db, "users"), where("email", "==", currentUser.email));
                const userDocs = await getDocs(userQuery);
                let username = 'User';
                
                if (!userDocs.empty) {
                    const userData = userDocs.docs[0].data();
                    username = userData.username || 'User';
                }
                
                const gameSuggestionData = {
                    title: title,
                    description: description || '', // Make description optional
                    link: link || '', // Make link optional
                    email: currentUser.email,
                    username: username,
                    uid: currentUser.uid,
                    timestamp: new Date(),
                    status: 'pending',
                    type: 'game_suggestion'
                };
                
                console.log('Game suggestion data prepared:', gameSuggestionData);
                console.log('Attempting to save to Firebase...');
                
                const docRef = await addDoc(collection(db, 'gamesuggestions'), gameSuggestionData);
                console.log('Game suggestion saved with ID:', docRef.id);
                
                // Show sent confirmation
                const formContent = document.getElementById('game-suggestion-form-content');
                const sentContent = document.getElementById('game-suggestion-sent-content');
                
                formContent.style.display = 'none';
                sentContent.style.display = 'block';
                
                console.log('Game suggestion submitted successfully to Firebase');
            } catch (error) {
                console.error('Error submitting game suggestion:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                // Handle specific error cases
                let errorMessage = 'Failed to submit game suggestion. Please try again.';
                if (error.code === 'permission-denied' || error.code === 'unavailable') {
                    errorMessage = 'Service temporarily unavailable. Please try again later.';
                } else if (error.message) {
                    errorMessage = `Failed to submit game suggestion: ${error.message}`;
                }
                
                errorText.textContent = errorMessage;
                errorText.style.display = 'block';
            }
        }
        
        // Close popups when clicking outside
        document.addEventListener('click', function(e) {
            // Bug popup
            const bugPopup = document.getElementById('bug-popup-overlay');
            if (bugPopup && e.target === bugPopup) {
                closeBugPopup();
            }
            
            // Bug ticket popup
            const bugTicketPopup = document.getElementById('bug-ticket-popup-overlay');
            const bugSentContent = document.getElementById('bug-ticket-sent-content');
            if (bugTicketPopup && e.target === bugTicketPopup && bugSentContent.style.display === 'none') {
                closeBugTicketPopup();
            }
            
            // Game suggestion popup
            const gameSuggestionPopup = document.getElementById('game-suggestion-popup-overlay');
            const gameSuggestionSentContent = document.getElementById('game-suggestion-sent-content');
            if (gameSuggestionPopup && e.target === gameSuggestionPopup && gameSuggestionSentContent.style.display === 'none') {
                closeGameSuggestionPopup();
            }
            
            // FAQ popup
            const faqPopup = document.getElementById('faq-popup-overlay');
            if (faqPopup && e.target === faqPopup) {
                closeFAQPopupAndReturnToHelp();
            }
            
            // Ticket popup
            const ticketPopup = document.getElementById('ticket-popup-overlay');
            const sentContent = document.getElementById('ticket-sent-content');
            if (ticketPopup && e.target === ticketPopup && sentContent.style.display === 'none') {
                closeTicketPopup();
            }
        });
        
        // Authentication check and user display
        async function checkAuthAndLoadUser() {
            try {
                const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
                const { getFirestore, collection, query, where, getDocs, setDoc, doc } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { app } = await import('./firebase.js');
                const auth = getAuth(app);
                const db = getFirestore(app);
                
                onAuthStateChanged(auth, async (user) => {
                  if (user) {
                    try {
                      const usersRef = collection(db, "users");
                      const snap = await getDocs(query(usersRef, where("email", "==", user.email)));
                
                      if (!snap.empty) {
                        // Profile exists → continue as before
                        currentUser = user;
                        const userData = snap.docs[0].data();
                        const username = userData.username || 'User';
                        const profileLabel = document.getElementById('profile-label');
                        const profileIcon = document.getElementById('profile-icon');
                        if (profileLabel) profileLabel.textContent = username;
                        if (profileIcon) {
                          profileIcon.setAttribute('data-initial', username[0].toUpperCase());
                          profileIcon.textContent = '';
                        }
                        await loadThemeFromFirebase(user);
                        
                        // Process any pending game data/time
                        await processPendingData();
                        // Check for onboarding after user is loaded
                        setTimeout(() => {
                            checkAndStartOnboarding();
                        }, 1000);
                        return;
                      }
                
                      // NEW: no profile doc yet
                      if (!user.emailVerified) {
                        // Gently block if they’re still unverified
                        console.warn('User is not verified yet.');
                        // Show a UI prompt to verify / resend if you have one
                        return;
                      }
                
                      // NEW: finish registration now that they’re verified
                      // Prefer saved sign-up data, otherwise fall back to an email-based username.
                      const pending = JSON.parse(localStorage.getItem('pendingUserData') || '{}');
                      const username =
                        (pending && pending.username) || user.email.split('@')[0];
                      const userId = generateRandomId(12); // or your existing generator
                
                      await setDoc(doc(db, "users", user.uid), {
                        email: user.email,
                        username,
                        userId,
                        createdAt: Date.now(),
                        following: [],
                        followers: [],
                        firstONEhundred: false,
                        gameTime: {},
                        gameData: {}
                      });

                      // Clear pending data so we don’t duplicate work
                      localStorage.removeItem('pendingUserData');

                      // Continue with your normal "profile exists" path
                      currentUser = user;
                      const profileLabel = document.getElementById('profile-label');
                      const profileIcon = document.getElementById('profile-icon');
                      if (profileLabel) profileLabel.textContent = username;
                      if (profileIcon) {
                        profileIcon.setAttribute('data-initial', username[0].toUpperCase());
                        profileIcon.textContent = '';
                      }
                      await loadThemeFromFirebase(user);
                      
                      // Process any pending game data/time
                      await processPendingData();
                      // Check for onboarding after user is loaded
                      setTimeout(() => {
                          checkAndStartOnboarding();
                      }, 1000);
                
                    } catch (error) {
                      console.error('Error during post-verify setup:', error);
                      // Optional: show UI notice to retry, or log out & prompt sign-in again
                    }
                  } else {
                    currentUser = null;
                    window.location.href = 'index.html';
                  }
                });
                
                // Helper: simple ID generator (or reuse your existing one)
                function generateRandomId(len = 12) {
                  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                  let out = '';
                  for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
                  return out;
                }

            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'index.html';
            }
        }
        
        // Theme toggle logic with Firebase saving
        const themeToggle = document.getElementById('theme-toggle');
        let currentUser = null;
        
        // Game time tracking
        let gameStartTime = null;
        let currentGameName = null;
        
        // Game data storage
        let currentGameData = null;
        let gameDataAutoSaveInterval = null;
        
        // Game data storage functions
        async function saveGameData(gameName, gameData) {
            if (!currentUser) {
                console.log('No user logged in, cannot save game data');
                return;
            }
            
            try {
                const { doc, updateDoc, setDoc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { db } = await import('./firebase.js');
                
                const userRef = doc(db, 'users', currentUser.uid);
                const gameKey = gameName.replace(/[^a-zA-Z0-9]/g, '_');
                
                // Get current user document
                const userDoc = await getDoc(userRef);
                const userData = userDoc.data();
                
                if (!userData) {
                    console.error('User document not found for UID:', currentUser.uid);
                    return;
                }
                
                // Initialize gameData field if it doesn't exist
                if (!userData.gameData) {
                    console.log('Initializing gameData field for user:', currentUser.uid);
                    await setDoc(userRef, { gameData: {} }, { merge: true });
                }
                
                // Save the game data
                await updateDoc(userRef, {
                    [`gameData.${gameKey}`]: {
                        data: gameData,
                        lastSaved: Date.now(),
                        gameName: gameName
                    }
                });
                
                console.log(`Successfully saved game data for: ${gameName} (key: ${gameKey})`);
            } catch (error) {
                console.error('Failed to save game data:', error);
                console.error('Error details:', error.message);
            }
        }
        
        async function loadGameData(gameName) {
            if (!currentUser) {
                console.log('No user logged in, cannot load game data');
                return null;
            }
            
            try {
                const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { db } = await import('./firebase.js');
                
                const userRef = doc(db, 'users', currentUser.uid);
                const gameKey = gameName.replace(/[^a-zA-Z0-9]/g, '_');
                
                const userDoc = await getDoc(userRef);
                const userData = userDoc.data();
                
                if (!userData || !userData.gameData || !userData.gameData[gameKey]) {
                    console.log(`No saved data found for game: ${gameName}`);
                    return null;
                }
                
                const gameData = userData.gameData[gameKey];
                console.log(`Successfully loaded game data for: ${gameName}`);
                return gameData.data;
            } catch (error) {
                console.error('Failed to load game data:', error);
                console.error('Error details:', error.message);
                return null;
            }
        }
        
        // Function to capture game data from localStorage and cookies
        function captureGameData(gameName) {
            const gameData = {
                localStorage: {},
                sessionStorage: {},
                cookies: document.cookie,
                timestamp: Date.now()
            };
            
            // Capture localStorage data (filter for game-related keys)
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.toLowerCase().includes(gameName.toLowerCase()) || 
                           key.toLowerCase().includes('game') ||
                           key.toLowerCase().includes('save') ||
                           key.toLowerCase().includes('progress') ||
                           key.toLowerCase().includes('score') ||
                           key.toLowerCase().includes('level') ||
                           key.toLowerCase().includes('player'))) {
                    gameData.localStorage[key] = localStorage.getItem(key);
                }
            }
            
            // Capture sessionStorage data (filter for game-related keys)
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                if (key && (key.toLowerCase().includes(gameName.toLowerCase()) || 
                           key.toLowerCase().includes('game') ||
                           key.toLowerCase().includes('save') ||
                           key.toLowerCase().includes('progress') ||
                           key.toLowerCase().includes('score') ||
                           key.toLowerCase().includes('level') ||
                           key.toLowerCase().includes('player'))) {
                    gameData.sessionStorage[key] = sessionStorage.getItem(key);
                }
            }
            
            console.log(`Captured game data for ${gameName}:`, gameData);
            return gameData;
        }
        
        // Function to restore game data to localStorage and cookies
        function restoreGameData(gameData) {
            if (!gameData) {
                console.log('No game data to restore');
                return;
            }
            
            try {
                // Restore localStorage data
                if (gameData.localStorage) {
                    Object.entries(gameData.localStorage).forEach(([key, value]) => {
                        localStorage.setItem(key, value);
                    });
                }
                
                // Restore sessionStorage data
                if (gameData.sessionStorage) {
                    Object.entries(gameData.sessionStorage).forEach(([key, value]) => {
                        sessionStorage.setItem(key, value);
                    });
                }
                
                // Restore cookies (note: this has limitations due to browser security)
                if (gameData.cookies) {
                    // Note: Setting cookies from JavaScript is limited by browser security policies
                    // This will only work for cookies that can be set from the current domain
                    console.log('Attempting to restore cookies:', gameData.cookies);
                }
                
                console.log('Game data restored successfully');
            } catch (error) {
                console.error('Failed to restore game data:', error);
            }
        }
        
        async function startGameTimeTracking(gameName) {
            currentGameName = gameName;
            gameStartTime = Date.now();
            console.log('Started tracking time for game:', gameName);
            
            // Start auto-save for game data every 30 seconds
            if (gameDataAutoSaveInterval) {
                clearInterval(gameDataAutoSaveInterval);
            }
            
            gameDataAutoSaveInterval = setInterval(async () => {
                if (currentGame && currentGame.name === gameName) {
                    console.log(`Auto-saving game data for: ${gameName}`);
                    const gameData = captureGameData(gameName);
                    await saveGameData(gameName, gameData);
                }
            }, 30000); // Auto-save every 30 seconds
        }
        
        // Separate function to save game time
        async function saveGameTime(gameName, timeSpentSeconds) {
            if (!currentUser || !gameName || timeSpentSeconds <= 0) {
                return;
            }
            
            try {
                const { doc, updateDoc, increment, setDoc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { db } = await import('./firebase.js');
                
                const userRef = doc(db, 'users', currentUser.uid);
                const gameKey = gameName.replace(/[^a-zA-Z0-9]/g, '_');
                
                // Get current user document to check if gameTime field exists
                const userDoc = await getDoc(userRef);
                const userData = userDoc.data();
                
                if (!userData) {
                    console.error('User document not found for UID:', currentUser.uid);
                    return;
                }
                
                if (!userData.gameTime) {
                    // Initialize gameTime field if it doesn't exist
                    console.log('Initializing gameTime field for user:', currentUser.uid);
                    await setDoc(userRef, { gameTime: {} }, { merge: true });
                }
                
                // Increment the specific game time
                await updateDoc(userRef, {
                    [`gameTime.${gameKey}`]: increment(timeSpentSeconds)
                });
                
                console.log(`Successfully tracked ${timeSpentSeconds} seconds for game: ${gameName} (key: ${gameKey}) in user document: ${currentUser.uid}`);
            } catch (error) {
                console.error('Failed to track game time:', error);
                console.error('Error details:', error.message);
            }
        }
        
        async function stopGameTimeTracking() {
            if (!gameStartTime || !currentGameName || !currentUser) {
                console.log('Game time tracking stopped - missing data:', { gameStartTime: !!gameStartTime, currentGameName, currentUser: !!currentUser });
                return;
            }
            
            const timeSpent = Date.now() - gameStartTime;
            const timeSpentSeconds = Math.round(timeSpent / 1000); // Convert to seconds
            
            console.log(`Game time tracking: ${timeSpentSeconds} seconds for ${currentGameName}`);
            
            if (timeSpentSeconds > 0) { // Only track if at least 1 second was spent
                await saveGameTime(currentGameName, timeSpentSeconds);
            }
            
            // Clear auto-save interval
            if (gameDataAutoSaveInterval) {
                clearInterval(gameDataAutoSaveInterval);
                gameDataAutoSaveInterval = null;
            }
            
            // Reset tracking
            gameStartTime = null;
            currentGameName = null;
        }
        
        // Profile dropdown functionality
        function setupProfileDropdown() {
            const profileIcon = document.getElementById('profile-icon');
            const profileDropdown = document.getElementById('profile-dropdown');
            const logoutBtn = document.getElementById('logout-btn');
            const changeUsernameBtn = document.getElementById('change-username-btn');
            
            // Toggle dropdown on profile icon click
            profileIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.style.display = profileDropdown.style.display === 'block' ? 'none' : 'block';
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!profileIcon.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.style.display = 'none';
                }
            });
            
            // Change username functionality
            changeUsernameBtn.addEventListener('click', () => {
                profileDropdown.style.display = 'none'; // Close dropdown
                showUsernameChange();
            });
            
            // Logout functionality
            logoutBtn.addEventListener('click', async () => {
                try {
                    // Stop any active game time tracking before logout
                    await stopGameTimeTracking();
                    
                    const { auth } = await import('./firebase.js');
                    const { signOut } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
                    
                    await signOut(auth);
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Logout failed:', error);
                    // Still redirect even if logout fails
                    window.location.href = 'index.html';
                }
            });
        }
        
        async function setTheme(theme, saveToFirebase = true) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('hubble-theme', theme);
            themeToggle.textContent = theme === 'light' ? '🌙' : '☀️';
            
            // Save to Firebase if user is authenticated
            if (saveToFirebase && currentUser) {
                try {
                    const { getFirestore, collection, query, where, getDocs, updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                    const { app } = await import('./firebase.js');
                    const db = getFirestore(app);
                    
                    const userQuery = query(collection(db, "users"), where("email", "==", currentUser.email));
                    const userDocs = await getDocs(userQuery);
                    
                    if (!userDocs.empty) {
                        const userDocRef = doc(db, "users", userDocs.docs[0].id);
                        await updateDoc(userDocRef, { theme: theme });
                        console.log('Theme saved to Firebase:', theme);
                    }
                } catch (error) {
                    console.error('Error saving theme to Firebase:', error);
                }
            }
        }
        
        async function loadThemeFromFirebase(user) {
            try {
                const { getFirestore, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { app } = await import('./firebase.js');
                const db = getFirestore(app);
                
                const userQuery = query(collection(db, "users"), where("email", "==", user.email));
                const userDocs = await getDocs(userQuery);
                
                if (!userDocs.empty) {
                    const userData = userDocs.docs[0].data();
                    const savedTheme = userData.theme || 'light'; // Default to light
                    setTheme(savedTheme, false); // Don't save back to Firebase when loading
                    return savedTheme;
                }
            } catch (error) {
                console.error('Error loading theme from Firebase:', error);
            }
            
            // Fallback to localStorage or default
            const localTheme = localStorage.getItem('hubble-theme') || 'light';
            setTheme(localTheme, false);
            return localTheme;
        }
        
        themeToggle.onclick = () => {
            const current = document.body.getAttribute('data-theme');
            setTheme(current === 'light' ? 'dark' : 'light');
        };

        // Games System
        const gamesList = [
            { name: "Doodle Jump", image: "images/Doodle-Jump.png", url: "./games/Doodle_jump.html" },
            { name: "Getting Over It", image: "images/Getting-Over-It.png", url: "./games/gettingoverit.html" },
            { name: "Retro Bowl", image: "images/Retro-Bowl.png", url: "./games/retro-bowl/" },
            { name: "Slope", image: "images/Slope.png", url: "./games/slope.html" },
            { name: "Snow Rider 3D", image: "images/Snow-Rider-3d.png", url: "./games/Snow Rider 3D.html" },
            { name: "Tetris", image: "images/Tetris.png", url: "./games/Tetris.html" },
            { name: "Appel",image: "images/Appel.png", url: "./games/Appel.html"},
            { name: "Arena", image: "images/Arena.png", url: "./games/Arena.html" },
            { name: "Space Huggers", image: "images/Space-Huggers.png", url: "./games/spacehuggers.html" },
            { name: "Stack", image: "images/Stack.png", url: "./games/stack.html" },
            { name: "Suika Watermelon", image: "images/Suika-Watermelon.png", url: "./games/Suika-watermelon.html" },
            { name: "60 Seconds Burger Run", image: "images/60-Seconds-Burger-Run.png", url: "./games/60second_burger_run.html" },
            { name: "Eaglercraft", image: "images/Eaglercraft.png", url: "./games/eaglercraft.1.8.8.html" },
            { name: "1v1.LOL", image: "images/1v1-lol.png", url: "./games/1v1.lol/index.html" },
            { name: "Ball Blast", image: "images/Ball-Blast.png", url: "./games/ball-blast.html" },
            { name: "Multiplayer Appel", image: "images/Appel-Multiplayer.png", comingSoon: true },
            { name: "2048", image: "images/2048.png", url: "./games/2048.html" },
            { name: "Volcanic Appel", image: "images/Volcanic-Appel.png", url: "./games/Volcanic-Appel.html" },
            { name: "Agar.io", image: "images/agario.png", url: "./games/agario.html" },
            { name: "Basketball Stars", image: "images/Basketball-Stars.png", url: "./games/basketball-stars/" },
            { name: "1", image: "images/1.png", url: "./games/1/" },
            { name: "2048 Multitask", image: "images/2048-Multitask.png", comingSoon: true },
            { name: "Angry Birds", image: "images/Angry-Birds.png", url: "./games/angry-birds/" },
            { name: "Among Us", image: "images/Among-Us.png", url: "./games/among-us/" },
            { name: "The Binding Of Issac", image: "images/The-Binding-Of-Isaac.png", url: "./games/binding-of-isaac/" },
            { name: "Cookie Clicker", image: "images/Cookie-Clicker.png", url: "./games/cookieclicker/" },
            { name: "Chrome Dino", image: "images/Chrome-Dino.png", url: "./games/chrome-dino/" },
            { name: "Duck Life", image: "images/Duck-Life.png", url: "./games/ducklife/" },
            { name: "Duck Life 2", image: "images/Duck-Life-2.png", url: "./games/ducklife2/" },
            { name: "Duck Life 3", image: "images/Duck-Life-3.png", url: "./games/ducklife3/" },
            { name: "Duck Life 4", image: "images/Duck-Life-4.png", url: "./games/ducklife4/" },
            { name: "Duck Life Treasure Hunt", image: "images/Duck-Life-Treasure-Hunt.png", url: "./games/duck-life-treasurehunt/" },
            { name: "Bitlife", image: "images/Bitlife.png", url: "./games/bitlife/" },
            { name: "Geometry Dash", image: "images/Geometry-Dash.png", url: "./games/geometrydash/" },
            { name: "Core Ball", image: "images/coreball.png", url: "./games/core-ball/" },
            { name: "Bloons TD", image: "images/Bloonstd.png", url: "./games/bloonstd/" },
            { name: "Bloons TD 2", image: "images/Bloonstd2.png", url: "./games/bloonstd2/" },
            { name: "Friday Night Funkin", image: "images/Friday-Night-Funkin.png", url: "./games/friday-night-funkin/" },
            { name: "Getaway Shootout", image: "images/Getaway-Shootout.png", url: "./games/getaway-shootout/" },
            { name: "Subway Surfers", image: "images/Subway-Surfers.png", url: "./games/subway-surfers/" },
            { name: "Tiny Fishing", image: "images/Tiny-Fishing.png", url: "./games/tiny-fishing/" },
            { name: "Stickman Hook", image: "images/Stickman-Hook.png", url: "./games/stickman-hook/" },
            { name: "Idle Breakout", image: "images/Idle-Breakout.png", url: "./games/idle-breakout/" },
            { name: "Learn To Fly", image: "images/Learn-To-Fly.png", url: "./games/flash/?game=learn-to-fly" },
            { name: "Learn To Fly 2", image: "images/Learn-To-Fly-2.png", url: "./games/flash/?game=learn-to-fly-2" },
            { name: "Learn To Fly 3", image: "images/Learn-To-Fly-3.png", url: "./games/flash/?game=learn-to-fly-3" },
            { name: "Learn To Fly Idle", image: "images/Learn-To-Fly-Idle.png", url: "./games/flash/?game=learn-to-fly-idle" },
            { name: "Gun Mayhem", image: "images/Gun-Mayhem.png", url: "./games/flash/?game=gun-mayhem" },
            { name: "Gun Mayhem 2", image: "images/Gun-Mayhem-2.png", url: "./games/flash/?game=gun-mayhem-2" },
            { name: "Gun Spin", image: "images/Gunspin.png", url: "./games/gunspin/" },
            { name: "Google Snake", image: "images/Google-Snake.png", url: "./games/google-snake/" },
            { name: "Doge Miner", image: "images/Doge-miner.png", url: "./games/DogeMiner/" },
            { name: "Doge Miner 2", image: "images/Doge-Miner-2.png", url: "./games/doge-miner-2/" },
            { name: "Crossy Road", image: "images/Crossy-Road.png", url: "./games/crossyroad/" },
            { name: "Cluster Rush", image: "images/Cluster-Rush.png", url: "./games/cluster-rush/" },
            { name: "Craftmine", image: "images/Craftmine.png", url: "./games/craftmine/" },
            { name: "Volley Random", image: "images/Volley-Random.png", url: "./games/volley-random/" },
            { name: "Basket Random", image: "images/Basket-Random.png", url: "./games/basket-random/" },
            { name: "Soccer Random", image: "images/Soccer-Random.png", url: "./games/soccer-random/" },
            { name: "Drift Boss", image: "images/Drift-Boss.png", url: "./games/drift-boss/" },
            { name: "Drive Mad", image: "images/Drive-Mad.png", url: "./games/drive-mad/" },
            { name: "Monkey Mart", image: "images/Monkey-Mart.png", url: "./games/monkey-mart/" },
            { name: "Gons.io", image: "images/Gons-io.png", url: "./games/gons-io/" },
            { name: "Rooftop Snipers", image: "images/Rooftop-Snipers.png", url: "./games/rooftop-snipers/" },
            { name: "A Game Inside", image: "images/A-Game-Inside.png", url: "./games/game-inside/" },
            { name: "Tanuki Sunset", image: "images/Tanuki-Sunset.png", url: "./games/tanuki-sunset/" },
            { name: "Blumgi Ball", image: "images/Blumgi-Ball.png", url: "./games/blumgi-ball/" },
            { name: "PolyTrack", image: "images/Polytrack.png", url: "./games/polytrack/" },
            { name: "Iron Snout", image: "images/iron-snout.png", url: "https://betterbull.com/uploads/5/5/6/7/5567194/custom_themes/811766381464516446/files/index.html" },
            { name: "Bacon May Die", image: "images/Bacon-May-Die.png", url: "https://betterbull.com/uploads/5/5/6/7/5567194/custom_themes/320690105873469650/files/index.html" },
            { name: "N-gon", image: "images/n-gon.png", url: "./games/n-gon/" },
            { name: "Vex 3", image: "images/vex-3.png", url: "./games/vex-3/" },
            { name: "Vex 4", image: "images/Vex-4.png", url: "./games/vex-4/" },
            { name: "Vex 5", image: "images/vex-5.png", url: "./games/vex-5/" },
            { name: "Vex 6", image: "images/Vex-6.png", url: "./games/vex-6/" },
            { name: "Vex 7", image: "images/vex-7.png", url: "./games/vex-7/" },
            { name: "Motox3m", image: "images/Motox3m.png", url: "./games/motox3m/" },        
            { name: "Flappy Bird", image: "images/flappy-Bird.png", url: "./games/flappy-bird/" },
            { name: "Backrooms", image: "images/Backrooms.png", url: "./games/backrooms/" },
            { name: "Geometry Dash Remastered", image: "images/geometry-Dash-Remastered.png", url: "./games/geometry-dash-remastered/", comingSoon: true },
            { name: "Burrito Bison", image: "images/burrito-Bison.png", url: "./games/burrito-bison/" },
            { name: "Cut The Rope ", image: "images/Cut-The-Rope.png", url: "./games/cut-the-rope/" },
            { name: "Cannon Basketball 4", image: "images/Cannon-Basketball.png", url: "./games/cannon-basketball-4/" },
            { name: "Doge Mining Simulator", image: "images/Doge-Mining-Simulator.png", url: "./games/doge-mining-simulator/" },
            { name: "Basket.io", image: "images/Basketball-io.png", url: "./games/basketball-io/" },
            { name: "Baldis Basics", image: "images/Baldis-Basics.png", url: "./games/baldis-basics/"  },
            { name: "Car Simulator", image: "images/Cars-Simulator.png", url: "./games/cars-simulator/"  },
            { name: "Racer", image: "images/racer.png", url: "./games/racer/"  },
            { name: "Bloxorz", image: "images/Bloxorz.png", url: "./games/bloxors/"  },
            { name: "Boxel Rebound", image: "images/Boxel-Rebound.png", url: "./games/boxel-rebound/"  },
            { name: "Gravity Soccer", image: "images/gravity-soccer.png", url: "./games/gravity-soccer/"  },
            { name: "Justfall", image: "images/Justfall.png", url: "./games/justfall/"  },
            { name: "Eggy Car", image: "images/Eggy-Car.png", url: "./games/eggy-car/"  },
            { name: "Particle Clicker", image: "images/Particle-Clicker.png", url: "./games/particleclicker/"  },
            { name: "Escape Road", image: "images/Escape-Road.png", url: "./games/escape-road/"  },
            { name: "Escape Road 2", image: "images/Escape-Road-2.png", url: "./games/escape-road-2/"  },
            { name: "Escape Road City", image: "images/Escape-Road-City.png", url: "./games/escape-road-city/" },
            { name: "Escape Road City 2",  image: "images/Escape-Road-City-2.png", url: "./games/escape-road-city-2/" },
            { name: "Wordle", image: "images/Wordle.png", url: "./games/wordle/"  },
            { name: "Yohoho", image: "images/Yohoho.png", url: "./games/yohoho/"  },
            { name: "Gladihoppers", image: "images/Gladihoppers.png", url: "./games/gladihoppers/" },
            { name: "Quiz 60", image: "images/Quiz-60.png", url: "https://quiz-60.github.io/" },
            { name: "Quiz 70", image: "images/Quiz-70.png", url: "https://quiz-70.github.io/" },
            { name: "Slow Roads", image: "images/Slow-Roads.png", url: "./games/slow-roads/" },
            { name: "Astrotype", image: "images/Astrotype.png", url: "./games/astrotype.html" },
            { name: "Planet clicker", image: "images/Planet-Clicker.png", url: "./games/planet-clicker.html" },
            { name: "Slope 2", image: "images/Slope-2.png", url: "./games/slope-2/" },
            { name: "Slope 3", image: "images/Slope-3.png", url: "./games/slope-3/" },
            { name: "Blumgi Rocket", image: "images/Blumgi-Rocket.png", url: "./games/blumgi-rocket/index.html" },
            { name: "1 On 1 Soccer", image: "images/1-On-1-Soccer.png", url: "./games/1on1soccer/game.html" },
            { name: "Blumgi Slime", image: "images/Blumgi-Slime.png", url: "./games/blumgi-slime/index.html" },
        ];
        
        let allGames = [];
        let currentGame = null;
        
        function initGamesSection() {
            // Initialize allGames here to avoid initialization order issues
            allGames = [...gamesList];
            console.log('Initializing games section with', allGames.length, 'games');
            
            // Update search placeholder with game count
            const searchInput = document.getElementById('games-search');
            if (searchInput) {
                searchInput.placeholder = `Search through our ${allGames.length} games...`;
            }
            
            // Add a delay to ensure DOM is ready
            setTimeout(() => {
                console.log('Populating games grid...');
                populateGamesGrid();
                setupGamesSearch();
            }, 200);
        }
        
        // Function to generate game name abbreviation
        function generateGameAbbreviation(gameName) {
            const words = gameName.split(' ').filter(word => word.length > 0);
            
            // Take first character of each word, limit to 4 characters max
            const abbreviation = words
                .slice(0, 4) // Limit to first 4 words
                .map(word => word[0]) // Get first character of each word
                .join('')
                .toUpperCase();
            
            return abbreviation;
        }
        
        // Function to get random color for placeholder
        function getRandomPlaceholderColor() {
            const colors = [
                { primary: '#FF6384', secondary: '#FF8FA3' }, // Pink
                { primary: '#36A2EB', secondary: '#5BB3F0' }, // Blue
                { primary: '#FFCE56', secondary: '#FFD675' }, // Yellow
                { primary: '#4BC0C0', secondary: '#6BCACA' }, // Teal
                { primary: '#9966FF', secondary: '#AD7AFF' }, // Purple
                { primary: '#FF9F40', secondary: '#FFB366' }, // Orange
                { primary: '#C7C7C7', secondary: '#D4D4D4' }, // Gray
                { primary: '#5366FF', secondary: '#6B7AFF' }, // Indigo
                { primary: '#FF6B6B', secondary: '#FF8A8A' }, // Red
                { primary: '#4ECDC4', secondary: '#6DD5CE' }, // Mint
                { primary: '#45B7D1', secondary: '#6BC5D8' }, // Sky Blue
                { primary: '#96CEB4', secondary: '#A8D5C1' }, // Green
                { primary: '#FFEAA7', secondary: '#FFEDB8' }, // Light Yellow
                { primary: '#DDA0DD', secondary: '#E4B3E4' }, // Plum
                { primary: '#98D8C8', secondary: '#A8DFD1' }  // Aqua
            ];
            
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        function populateGamesGrid() {
            const gamesGrid = document.getElementById('games-grid');
            
            if (!gamesGrid) {
                console.error('Games grid element not found');
                return;
            }
            
            if (allGames.length === 0) {
                console.log('No games to display');
                gamesGrid.innerHTML = '<div class="games-loading">No games found</div>';
                return;
            }
            
            console.log('Populating grid with', allGames.length, 'games');
            
            // Check if games have scores (from search) or sort alphabetically
            let sortedGames;
            if (allGames[0] && allGames[0].hasOwnProperty('score')) {
                // Games are already sorted by score from search
                sortedGames = allGames;
            } else {
                // Sort games alphabetically for default view
                sortedGames = [...allGames].sort((a, b) => a.name.localeCompare(b.name));
            }
            
            const gamesHTML = sortedGames.map((game, index) => {
                const abbreviation = generateGameAbbreviation(game.name);
                const colorScheme = getRandomPlaceholderColor();
                
                // Determine CSS classes and click behavior
                let cssClasses = 'game-card';
                let clickHandler = `onclick="openGame('${game.name}', '${game.url}')"`;
                
                if (game.comingSoon) {
                    cssClasses += ' coming-soon';
                    clickHandler = ''; // No click handler for coming soon games
                }
                
                return `
                <div class="${cssClasses}" ${clickHandler}>
                    <img src="${game.image}" alt="${game.name}" class="game-image" loading="lazy" 
                         onerror="showGamePlaceholder(this, '${abbreviation}', '${colorScheme.primary}', '${colorScheme.secondary}')">
                    <h3 class="game-name">${game.name}</h3>
                </div>
                `;
            }).join('');
            
            console.log('Generated HTML for first game:', sortedGames[0] ? sortedGames[0].name : 'none');
            console.log('First game image path:', sortedGames[0] ? sortedGames[0].image : 'none');
            
            gamesGrid.innerHTML = gamesHTML;
        }
        
        // Function to show placeholder when image fails to load
        function showGamePlaceholder(imgElement, abbreviation, primaryColor, secondaryColor) {
            console.log('showGamePlaceholder called with:', { abbreviation, primaryColor, secondaryColor });
            
            const gameCard = imgElement.closest('.game-card');
            if (!gameCard) {
                console.error('Could not find game card for image element');
                return;
            }
            
            // Create placeholder element
            const placeholder = document.createElement('div');
            placeholder.className = 'game-image-placeholder';
            placeholder.style.setProperty('--placeholder-bg', primaryColor);
            placeholder.style.setProperty('--placeholder-bg-secondary', secondaryColor);
            
            const textElement = document.createElement('div');
            textElement.className = 'placeholder-text';
            textElement.textContent = abbreviation;
            placeholder.appendChild(textElement);
            
            // Replace the image with placeholder
            imgElement.parentNode.replaceChild(placeholder, imgElement);
            
            console.log(`Successfully showing placeholder for game with abbreviation: ${abbreviation}`);
        }
        
        
        function setupGamesSearch() {
            const searchInput = document.getElementById('games-search');
            if (!searchInput) return;
            
            // Add focus/blur event listeners for animation control
            searchInput.addEventListener('focus', function() {
                this.classList.add('paused');
            });
            
            searchInput.addEventListener('blur', function() {
                this.classList.remove('paused');
            });
            
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                
                if (!searchTerm) {
                    // Reset to original games list without scores
                    allGames = [...gamesList];
                } else {
                    // Advanced relevance scoring
                    allGames = gamesList.filter(game => 
                        game.name.toLowerCase().includes(searchTerm)
                    ).map(game => {
                        const gameName = game.name.toLowerCase();
                        let score = 0;
                        
                        // Exact match gets highest score
                        if (gameName === searchTerm) {
                            score = 10000;
                        }
                        // Starts with search term gets very high score
                        else if (gameName.startsWith(searchTerm)) {
                            score = 8000 + (100 - searchTerm.length); // Shorter searches get higher priority
                        }
                        // Word boundary matches (space or dash before the term) get high score
                        else if (gameName.includes(' ' + searchTerm) || gameName.includes('-' + searchTerm)) {
                            score = 6000;
                        }
                        // Word boundary matches (space or dash after the term) get high score
                        else if (gameName.includes(searchTerm + ' ') || gameName.includes(searchTerm + '-')) {
                            score = 5000;
                        }
                        // Contains search term as whole word (surrounded by spaces/dashes/start/end)
                        else if (new RegExp('\\b' + searchTerm + '\\b').test(gameName)) {
                            score = 4000;
                        }
                        // Contains search term gets medium score
                        else if (gameName.includes(searchTerm)) {
                            // Earlier in the name = higher score
                            const position = gameName.indexOf(searchTerm);
                            score = 2000 - position;
                        }
                        
                        // Bonus for shorter names (more specific)
                        score += Math.max(0, 100 - game.name.length);
                        
                        // Additional bonus for games that start with the same letter as search term
                        if (gameName.charAt(0) === searchTerm.charAt(0)) {
                            score += 50;
                        }
                        
                        return { ...game, score };
                    }).sort((a, b) => {
                        // Sort by score first (descending), then alphabetically
                        if (b.score !== a.score) return b.score - a.score;
                        return a.name.localeCompare(b.name);
                    });
                }
                
                populateGamesGrid();
            });
        }
        
        async function openGame(gameName, gameUrl) {
            currentGame = { name: gameName, url: gameUrl };
            
            // Load saved game data before starting the game
            console.log(`Loading saved data for game: ${gameName}`);
            const savedGameData = await loadGameData(gameName);
            if (savedGameData) {
                restoreGameData(savedGameData);
            }
            
            // Start tracking time for this game
            startGameTimeTracking(gameName);
            
            const gameFullscreen = document.getElementById('game-fullscreen');
            const gameContent = document.getElementById('game-content');
            
            if (!gameFullscreen || !gameContent) {
                console.error('Game fullscreen elements not found');
                return;
            }
            
            gameContent.src = gameUrl;
            gameFullscreen.style.display = 'flex';
            
            // Modify header for game mode
            enterGameMode(gameName);
        }
        
        function enterGameMode(gameName) {
            const topbar = document.querySelector('.topbar');
            const hubbleTitle = document.querySelector('.hubble-gradient');
            const progressBar = document.getElementById('registration-progress-bar');
            const alphaBadge = document.getElementById('alpha-badge');
            
            // Add game mode class
            topbar.classList.add('game-mode');
            
            // Store original content
            if (!topbar.dataset.originalTitle) {
                topbar.dataset.originalTitle = hubbleTitle.innerHTML;
            }
            
            // Change title to game name
            hubbleTitle.innerHTML = gameName;
            
            // Hide progress bar and alpha badge, create game controls in header
            if (progressBar) {
                progressBar.style.display = 'none';
                createGameControlsInHeader();
            }
            if (alphaBadge) {
                alphaBadge.classList.add('hidden');
            }
        }
        
        function createGameControlsInHeader() {
            const progressBar = document.getElementById('registration-progress-bar');
            
            // Remove existing controls if any
            removeGameControlsFromHeader();
            
            // Create fullscreen button
            const fullscreenBtn = document.createElement('button');
            fullscreenBtn.id = 'game-fullscreen-btn';
            fullscreenBtn.className = 'game-fullscreen-btn';
            fullscreenBtn.textContent = 'Fullscreen';
            fullscreenBtn.onclick = toggleTabFullscreen;
            
            // Create exit button  
            const exitBtn = document.createElement('button');
            exitBtn.id = 'game-exit-btn-new';
            exitBtn.className = 'game-exit-btn';
            exitBtn.textContent = 'Exit Game';
            exitBtn.onclick = exitGame;
            
            // Create container
            const gameControls = document.createElement('div');
            gameControls.id = 'game-controls';
            gameControls.className = 'game-controls';
            gameControls.style.display = 'flex';
            gameControls.appendChild(fullscreenBtn);
            gameControls.appendChild(exitBtn);
            
            // Insert after progress bar
            progressBar.parentNode.insertBefore(gameControls, progressBar.nextSibling);
        }
        
        function removeGameControlsFromHeader() {
            const existingControls = document.getElementById('game-controls');
            if (existingControls) {
                existingControls.remove();
            }
        }
        
        let isTabFullscreen = false;
        let isTrueFullscreen = false;
        
        function toggleTrueFullscreen() {
            if (!document.fullscreenElement) {
                // Enter true fullscreen
                document.documentElement.requestFullscreen().then(() => {
                    isTrueFullscreen = true;
                    const trueFullscreenBtn = document.getElementById('game-true-fullscreen-btn');
                    if (trueFullscreenBtn) {
                        trueFullscreenBtn.textContent = 'Exit True Fullscreen';
                    }
                }).catch(err => {
                    console.error('Error entering fullscreen:', err);
                });
            } else {
                // Exit true fullscreen
                document.exitFullscreen().then(() => {
                    isTrueFullscreen = false;
                    const trueFullscreenBtn = document.getElementById('game-true-fullscreen-btn');
                    if (trueFullscreenBtn) {
                        trueFullscreenBtn.textContent = 'True Fullscreen';
                    }
                }).catch(err => {
                    console.error('Error exiting fullscreen:', err);
                });
            }
        }
        
        function toggleTabFullscreen() {
            const gameFullscreen = document.getElementById('game-fullscreen');
            const topbar = document.querySelector('.topbar');
            const fullscreenBtn = document.getElementById('game-fullscreen-btn');
            
            if (!isTabFullscreen) {
                // Enter tab fullscreen mode
                gameFullscreen.classList.add('tab-fullscreen');
                topbar.style.display = 'none';
                
                // Move back button to be positioned above the game
                fullscreenBtn.classList.add('minimized');
                fullscreenBtn.textContent = '← Back';
                
                // Create true fullscreen button and position it next to back button
                const trueFullscreenBtn = document.createElement('button');
                trueFullscreenBtn.id = 'game-true-fullscreen-btn';
                trueFullscreenBtn.className = 'game-fullscreen-btn minimized true-fullscreen';
                trueFullscreenBtn.textContent = 'True Fullscreen';
                trueFullscreenBtn.onclick = toggleTrueFullscreen;
                
                // Remove back button from header and add both buttons to game container
                fullscreenBtn.remove();
                gameFullscreen.appendChild(fullscreenBtn);
                gameFullscreen.appendChild(trueFullscreenBtn);
                
                isTabFullscreen = true;
            } else {
                // Exit true fullscreen if active
                if (isTrueFullscreen && document.fullscreenElement) {
                    document.exitFullscreen().then(() => {
                        isTrueFullscreen = false;
                    }).catch(err => {
                        console.error('Error exiting fullscreen:', err);
                    });
                }
                
                // Exit tab fullscreen mode
                gameFullscreen.classList.remove('tab-fullscreen');
                topbar.style.display = 'flex';
                fullscreenBtn.classList.remove('minimized');
                fullscreenBtn.textContent = 'Fullscreen';
                
                // Remove true fullscreen button
                const trueFullscreenBtn = document.getElementById('game-true-fullscreen-btn');
                if (trueFullscreenBtn) {
                    trueFullscreenBtn.remove();
                }
                
                // Move back button back to header
                fullscreenBtn.remove();
                const gameControls = document.getElementById('game-controls');
                if (gameControls) {
                    gameControls.insertBefore(fullscreenBtn, gameControls.firstChild);
                }
                
                isTabFullscreen = false;
            }
        }
        
        async function exitGame() {
            // Save game data before exiting
            if (currentGame && currentGame.name) {
                console.log(`Saving game data for: ${currentGame.name}`);
                const gameData = captureGameData(currentGame.name);
                await saveGameData(currentGame.name, gameData);
            }
            
            // Stop tracking time for the current game
            await stopGameTimeTracking();
            
            const gameFullscreen = document.getElementById('game-fullscreen');
            const gameContent = document.getElementById('game-content');
            const topbar = document.querySelector('.topbar');
            const hubbleTitle = document.querySelector('.hubble-gradient');
            const progressBar = document.getElementById('registration-progress-bar');
            
            // Exit true fullscreen if active
            if (isTrueFullscreen && document.fullscreenElement) {
                document.exitFullscreen().then(() => {
                    isTrueFullscreen = false;
                }).catch(err => {
                    console.error('Error exiting fullscreen:', err);
                });
            }
            
            // Exit tab fullscreen if active
            if (isTabFullscreen) {
                gameFullscreen.classList.remove('tab-fullscreen');
                topbar.style.display = 'flex';
                isTabFullscreen = false;
            }
            
            // Hide game fullscreen
            gameFullscreen.style.display = 'none';
            gameContent.src = '';
            
            // Remove game controls from header
            removeGameControlsFromHeader();
            
            // Remove true fullscreen button if it exists
            const trueFullscreenBtn = document.getElementById('game-true-fullscreen-btn');
            if (trueFullscreenBtn) {
                trueFullscreenBtn.remove();
            }
            
            // Restore header
            topbar.classList.remove('game-mode');
            hubbleTitle.innerHTML = topbar.dataset.originalTitle || 'Hubble<span class="alpha-badge" id="alpha-badge">Alpha</span>';
            
            // Restore progress bar and alpha badge
            if (progressBar) {
                progressBar.style.display = 'flex';
            }
            const alphaBadge = document.getElementById('alpha-badge');
            if (alphaBadge) {
                alphaBadge.classList.remove('hidden');
            }
            
            // Show post button again
            const postButton = document.getElementById('post-expand-toggle');
            if (postButton) {
                postButton.style.display = 'block';
            }
            
            currentGame = null;
        }
        
        function openRandomGame() {
            if (gamesList.length > 0) {
                const randomGame = gamesList[Math.floor(Math.random() * gamesList.length)];
                openGame(randomGame.name, randomGame.url);
            }
        }
        
        // Add global escape key handler for games
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && currentGame) {
                if (isTrueFullscreen && document.fullscreenElement) {
                    // Exit true fullscreen first
                    toggleTrueFullscreen();
                } else if (isTabFullscreen) {
                    // Exit tab fullscreen first
                    toggleTabFullscreen();
                } else {
                    // Exit game completely
                    exitGame();
                }
            }
        });
        
        // Listen for fullscreen changes to update button state
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement && isTrueFullscreen) {
                // User exited fullscreen via browser controls
                isTrueFullscreen = false;
                const trueFullscreenBtn = document.getElementById('game-true-fullscreen-btn');
                if (trueFullscreenBtn) {
                    trueFullscreenBtn.textContent = 'True Fullscreen';
                }
            }
        });
        
        
        // Registration Progress Bar Functions
        async function fetchRegisteredUserCount() {
            try {
                const { getFirestore, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { app } = await import('./firebase.js');
                const db = getFirestore(app);
                
                // Query users with registrationCompleted = true
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("registrationCompleted", "==", true));
                const querySnapshot = await getDocs(q);
                
                return querySnapshot.size;
            } catch (error) {
                console.error('Error fetching user count:', error);
                return 0;
            }
        }
        
        function createMilestoneMarkers() {
            // Milestones removed - no longer needed
            return;
        }
        
        // Function to update all users with firstONEhundred = true
        async function updateAllUsersFirstOneHundred() {
            try {
                const { getFirestore, collection, getDocs, updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { app } = await import('./firebase.js');
                const db = getFirestore(app);
                
                console.log('Starting batch update for firstONEhundred...');
                
                // Get all users
                const usersRef = collection(db, 'users');
                const usersSnapshot = await getDocs(usersRef);
                
                // Update each user
                const updatePromises = [];
                usersSnapshot.forEach((userDoc) => {
                    const updatePromise = updateDoc(doc(db, 'users', userDoc.id), {
                        firstONEhundred: true
                    });
                    updatePromises.push(updatePromise);
                });
                
                // Wait for all updates to complete
                await Promise.all(updatePromises);
                
                console.log(`Successfully updated ${updatePromises.length} users with firstONEhundred = true`);
                
                // Store a flag to prevent repeated updates
                localStorage.setItem('firstONEhundredUpdated', 'true');
                
            } catch (error) {
                console.error('Error updating users with firstONEhundred:', error);
            }
        }

        async function updateProgressBar() {
            try {
                const userCount = await fetchRegisteredUserCount();
                
                // Calculate progress toward 100 for the bar fill
                const maxUsers = 100;
                const percentage = Math.min((userCount / maxUsers) * 100, 100);
                
                const progressFill = document.getElementById('progress-bar-fill');
                const progressText = document.getElementById('progress-text');
                
                if (progressFill) {
                    progressFill.style.width = `${percentage}%`;
                    
                    // Add golden class when reaching 100 users
                    if (userCount >= 100) {
                        progressFill.classList.add('golden');
                        
                        // Update all users with firstONEhundred = true (only once)
                        const alreadyUpdated = localStorage.getItem('firstONEhundredUpdated');
                        if (!alreadyUpdated) {
                            await updateAllUsersFirstOneHundred();
                        }
                    } else {
                        progressFill.classList.remove('golden');
                    }
                }
                
                if (progressText) {
                    if (userCount >= 100) {
                        progressText.textContent = '100+ Users';
                    } else {
                        progressText.textContent = `${userCount} / 100 Users`;
                    }
                }
                
                console.log(`Progress bar updated: ${userCount} registered users (${percentage.toFixed(1)}% toward 100)`);
            } catch (error) {
                console.error('Error updating progress bar:', error);
                const progressText = document.getElementById('progress-text');
                if (progressText) {
                    progressText.textContent = 'Error loading data';
                }
            }
        }
        
        // Initialize progress bar
        function initProgressBar() {
            createMilestoneMarkers();
            updateProgressBar();
            
            // Update every 30 seconds
            setInterval(updateProgressBar, 30000);
        }
        
        // Onboarding Animation Functions
        async function checkAndStartOnboarding() {
            try {
                const { getFirestore, collection, query, where, getDocs, updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { app } = await import('./firebase.js');
                const db = getFirestore(app);
                
                if (!currentUser) return;
                
                // Check if user has eventReady field
                const userQuery = query(collection(db, "users"), where("email", "==", currentUser.email));
                const userDocs = await getDocs(userQuery);
                
                if (!userDocs.empty) {
                    const userData = userDocs.docs[0].data();
                    
                    // If eventReady doesn't exist, start onboarding
                    if (userData.eventReady === undefined) {
                        startOnboardingAnimation();
                    }
                }
            } catch (error) {
                console.error('Error checking onboarding status:', error);
            }
        }
        
        async function setEventReady() {
            try {
                const { getFirestore, collection, query, where, getDocs, updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { app } = await import('./firebase.js');
                const db = getFirestore(app);
                
                if (!currentUser) return;
                
                const userQuery = query(collection(db, "users"), where("email", "==", currentUser.email));
                const userDocs = await getDocs(userQuery);
                
                if (!userDocs.empty) {
                    const userDocRef = doc(db, "users", userDocs.docs[0].id);
                    await updateDoc(userDocRef, { eventReady: true });
                    console.log('Event ready status set to true');
                }
            } catch (error) {
                console.error('Error setting event ready status:', error);
            }
        }
        
        function createConfetti() {
            const confettiContainer = document.getElementById('confetti-container');
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
            
            const confetti = document.createElement('div');
            confetti.className = 'confetti-piece';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
            confetti.style.animationDelay = Math.random() * 2 + 's';
            confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
            
            confettiContainer.appendChild(confetti);
            
            // Remove confetti after animation completes
            setTimeout(() => {
                if (confetti.parentNode) {
                    confetti.parentNode.removeChild(confetti);
                }
            }, 5000);
        }
        
        function startConfetti() {
            // Create confetti every 30ms for much more confetti
            const confettiInterval = setInterval(createConfetti, 30);
            
            // Store interval ID for cleanup
            window.confettiInterval = confettiInterval;
        }
        
        function stopConfetti() {
            if (window.confettiInterval) {
                clearInterval(window.confettiInterval);
                window.confettiInterval = null;
            }
        }
        
        function startOnboardingAnimation() {
            const overlay = document.getElementById('onboarding-overlay');
            const gift = document.getElementById('onboarding-gift');
            const container = document.getElementById('onboarding-container');
            const proceedBtn = document.getElementById('onboarding-proceed-btn');
            const realProgressBar = document.getElementById('registration-progress-bar');
            
            // Hide the real progress bar initially
            if (realProgressBar) {
                realProgressBar.style.display = 'none';
            }
            
            // Show overlay and gift
            overlay.classList.add('show');
            
            // Start confetti immediately
            startConfetti();
            
            // After 2 seconds, shrink gift to center
            setTimeout(() => {
                gift.classList.add('shrinking');
                
                // After gift shrinks, show container with text
                setTimeout(() => {
                    container.classList.add('show');
                }, 1200);
            }, 2000);
            
            // Setup proceed button
            proceedBtn.addEventListener('click', () => {
                // Fade out overlay (but keep confetti running)
                overlay.classList.remove('show');
                
                // Show real progress bar
                if (realProgressBar) {
                    realProgressBar.style.display = 'flex';
                }
                
                // Stop generating new confetti
                stopConfetti();
                
                // Set eventReady in Firebase
                setEventReady();
                
                // Remove onboarding elements after fade out completes
                setTimeout(() => {
                    // Remove the entire onboarding overlay
                    if (overlay && overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                }, 800); // Wait for CSS transition to complete (0.8s)
                
                // Remove confetti container after all confetti has fallen (5 seconds + buffer)
                setTimeout(() => {
                    const confettiContainer = document.getElementById('confetti-container');
                    if (confettiContainer && confettiContainer.parentNode) {
                        confettiContainer.parentNode.removeChild(confettiContainer);
                    }
                }, 6000); // 5 seconds for confetti to fall + 1 second buffer
            });
        }
        
        // Initialize games section and auth on load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthAndLoadUser();
            initGamesSection();
            setupProfileDropdown();
            initProgressBar();
            
            // Setup bug button
            const bugButton = document.getElementById('bug-button');
            if (bugButton) {
                bugButton.addEventListener('click', showBugPopup);
            }
            
            // Setup game suggestion button
            const gameSuggestionBtn = document.getElementById('game-suggestion-btn');
            if (gameSuggestionBtn) {
                gameSuggestionBtn.addEventListener('click', showGameSuggestionPopup);
            }
        });
        
        
        // Save pending data to localStorage for recovery
        function savePendingData() {
            if (currentGame && currentGame.name && currentUser) {
                const gameData = captureGameData(currentGame.name);
                const pendingData = {
                    gameName: currentGame.name,
                    gameData: gameData,
                    userId: currentUser.uid,
                    timestamp: Date.now()
                };
                localStorage.setItem('pendingGameData', JSON.stringify(pendingData));
            }
            
            if (gameStartTime && currentGameName && currentUser) {
                const timeSpent = Date.now() - gameStartTime;
                const timeSpentSeconds = Math.round(timeSpent / 1000);
                if (timeSpentSeconds > 0) {
                    const pendingTime = {
                        gameName: currentGameName,
                        timeSpent: timeSpentSeconds,
                        userId: currentUser.uid,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('pendingGameTime', JSON.stringify(pendingTime));
                }
            }
        }
        
        // Process pending data on page load
        async function processPendingData() {
            try {
                // Process pending game data
                const pendingGameData = localStorage.getItem('pendingGameData');
                if (pendingGameData) {
                    const data = JSON.parse(pendingGameData);
                    if (data.userId === currentUser?.uid) {
                        await saveGameData(data.gameName, data.gameData);
                        localStorage.removeItem('pendingGameData');
                    }
                }
                
                // Process pending game time
                const pendingGameTime = localStorage.getItem('pendingGameTime');
                if (pendingGameTime) {
                    const data = JSON.parse(pendingGameTime);
                    if (data.userId === currentUser?.uid) {
                        await saveGameTime(data.gameName, data.timeSpent);
                        localStorage.removeItem('pendingGameTime');
                    }
                }
            } catch (error) {
                console.error('Error processing pending data:', error);
            }
        }
        
        // Track game time and save game data when page is unloaded
        window.addEventListener('beforeunload', () => {
            savePendingData();
        });
        
        window.addEventListener('pagehide', () => {
            savePendingData();
        });

        
        // Developer Tools Protection
        (function() {
            'use strict';
            
            // Disable right-click context menu (silent - no alerts)
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopImmediatePropagation();
                return false;
            }, true);
            
            // Disable inspection keyboard shortcuts (triggers alert/redirect)
            document.addEventListener('keydown', function(e) {
                // F12
                if (e.keyCode === 123 || e.key === 'F12') {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    document.documentElement.innerHTML = '<body style="background:#000;color:#ff0000;text-align:center;padding-top:40vh;font-size:24px;">ACCESS DENIED</body>';
                    setTimeout(() => window.location.href = 'about:blank', 500);
                    return false;
                }
                // Ctrl+Shift+I (Inspector)
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.keyCode === 73 || e.key === 'I')) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    document.documentElement.innerHTML = '<body style="background:#000;color:#ff0000;text-align:center;padding-top:40vh;font-size:24px;">ACCESS DENIED</body>';
                    setTimeout(() => window.location.href = 'about:blank', 500);
                    return false;
                }
                // Ctrl+Shift+J (Console)
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.keyCode === 74 || e.key === 'J')) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    document.documentElement.innerHTML = '<body style="background:#000;color:#ff0000;text-align:center;padding-top:40vh;font-size:24px;">ACCESS DENIED</body>';
                    setTimeout(() => window.location.href = 'about:blank', 500);
                    return false;
                }
                // Ctrl+Shift+C (Element Selector)
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.keyCode === 67 || e.key === 'C')) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    document.documentElement.innerHTML = '<body style="background:#000;color:#ff0000;text-align:center;padding-top:40vh;font-size:24px;">ACCESS DENIED</body>';
                    setTimeout(() => window.location.href = 'about:blank', 500);
                    return false;
                }
                // Ctrl+U (View Source)
                if ((e.ctrlKey || e.metaKey) && (e.keyCode === 85 || e.key === 'u')) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    document.documentElement.innerHTML = '<body style="background:#000;color:#ff0000;text-align:center;padding-top:40vh;font-size:24px;">ACCESS DENIED</body>';
                    setTimeout(() => window.location.href = 'about:blank', 500);
                    return false;
                }
                // Ctrl+Shift+K (Console Firefox)
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.keyCode === 75 || e.key === 'K')) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    document.documentElement.innerHTML = '<body style="background:#000;color:#ff0000;text-align:center;padding-top:40vh;font-size:24px;">ACCESS DENIED</body>';
                    setTimeout(() => window.location.href = 'about:blank', 500);
                    return false;
                }
            }, true);
            
            
            // Console detection
            let consoleDetectionCount = 0;
            let element = new Image();
            Object.defineProperty(element, 'id', {
                get: function() {
                    consoleDetectionCount++;
                    // Only trigger after multiple detections to avoid false positives
                    if (consoleDetectionCount > 3) {
                        document.documentElement.innerHTML = '<body style="background:#000;color:#ff0000;text-align:center;padding-top:40vh;font-size:24px;">ACCESS DENIED</body>';
                        setTimeout(() => window.location.href = 'about:blank', 500);
                    }
                }
            });
            
            // Less frequent console checks
            setInterval(function() {
                console.log(element);
                console.clear();
            }, 5000);
            
            // Disable text selection and copying (but allow input interaction)
            document.onselectstart = function(e) { 
                // Allow selection in input fields
                if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) {
                    return true;
                }
                return false; 
            };
            document.onmousedown = function(e) { 
                // Allow mouse down in input fields and buttons
                if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'BUTTON')) {
                    return true;
                }
                return false; 
            };
            document.ondragstart = function(e) { 
                // Allow dragging in input fields
                if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) {
                    return true;
                }
                return false; 
            };
            
        })();
        
        // Username Change Functions
        function showCustomizationError(message) {
            // Remove any existing notifications
            const existingNotifications = document.querySelectorAll('.customization-notification');
            existingNotifications.forEach(notification => notification.remove());
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'customization-notification';
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #d32f2f;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10001;
                font-weight: 600;
                animation: slideInRight 0.3s ease-out;
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }
        
        function showCustomizationSuccess(message) {
            // Remove any existing notifications
            const existingNotifications = document.querySelectorAll('.customization-notification');
            existingNotifications.forEach(notification => notification.remove());
            
            const successDiv = document.createElement('div');
            successDiv.className = 'customization-notification';
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2e7d32;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10001;
                font-weight: 600;
                animation: slideInRight 0.3s ease-out;
            `;
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }
        
        function closeCustomizationPopup() {
            const popups = document.querySelectorAll('.customization-popup');
            popups.forEach(popup => {
                // Remove show class to trigger exit animation
                popup.classList.remove('show');
                
                // Remove from DOM after animation completes
                setTimeout(() => {
                    if (popup.parentNode) {
                        popup.parentNode.removeChild(popup);
                    }
                }, 300); // Match the CSS transition duration
            });
        }
        
        async function showUsernameChange() {
            const currentUsername = document.getElementById('profile-label').textContent;
            
            // Create username change popup
            const popup = document.createElement('div');
            popup.className = 'customization-popup';
            popup.innerHTML = `
                <div class="customization-popup-bg"></div>
                <div class="customization-popup-content">
                    <h3>Change Username</h3>
                    <div class="popup-input-group">
                        <label>New Username</label>
                        <input type="text" id="new-username" value="${currentUsername}" maxlength="75" minlength="3">
                    </div>
                    <div class="popup-buttons">
                        <button class="popup-btn secondary" onclick="closeCustomizationPopup()">Cancel</button>
                        <button class="popup-btn primary" onclick="confirmUsernameChange()">Change</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
            
            // Add click handler for background to close popup
            const bg = popup.querySelector('.customization-popup-bg');
            bg.addEventListener('click', closeCustomizationPopup);
            
            // Trigger animation
            setTimeout(() => {
                popup.classList.add('show');
            }, 10);
            
            // Focus on input after animation starts
            setTimeout(() => {
                const input = document.getElementById('new-username');
                input.focus();
                input.select();
            }, 200);
        }
        
        async function confirmUsernameChange() {
            const newUsername = document.getElementById('new-username').value.trim();
            const currentUsername = document.getElementById('profile-label').textContent;
            
            if (newUsername === currentUsername) {
                showCustomizationError('New username must be different from current username.');
                return;
            }
            
            if (newUsername.length < 3 || newUsername.length > 75) {
                showCustomizationError('Username must be 3-75 characters long.');
                return;
            }
            
            // Check if username is available
            try {
                const { getFirestore, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { app } = await import('./firebase.js');
                const db = getFirestore(app);
                const q = query(collection(db, 'users'), where('username', '==', newUsername));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    showCustomizationError('That username is already taken.');
                    return;
                }
            } catch (err) {
                showCustomizationError('Could not check username availability. Try again.');
                return;
            }
            
            // Show final confirmation popup
            showFinalUsernameConfirmation(newUsername);
        }
        
        function showFinalUsernameConfirmation(newUsername) {
            const popup = document.createElement('div');
            popup.className = 'customization-popup';
            popup.innerHTML = `
                <div class="customization-popup-bg"></div>
                <div class="customization-popup-content">
                    <h3>⚠️ Final Confirmation</h3>
                    <div class="confirmation-message">
                        <p><strong>Are you absolutely sure?</strong></p>
                        <p>If you change your username to "${newUsername}", another user can claim your old username "${document.getElementById('profile-label').textContent}" and it will become unavailable.</p>
                        <p>This action cannot be undone.</p>
                    </div>
                    <div class="popup-buttons">
                        <button class="popup-btn secondary" onclick="closeCustomizationPopup()">Cancel</button>
                        <button class="popup-btn primary disabled" id="final-change-btn" onclick="executeUsernameChange('${newUsername}')">
                            <span class="timer-circle">
                                <svg class="timer-svg" viewBox="0 0 36 36">
                                    <path class="timer-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                                    <path class="timer-progress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                                </svg>
                                <span class="timer-text">3</span>
                            </span>
                            Change Username
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
            
            // Add click handler for background to close popup
            const bg = popup.querySelector('.customization-popup-bg');
            bg.addEventListener('click', closeCustomizationPopup);
            
            // Trigger animation
            setTimeout(() => {
                popup.classList.add('show');
            }, 10);
            
            // Start 3-second timer after animation
            let timeLeft = 3;
            const timerText = popup.querySelector('.timer-text');
            const timerProgress = popup.querySelector('.timer-progress');
            const finalBtn = document.getElementById('final-change-btn');
            
            const timer = setInterval(() => {
                timeLeft--;
                timerText.textContent = timeLeft;
                
                const progress = (3 - timeLeft) / 3;
                timerProgress.style.strokeDasharray = `${progress * 100} 100`;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    finalBtn.classList.remove('disabled');
                    finalBtn.disabled = false;
                    // Remove the timer circle from the button text
                    const timerCircle = finalBtn.querySelector('.timer-circle');
                    if (timerCircle) {
                        timerCircle.remove();
                    }
                }
            }, 1000);
        }
        
        async function executeUsernameChange(newUsername) {
            try {
                const { getAuth } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
                const { getFirestore, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
                const { app } = await import('./firebase.js');
                
                const auth = getAuth(app);
                const db = getFirestore(app);
                
                await updateDoc(doc(db, 'users', auth.currentUser.uid), {
                    username: newUsername
                });
                
                // Update UI
                document.getElementById('profile-label').textContent = newUsername;
                document.getElementById('profile-icon').setAttribute('data-initial', newUsername[0].toUpperCase());
                
                // Close popup with animation
                closeCustomizationPopup();
                
                // Show success message after popup starts closing
                setTimeout(() => {
                    showCustomizationSuccess('Username changed successfully!');
                }, 150);
                
            } catch (err) {
                showCustomizationError('Failed to change username. Please try again.');
                console.error('Username change error:', err);
            }
        }
    </script>
    
    <!-- Version Checker -->
    <script type="module" src="./version-check.js"></script>
    
    <!-- Watermark Component -->
    <script type="module" src="./watermark.js"></script>
</body>
</html>
